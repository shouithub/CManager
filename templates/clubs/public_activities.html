{% extends 'clubs/base.html' %}

{% block title %}活动管理 - 社团管理系统{% endblock %}

{% block extra_css %}
<style>
    .home-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: var(--md3-spacing-2xl);
        width: 100%;
        box-sizing: border-box;
        overflow-x: clip;
        overflow-y: visible;
    }
    
    /* 页面标题 */
    .page-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--md3-spacing-md);
        margin-bottom: var(--md3-spacing-xl);
    }
    
    .page-header .title-section {
        display: flex;
        align-items: center;
        gap: var(--md3-spacing-md);
        margin-left: var(--md3-spacing-lg);
        padding-top: var(--md3-spacing-sm);
    }
    
    .page-header .material-icons {
        font-size: 2.5rem;
        color: var(--md3-primary);
    }
    
    .page-header h1 {
        margin: 0;
        font-size: 2rem;
        font-weight: 600;
        color: var(--md3-on-surface);
    }

    /* 筛选和搜索区域 */
    .filters-section {
        margin-bottom: var(--md3-spacing-2xl);
    }

    .filters-card {
        background: var(--md3-surface-container);
        border-radius: var(--md3-radius-xl);
        border: 1px solid var(--md3-outline-variant);
        box-shadow: var(--md3-elevation-1);
        overflow: hidden;
    }

    .filters-header {
        padding: var(--md3-spacing-xl);
        border-bottom: 1px solid var(--md3-outline-variant);
        background: var(--md3-surface-container-high);
    }

    .filters-header h2 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--md3-on-surface);
        display: flex;
        align-items: center;
        gap: var(--md3-spacing-sm);
    }

    .filters-header .material-icons {
        color: var(--md3-primary);
        font-size: 1.5rem;
    }

    .filters-body {
        padding: var(--md3-spacing-xl);
    }

    .filters-form {
        width: 100%;
    }

    .filters-grid {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 1fr;
        gap: var(--md3-spacing-lg);
        margin-bottom: var(--md3-spacing-xl);
    }

    @media (max-width: 1024px) {
        .filters-grid {
            grid-template-columns: 1fr 1fr;
        }
    }

    @media (max-width: 768px) {
        .filters-grid {
            grid-template-columns: 1fr;
        }
    }

    .filter-group {
        display: flex;
        flex-direction: column;
    }

    .filter-label {
        display: flex;
        align-items: center;
        gap: var(--md3-spacing-xs);
        margin-bottom: var(--md3-spacing-sm);
        font-weight: 600;
        color: var(--md3-on-surface);
        font-size: 0.875rem;
    }

    .filter-label .material-icons {
        font-size: 1rem;
        color: var(--md3-primary);
    }

    .filter-input,
    .filter-select {
        width: 100%;
        padding: var(--md3-spacing-md) var(--md3-spacing-lg);
        background: var(--md3-surface-container-highest);
        border: 1px solid var(--md3-outline);
        border-radius: var(--md3-radius-md);
        font-family: inherit;
        font-size: 1rem;
        color: var(--md3-on-surface);
        transition: all 0.2s ease;
        box-sizing: border-box;
    }

    .filter-input:focus,
    .filter-select:focus {
        outline: none;
        border-color: var(--md3-primary);
        box-shadow: 0 0 0 3px var(--md3-primary-container);
    }

    .filter-input::placeholder {
        color: var(--md3-on-surface-variant);
    }

    .filters-actions {
        display: flex;
        gap: var(--md3-spacing-md);
        justify-content: flex-end;
        flex-wrap: wrap;
    }

    @media (max-width: 768px) {
        .filters-actions {
            flex-direction: column;
        }

        .filters-actions .btn {
            width: 100%;
            justify-content: center;
        }
    }

    /* 导出功能样式 */
    .export-section {
        margin-top: var(--md3-spacing-lg);
        padding-top: var(--md3-spacing-lg);
        border-top: 1px solid var(--md3-outline-variant);
    }

    .export-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: var(--md3-spacing-md);
    }

    .export-title {
        display: flex;
        align-items: center;
        gap: var(--md3-spacing-sm);
        font-weight: 600;
        color: var(--md3-on-surface);
    }

    .export-title .material-icons {
        color: var(--md3-tertiary);
    }

    .select-all-container {
        display: flex;
        align-items: center;
        gap: var(--md3-spacing-sm);
    }

    .select-all-container input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
        accent-color: var(--md3-primary);
    }

    .select-all-container label {
        cursor: pointer;
        font-weight: 500;
        color: var(--md3-on-surface-variant);
    }

    .export-actions {
        display: flex;
        gap: var(--md3-spacing-md);
        align-items: center;
    }

    .selected-count {
        padding: var(--md3-spacing-sm) var(--md3-spacing-md);
        background: var(--md3-primary-container);
        color: var(--md3-on-primary-container);
        border-radius: var(--md3-radius-full);
        font-size: 0.875rem;
        font-weight: 600;
    }

    .btn-export {
        display: inline-flex;
        align-items: center;
        gap: var(--md3-spacing-sm);
        padding: var(--md3-spacing-md) var(--md3-spacing-lg);
        background: var(--md3-tertiary);
        color: var(--md3-on-tertiary);
        border: none;
        border-radius: var(--md3-radius-full);
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
    }

    .btn-export:hover {
        background: var(--md3-tertiary);
        box-shadow: var(--md3-elevation-2);
        transform: translateY(-2px);
    }

    .btn-export:disabled {
        background: var(--md3-surface-variant);
        color: var(--md3-on-surface-variant);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .btn-export .material-icons {
        font-size: 1.125rem;
    }

    /* ============================================================================
     * 活动网格布局和卡片样式
     * ============================================================================ */

    /* 活动网格布局 */
    .activities-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1.5rem;
        margin-top: 2rem;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        padding: 0.5rem;
        margin: 2rem -0.5rem 0 -0.5rem;
        padding-bottom: 4rem;
    }

    /* 活动卡片 */
    .activity-card {
        background: var(--md3-surface-container-low);
        border-radius: var(--md3-radius-lg);
        overflow: hidden;
        box-shadow: var(--md3-elevation-1);
        transition: all 0.3s cubic-bezier(0.2, 0, 0, 1);
        display: flex;
        flex-direction: column;
        height: 100%;
        position: relative;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        z-index: 1;
    }

    .activity-card:hover {
        box-shadow: var(--md3-elevation-3);
        transform: translateY(-4px);
        z-index: 10;
    }

    /* 活动选择复选框（仅管理员和干事可见） */
    .activity-checkbox {
        position: absolute;
        top: 1rem;
        right: 1rem;
        z-index: 10;
    }

    .activity-checkbox input[type="checkbox"] {
        width: 24px;
        height: 24px;
        cursor: pointer;
        accent-color: var(--md3-primary);
        border-radius: 4px;
    }

    /* 卡片头部 */
    .activity-card-header {
        padding: 1.5rem 1.5rem 1rem 1.5rem;
        background: linear-gradient(135deg, var(--md3-primary-container) 0%, var(--md3-secondary-container) 100%);
        position: relative;
    }

    .activity-header-content {
        position: relative;
        z-index: 2;
    }

    .activity-name {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--md3-on-surface);
        margin: 0 0 0.75rem 0;
        line-height: 1.4;
    }

    .activity-club {
        display: inline-block;
        padding: 0.4rem 0.875rem;
        background: var(--md3-primary);
        color: var(--md3-on-primary);
        border-radius: var(--md3-radius-full);
        font-size: 0.75rem;
        font-weight: 600;
        letter-spacing: 0.5px;
        text-transform: uppercase;
    }

    /* 卡片主体 */
    .activity-card-body {
        flex: 1;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    /* 活动详情 */
    .activity-details {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .activity-detail-item {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
    }

    .detail-icon {
        color: var(--md3-primary);
        font-size: 1.5rem;
        flex-shrink: 0;
        margin-top: 2px;
    }

    .detail-content {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .detail-label {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--md3-on-surface-variant);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .detail-value {
        font-size: 0.95rem;
        color: var(--md3-on-surface);
        font-weight: 500;
    }

    /* 活动描述 */
    .activity-description {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        padding: 1rem;
        background: var(--md3-surface);
        border-radius: var(--md3-radius-md);
        border-left: 4px solid var(--md3-secondary);
    }

    .description-label {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--md3-on-surface-variant);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .activity-description p {
        margin: 0;
        font-size: 0.875rem;
        color: var(--md3-on-surface-variant);
        line-height: 1.6;
    }

    /* 卡片底部 */
    .activity-card-footer {
        padding: 1rem 1.5rem 1.5rem 1.5rem;
        border-top: 1px solid var(--md3-outline-variant);
        background: var(--md3-surface-container-lowest);
        display: flex;
        flex-direction: column;
        gap: 1rem;
        width: 100%;
        box-sizing: border-box;
        overflow: hidden;
    }

    .activity-contact {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .contact-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        color: var(--md3-on-surface-variant);
    }

    .contact-item .material-icons {
        font-size: 1.125rem;
        color: var(--md3-tertiary);
    }

    /* 操作按钮区域 */
    .action-buttons {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    /* 参加活动按钮 */
    .btn-join-activity {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.75rem 1.5rem;
        background: var(--md3-primary);
        color: var(--md3-on-primary);
        border-radius: var(--md3-radius-full);
        font-size: 0.875rem;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.3s cubic-bezier(0.2, 0, 0, 1);
        cursor: pointer;
        border: none;
        min-width: 100px;
        gap: 0.5rem;
    }

    .btn-join-activity:hover:not(.btn-join-activity-disabled) {
        background: var(--md3-primary);
        box-shadow: var(--md3-elevation-2);
        transform: translateY(-2px);
    }

    .btn-join-activity-disabled {
        background: var(--md3-outline-variant);
        color: var(--md3-on-surface-variant);
        cursor: default;
    }

    .btn-join-activity-disabled:hover {
        background: var(--md3-outline-variant);
        box-shadow: none;
        transform: none;
    }

    /* 编辑活动按钮 */
    .btn-edit-activity {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.75rem 1.5rem;
        background: var(--md3-tertiary);
        color: var(--md3-on-tertiary);
        border-radius: var(--md3-radius-full);
        font-size: 0.875rem;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.3s cubic-bezier(0.2, 0, 0, 1);
        cursor: pointer;
        border: none;
        gap: 0.5rem;
    }

    .btn-edit-activity:hover {
        background: var(--md3-tertiary);
        box-shadow: var(--md3-elevation-2);
        transform: translateY(-2px);
    }

    .btn-edit-activity .material-icons {
        font-size: 1rem;
    }

    /* 空状态 */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: var(--md3-on-surface-variant);
    }

    .empty-state .empty-icon {
        font-size: 5rem;
        opacity: 0.4;
        margin-bottom: 1rem;
        color: var(--md3-outline);
    }

    .empty-state p {
        font-size: 1.125rem;
        font-weight: 500;
    }

    /* 响应式设计 */
    @media (max-width: 768px) {
        .activities-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
            padding-bottom: 5rem;
        }

        .activity-name {
            font-size: 1.125rem;
        }

        .activity-card-header {
            padding: 1.25rem;
        }

        .activity-card-body {
            padding: 1.25rem;
            gap: 1.25rem;
        }

        .activity-card-footer {
            padding: 1rem 1.25rem;
        }

        .activity-detail-item {
            gap: 0.75rem;
        }
    }

    @media (max-width: 480px) {
        .activities-grid {
            gap: 0.75rem;
        }

        .activity-card {
            border-radius: var(--md3-radius-md);
        }

        .activity-name {
            font-size: 1rem;
        }

        .detail-label {
            font-size: 0.7rem;
        }

        .detail-value {
            font-size: 0.875rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="home-container">
    <div class="page-header">
        <div class="title-section">
            <span class="material-icons">event_note</span>
            <h1>活动管理</h1>
        </div>
        {% if user.is_authenticated %}
        <div class="header-actions">
            <a href="{% url 'clubs:user_dashboard' %}" class="btn btn-primary">
                <span>返回仪表板</span>
            </a>
        </div>
        {% endif %}
    </div>

    <!-- 筛选和搜索表单 -->
    <div class="filters-section">
        <div class="filters-card">
            <div class="filters-header">
                <h2>
                    <span class="material-icons">filter_list</span>
                    筛选和搜索
                </h2>
            </div>
            <div class="filters-body">
                <form method="get" class="filters-form">
                    <div class="filters-grid">
                        <!-- 搜索框 -->
                        <div class="filter-group">
                            <label class="filter-label" for="search">
                                <span class="material-icons">search</span>
                                搜索
                            </label>
                            <input
                                type="text"
                                id="search"
                                name="search"
                                value="{{ search_query }}"
                                placeholder="输入社团名称或活动名称"
                                class="filter-input"
                            >
                        </div>

                        <!-- 社团筛选 -->
                        <div class="filter-group">
                            <label class="filter-label" for="club">
                                <span class="material-icons">business</span>
                                社团名称
                            </label>
                            {% if user.is_authenticated and user.profile.role == 'president' %}
                            {% if all_clubs.exists %}
                                {% with only_club=all_clubs.first %}
                                <select id="club" name="club" class="filter-select" disabled aria-disabled="true" title="仅允许选择本社团">
                                    <option value="{{ only_club.name }}" selected>{{ only_club.name }}</option>
                                </select>
                                <!-- 使用隐藏字段确保表单提交时仍提交社团参数 -->
                                <input type="hidden" name="club" value="{{ only_club.name }}">
                                {% endwith %}
                            {% else %}
                                <select class="filter-select" disabled aria-disabled="true"><option>无所属社团</option></select>
                            {% endif %}
                        {% else %}
                            <select id="club" name="club" class="filter-select">
                                <option value="">全部社团</option>
                                {% for club in all_clubs %}
                                <option value="{{ club.name }}" {% if club_filter == club.name %}selected{% endif %}>
                                    {{ club.name }}
                                </option>
                                {% endfor %}
                            </select>
                        {% endif %}
                        </div>

                        <!-- 活动类型筛选 -->
                        <div class="filter-group">
                            <label class="filter-label" for="activity_type">
                                <span class="material-icons">local_activity</span>
                                活动类型
                            </label>
                            <select id="activity_type" name="activity_type" class="filter-select">
                                <option value="">全部类型</option>
                                {% for value, display in activity_type_choices %}
                                <option value="{{ value }}" {% if activity_type_filter == value %}selected{% endif %}>
                                    {{ display }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- 日期筛选 -->
                        <div class="filter-group">
                            <label class="filter-label" for="date">
                                <span class="material-icons">date_range</span>
                                活动日期
                            </label>
                            <input
                                type="date"
                                id="date"
                                name="date"
                                value="{{ date_filter }}"
                                class="filter-input"
                            >
                        </div>
                    </div>

                    <div class="filters-actions">
                        <button type="submit" class="btn btn-primary">
                            <span class="material-icons">search</span>
                            搜索
                        </button>
                        <a href="{% url 'clubs:public_activities' %}" class="btn btn-outlined">
                            <span class="material-icons">clear</span>
                            清除筛选
                        </a>
                    </div>

                    <!-- 导出功能（管理员、干事和社长可见） -->
                    {% if user.is_authenticated and user.profile.role in 'admin,staff,president' %}
                    <div class="export-section">
                        <div class="export-header">
                            <div class="export-title">
                                <span class="material-icons">file_download</span>
                                <span>批量导出</span>
                            </div>
                            <div class="select-all-container">
                                <input type="checkbox" id="select-all" onclick="toggleAllActivities(this)">
                                <label for="select-all">全选</label>
                            </div>
                        </div>
                        <div class="export-actions">
                            <span class="selected-count" id="selected-count">已选择 0 个活动</span>
                            <button type="button" class="btn-export" id="export-btn" onclick="exportActivities()" disabled>
                                <span class="material-icons">table_chart</span>
                                导出为 Excel
                            </button>
                        </div>
                    </div>
                    {% endif %}
                </form>
            </div>
        </div>
    </div>

    {% if approved_activities %}
        <div class="activities-grid">
            {% for activity in approved_activities %}
                <div class="activity-card">
                    <!-- 选择复选框（管理员、干事和社长可见） -->
                    {% if user.is_authenticated and user.profile.role in 'admin,staff,president' %}
                    <div class="activity-checkbox">
                        <input type="checkbox" 
                               class="activity-select" 
                               data-activity-id="{{ activity.id }}"
                               data-activity-name="{{ activity.activity_name }}"
                               data-club-name="{{ activity.club.name }}"
                               data-activity-date="{{ activity.activity_date|date:'Y-m-d' }}"
                               data-activity-type="{{ activity.get_activity_type_display }}"
                               onchange="updateSelectedCount()">
                    </div>
                    {% endif %}
                    
                    <div class="activity-card-header">
                        <div class="activity-header-content">
                            <h3 class="activity-name">{{ activity.activity_name }}</h3>
                            <span class="activity-club">{{ activity.club.name }}</span>
                        </div>
                    </div>
                    
                    <div class="activity-card-body">
                        <div class="activity-details">
                            <div class="activity-detail-item">
                                <span class="material-icons detail-icon">event</span>
                                <div class="detail-content">
                                    <span class="detail-label">日期</span>
                                    <span class="detail-value">{{ activity.activity_date|date:"Y年m月d日" }}</span>
                                </div>
                            </div>
                            <div class="activity-detail-item">
                                <span class="material-icons detail-icon">schedule</span>
                                <div class="detail-content">
                                    <span class="detail-label">时间</span>
                                    <span class="detail-value">{{ activity.activity_time_start|time:"H:i" }} - {{ activity.activity_time_end|time:"H:i" }}</span>
                                </div>
                            </div>
                            <div class="activity-detail-item">
                                <span class="material-icons detail-icon">location_on</span>
                                <div class="detail-content">
                                    <span class="detail-label">地点</span>
                                    <span class="detail-value">{{ activity.activity_location }}</span>
                                </div>
                            </div>
                            <div class="activity-detail-item">
                                <span class="material-icons detail-icon">group</span>
                                <div class="detail-content">
                                    <span class="detail-label">人数</span>
                                    <span class="detail-value">{{ activity.expected_participants }}人</span>
                                </div>
                            </div>
                        </div>

                        <div class="activity-description">
                            <span class="description-label">活动简介</span>
                            <p>{{ activity.activity_description|truncatewords:30 }}</p>
                        </div>
                    </div>

                    <div class="activity-card-footer">
                        <div class="activity-contact">
                            <div class="contact-item">
                                <span class="material-icons">person</span>
                                <span>{{ activity.contact_person }}</span>
                            </div>
                            <div class="contact-item">
                                <span class="material-icons">phone</span>
                                <span>{{ activity.contact_phone }}</span>
                            </div>
                        </div>
                        <div class="action-buttons">
                            {% if user.is_authenticated %}
                                <!-- 编辑按钮：干事、管理员和负责老师可见 -->
                                {% if user.profile.role in 'admin,staff' %}
                                    <a href="{% url 'clubs:edit_activity_application' activity.id %}" class="btn-edit-activity">
                                        <span class="material-icons">edit</span>
                                        编辑
                                    </a>
                                {% endif %}
                            {% else %}
                                <a href="{% url 'clubs:login' %}" class="btn-join-activity btn-join-activity-disabled">
                                    登录参加
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty-state">
            <span class="material-icons empty-icon">event_busy</span>
            <p>暂无即将举办的活动</p>
        </div>
    {% endif %}
</div>

<script>
// 更新选中计数
function updateSelectedCount() {
    const checkboxes = document.querySelectorAll('.activity-select:checked');
    const count = checkboxes.length;
    const countElement = document.getElementById('selected-count');
    const exportBtn = document.getElementById('export-btn');
    
    if (countElement) {
        countElement.textContent = `已选择 ${count} 个活动`;
    }
    
    if (exportBtn) {
        exportBtn.disabled = count === 0;
    }
    
    // 更新全选复选框状态
    const selectAllCheckbox = document.getElementById('select-all');
    const allCheckboxes = document.querySelectorAll('.activity-select');
    if (selectAllCheckbox && allCheckboxes.length > 0) {
        selectAllCheckbox.checked = count === allCheckboxes.length;
        selectAllCheckbox.indeterminate = count > 0 && count < allCheckboxes.length;
    }
}

// 全选/取消全选
function toggleAllActivities(checkbox) {
    const allCheckboxes = document.querySelectorAll('.activity-select');
    allCheckboxes.forEach(cb => {
        cb.checked = checkbox.checked;
    });
    updateSelectedCount();
}

// 导出选中的活动
function exportActivities() {
    const checkboxes = document.querySelectorAll('.activity-select:checked');
    if (checkboxes.length === 0) {
        alert('请至少选择一个活动');
        return;
    }
    
    // 收集选中的活动ID
    const activityIds = Array.from(checkboxes).map(cb => cb.dataset.activityId);
    
    // 获取当前筛选条件
    const urlParams = new URLSearchParams(window.location.search);
    const club = urlParams.get('club') || '';
    const activityType = urlParams.get('activity_type') || '';
    const date = urlParams.get('date') || '';
    const search = urlParams.get('search') || '';
    
    // 构建导出URL
    const exportUrl = new URL('{% url "clubs:export_activities" %}', window.location.origin);
    exportUrl.searchParams.append('ids', activityIds.join(','));
    if (club) exportUrl.searchParams.append('club', club);
    if (activityType) exportUrl.searchParams.append('activity_type', activityType);
    if (date) exportUrl.searchParams.append('date', date);
    if (search) exportUrl.searchParams.append('search', search);
    
    // 触发下载
    window.location.href = exportUrl.toString();
}

// 页面加载时初始化
document.addEventListener('DOMContentLoaded', function() {
    updateSelectedCount();
});
</script>{% endblock %}