{% extends 'clubs/base.html' %}

{% block title %}
    {% if is_admin_view %}
        编辑用户账户 - CManager
    {% else %}
        修改账户设置 - CManager
    {% endif %}
{% endblock %}

{% block content %}
<div class="container container-md" style="padding-top: 24px; padding-bottom: 60px;">
    <!-- Page Header -->
    <div class="page-header">
        <span class="material-icons">
            {% if is_admin_view %}manage_accounts{% else %}settings{% endif %}
        </span>
        <div class="page-header-content">
            {% if is_admin_view %}
                <h1>编辑用户账户</h1>
                <div class="subtitle" style="display: flex; align-items: center; gap: 8px;">
                    正在编辑：
                    <a href="{% url 'clubs:user_detail' target_user.id %}" style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 8px;">
                        <div style="width: 24px; height: 24px; border-radius: 50%; overflow: hidden; flex-shrink: 0;">
                            {% if target_user.profile.avatar %}
                                <img src="{{ target_user.profile.avatar.url }}" alt="{{ target_user.username }}" style="width: 100%; height: 100%; object-fit: cover;">
                            {% else %}
                                <div style="width: 100%; height: 100%; background: var(--md3-primary-container); color: var(--md3-on-primary-container); display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px;">
                                    {{ target_user.profile.get_full_name|slice:":1"|default:target_user.username|slice:":1"|upper }}
                                </div>
                            {% endif %}
                        </div>
                        <strong>{{ target_user.username }}</strong>
                    </a>
                </div>
            {% else %}
                <h1>修改账户设置</h1>
                <div class="subtitle" style="display: flex; align-items: center; gap: 8px;">
                    用户名：
                    <a href="{% url 'clubs:user_detail' user.id %}" style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 8px;">
                        <div style="width: 24px; height: 24px; border-radius: 50%; overflow: hidden; flex-shrink: 0;">
                            {% if user.profile.avatar %}
                                <img src="{{ user.profile.avatar.url }}" alt="{{ user.username }}" style="width: 100%; height: 100%; object-fit: cover;">
                            {% else %}
                                <div style="width: 100%; height: 100%; background: var(--md3-primary-container); color: var(--md3-on-primary-container); display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px;">
                                    {{ user.profile.get_full_name|slice:":1"|default:user.username|slice:":1"|upper }}
                                </div>
                            {% endif %}
                        </div>
                        <strong>{{ user.username }}</strong>
                    </a>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Messages -->
    {% if messages %}
        <div style="margin-bottom: 24px;">
            {% for message in messages %}
                <div class="msg-{{ message.tags|default:'info' }}" style="margin-bottom: 8px;">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}
    
    {% if errors %}
        <div style="margin-bottom: 24px;">
            {% for error in errors %}
                <div class="msg-error" style="margin-bottom: 8px;">
                    <span class="material-icons" style="vertical-align: middle; font-size: 1.2em; margin-right: 4px;">error</span>
                    {{ error }}
                </div>
            {% endfor %}
        </div>
    {% endif %}
    
    {% if success_messages %}
        <div style="margin-bottom: 24px;">
            {% for msg in success_messages %}
                <div class="msg-success" style="margin-bottom: 8px;">
                    <span class="material-icons" style="vertical-align: middle; font-size: 1.2em; margin-right: 4px;">check_circle</span>
                    {{ msg }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- 1. 修改用户名 -->
    <div class="admin-card" style="margin-bottom: 24px;">
        <div style="padding-bottom: 16px; margin-bottom: 16px; border-bottom: 1px solid var(--md3-outline-variant);">
            <h3 style="margin: 0; font-size: 1.25rem; display: flex; align-items: center; gap: 8px;">
                <span class="material-icons" style="color: var(--md3-primary);">person</span>
                修改用户名
            </h3>
        </div>
        
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="change_username">
            
            <div class="form-group" style="margin-bottom: 16px;">
                <label for="new_username" style="display: block; margin-bottom: 8px; font-weight: 500;">
                    新用户名 <span style="color: var(--md3-error);">*</span>
                </label>
                <input 
                    type="text" 
                    id="new_username" 
                    name="new_username" 
                    class="form-input"
                    required
                    minlength="3"
                    maxlength="150"
                    {% if is_admin_view %}
                        value="{{ target_user.username }}"
                    {% endif %}
                    placeholder="输入新用户名（至少3个字符）"
                >
            </div>
            
            {% if not is_admin_view %}
            <div class="form-group" style="margin-bottom: 16px;">
                <label for="password_username" style="display: block; margin-bottom: 8px; font-weight: 500;">
                    密码 <span style="color: var(--md3-error);">*</span>
                </label>
                <input 
                    type="password" 
                    id="password_username" 
                    name="password" 
                    class="form-input"
                    required
                    placeholder="输入当前密码以验证"
                >
                <div style="font-size: 0.875rem; color: var(--md3-on-surface-variant); margin-top: 4px;">
                    为了安全起见，修改用户名需要验证密码
                </div>
            </div>
            {% endif %}
            
            <div class="form-actions">
                {% if is_admin_view %}
                <a href="{% url 'clubs:manage_users' %}" class="btn btn-secondary">
                    取消
                </a>
                {% endif %}
                <button type="submit" class="btn btn-filled">
                    <span class="material-icons">check</span>
                    {% if is_admin_view %}确认修改{% else %}确认修改用户名{% endif %}
                </button>
            </div>
        </form>
    </div>

    <!-- 2. 修改密码 -->
    <div class="admin-card" style="margin-bottom: 24px;">
        <div style="padding-bottom: 16px; margin-bottom: 16px; border-bottom: 1px solid var(--md3-outline-variant);">
            <h3 style="margin: 0; font-size: 1.25rem; display: flex; align-items: center; gap: 8px;">
                <span class="material-icons" style="color: var(--md3-primary);">key</span>
                {% if is_admin_view %}重置密码{% else %}修改密码{% endif %}
            </h3>
        </div>
        
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="change_password">
            
            {% if not is_admin_view %}
            <div class="form-group" style="margin-bottom: 16px;">
                <label for="old_password" style="display: block; margin-bottom: 8px; font-weight: 500;">
                    原密码 <span style="color: var(--md3-error);">*</span>
                </label>
                <input 
                    type="password" 
                    id="old_password" 
                    name="old_password" 
                    class="form-input"
                    required
                    placeholder="输入原密码"
                >
            </div>
            {% endif %}
            
            <div class="grid-2">
                <div class="form-group" style="margin-bottom: 16px;">
                    <label for="new_password" style="display: block; margin-bottom: 8px; font-weight: 500;">
                        新密码 <span style="color: var(--md3-error);">*</span>
                    </label>
                    <input 
                        type="password" 
                        id="new_password" 
                        name="new_password" 
                        class="form-input"
                        required
                        minlength="6"
                        placeholder="输入新密码（至少6个字符）"
                    >
                </div>
                
                <div class="form-group" style="margin-bottom: 16px;">
                    <label for="confirm_password" style="display: block; margin-bottom: 8px; font-weight: 500;">
                        确认新密码 <span style="color: var(--md3-error);">*</span>
                    </label>
                    <input 
                        type="password" 
                        id="confirm_password" 
                        name="confirm_password" 
                        class="form-input"
                        required
                        minlength="6"
                        placeholder="再次输入新密码"
                    >
                </div>
            </div>
            
            <div class="form-actions">
                {% if is_admin_view %}
                <a href="{% url 'clubs:manage_users' %}" class="btn btn-secondary">
                    取消
                </a>
                {% endif %}
                <button type="submit" class="btn btn-filled">
                    <span class="material-icons">check</span>
                    {% if is_admin_view %}确认重置密码{% else %}确认修改密码{% endif %}
                </button>
            </div>
            
            <div style="margin-top: 16px; padding: 12px; background-color: var(--md3-warning-container); color: var(--md3-on-warning-container); border-radius: 8px; font-size: 0.875rem; display: flex; align-items: center; gap: 8px;">
                <span class="material-icons">warning</span>
                <span>{% if is_admin_view %}重置密码后，用户需要使用新密码重新登录{% else %}修改密码后需要重新登录{% endif %}</span>
            </div>
        </form>
    </div>

    {% if is_admin_view %}
    <!-- 3. 修改角色 -->
    <div class="admin-card" style="margin-bottom: 24px;">
        <div style="padding-bottom: 16px; margin-bottom: 16px; border-bottom: 1px solid var(--md3-outline-variant);">
            <h3 style="margin: 0; font-size: 1.25rem; display: flex; align-items: center; gap: 8px;">
                <span class="material-icons" style="color: var(--md3-primary);">manage_accounts</span>
                修改角色
            </h3>
        </div>
        
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="change_role">
            
            <div class="form-group" style="margin-bottom: 16px;">
                <label for="new_role" style="display: block; margin-bottom: 8px; font-weight: 500;">
                    新角色 <span style="color: var(--md3-error);">*</span>
                </label>
                <select 
                    id="new_role" 
                    name="new_role" 
                    class="form-select"
                    required
                >
                    {% for role_code, role_name in ROLE_CHOICES %}
                        <option value="{{ role_code }}" {% if target_user.profile.role == role_code %}selected{% endif %}>
                            {{ role_name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-actions">
                <a href="{% url 'clubs:manage_users' %}" class="btn btn-secondary">
                    取消
                </a>
                <button type="submit" class="btn btn-filled">
                    <span class="material-icons">check</span>
                    确认修改角色
                </button>
            </div>
        </form>
    </div>

    <!-- 4. 修改详细信息 -->
    <div class="admin-card" style="margin-bottom: 24px;">
        <div style="padding-bottom: 16px; margin-bottom: 16px; border-bottom: 1px solid var(--md3-outline-variant);">
            <h3 style="margin: 0; font-size: 1.25rem; display: flex; align-items: center; gap: 8px;">
                <span class="material-icons" style="color: var(--md3-primary);">assignment_ind</span>
                修改用户详细信息
            </h3>
        </div>
        
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="change_user_info">
            
            <div class="grid-2">
                <div class="form-group" style="margin-bottom: 16px;">
                    <label for="real_name" style="display: block; margin-bottom: 8px; font-weight: 500;">
                        真实姓名 <span style="color: var(--md3-error);">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="real_name" 
                        name="real_name" 
                        class="form-input"
                        value="{% if target_user.profile %}{{ target_user.profile.real_name }}{% endif %}"
                        placeholder="输入真实姓名"
                        required
                    >
                </div>
                
                <div class="form-group" style="margin-bottom: 16px;">
                    <label for="email" style="display: block; margin-bottom: 8px; font-weight: 500;">
                        邮箱 <span style="color: var(--md3-error);">*</span>
                    </label>
                    <input 
                        type="email" 
                        id="email" 
                        name="email" 
                        class="form-input"
                        value="{{ target_user.email }}"
                        placeholder="输入邮箱"
                        required
                    >
                </div>
            </div>
            
            <div class="grid-2">
                <div class="form-group" style="margin-bottom: 16px;">
                    <label for="student_id" style="display: block; margin-bottom: 8px; font-weight: 500;">学号</label>
                    <input 
                        type="text" 
                        id="student_id" 
                        name="student_id" 
                        class="form-input"
                        value="{% if target_user.profile %}{{ target_user.profile.student_id }}{% endif %}"
                        placeholder="输入学号"
                    >
                </div>
                
                <div class="form-group" style="margin-bottom: 16px;">
                    <label for="phone" style="display: block; margin-bottom: 8px; font-weight: 500;">电话</label>
                    <input 
                        type="text" 
                        id="phone" 
                        name="phone" 
                        class="form-input"
                        value="{% if target_user.profile %}{{ target_user.profile.phone }}{% endif %}"
                        placeholder="输入电话号码"
                    >
                </div>
            </div>
            
            <div class="grid-2">
                <div class="form-group" style="margin-bottom: 16px;">
                    <label for="wechat" style="display: block; margin-bottom: 8px; font-weight: 500;">微信</label>
                    <input 
                        type="text" 
                        id="wechat" 
                        name="wechat" 
                        class="form-input"
                        value="{% if target_user.profile %}{{ target_user.profile.wechat }}{% endif %}"
                        placeholder="输入微信号"
                    >
                </div>
                
                <div class="form-group" style="margin-bottom: 16px;">
                    <label for="political_status" style="display: block; margin-bottom: 8px; font-weight: 500;">政治面貌</label>
                    <select 
                        id="political_status" 
                        name="political_status"
                        class="form-select"
                    >
                        {% for status_code, status_name in POLITICAL_STATUS_CHOICES %}
                            <option value="{{ status_code }}" {% if target_user.profile.political_status == status_code %}selected{% endif %}>
                                {{ status_name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="form-actions">
                <a href="{% url 'clubs:manage_users' %}" class="btn btn-secondary">
                    取消
                </a>
                <button type="submit" class="btn btn-filled">
                    <span class="material-icons">check</span>
                    确认修改详细信息
                </button>
            </div>
        </form>
    </div>

    <!-- 5. 危险区域 -->
    <div class="admin-card" style="margin-bottom: 24px; border: 1px solid var(--md3-error);">
        <div style="padding-bottom: 16px; margin-bottom: 16px; border-bottom: 1px solid var(--md3-error-container);">
            <h3 style="margin: 0; font-size: 1.25rem; display: flex; align-items: center; gap: 8px; color: var(--md3-error);">
                <span class="material-icons">warning</span>
                危险区域
            </h3>
        </div>
        
        <div style="margin-bottom: 16px; color: var(--md3-on-surface-variant);">
            <p>删除用户账户是不可恢复的操作。所有与该用户相关的数据（如社团成员关系、审核记录等）可能会被永久删除或受到影响。</p>
        </div>
        
        <form method="post" onsubmit="return confirm('确定要永久删除此用户账户吗？此操作无法撤销！');">
            {% csrf_token %}
            <input type="hidden" name="action" value="delete_user">
            
            <div class="form-actions" style="justify-content: flex-start;">
                <button type="submit" class="btn" style="background-color: var(--md3-error); color: var(--md3-on-error); border: none;">
                    <span class="material-icons">delete_forever</span>
                    删除用户账户
                </button>
            </div>
        </form>
    </div>
    {% endif %}
</div>
{% endblock %}