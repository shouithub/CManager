{% comment %}
干事审核表单组件
使用方式: {% include 'clubs/components/_staff_review_form.html' with show_rejected_materials=True materials_list=materials cancel_url='clubs:staff_audit_center' cancel_url_args='club_registration' %}

参数:
- show_rejected_materials: 是否显示被拒绝材料选择面板 (布尔值，默认: False)
- materials_list: 材料列表,格式为[{'field': 'field_name', 'name': '显示名称'}, ...]
- cancel_url: 取消按钮返回的URL名称
- cancel_url_args: URL参数 (可选)
- approve_text: 批准按钮文字 (默认: "通过申请")
- reject_text: 拒绝按钮文字 (默认: "拒绝申请")
- title: 标题 (默认: "提交审核意见")
{% endcomment %}

<div class="card">
    <div class="card-header">
        <span class="material-icons">rate_review</span>
        <h2>{{ title|default:"提交审核意见" }}</h2>
    </div>
    
    <form method="post" id="staff_review_form">
        {% csrf_token %}
        
        <!-- 决策按钮 -->
        <div style="display: flex; gap: var(--md3-spacing-lg); margin-bottom: var(--md3-spacing-xl);">
            <button type="button" class="btn" id="staff_approve_btn" style="flex: 1; padding: var(--md3-spacing-lg); background: var(--md3-success-container); color: var(--md3-on-success-container); border: 2px solid var(--md3-success); font-size: 1rem; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);">
                <span class="material-icons">check_circle</span>
                {{ approve_text|default:"通过申请" }}
            </button>
            <button type="button" class="btn" id="staff_reject_btn" style="flex: 1; padding: var(--md3-spacing-lg); background: var(--md3-error-container); color: var(--md3-on-error-container); border: 2px solid var(--md3-error); font-size: 1rem; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);">
                <span class="material-icons">cancel</span>
                {{ reject_text|default:"拒绝申请" }}
            </button>
        </div>
        
        <!-- 隐藏字段 -->
        <input type="hidden" name="review_status" id="staff_review_status" value="">
        <input type="hidden" name="decision" id="staff_decision" value="">
        
        <!-- 被拒绝材料选择面板 -->
        {% if show_rejected_materials and materials_list %}
        <div id="staff_rejected_materials_panel" style="background: var(--md3-error-container); border: 1px solid var(--md3-error); border-radius: var(--md3-radius-lg); padding: 0; margin-bottom: var(--md3-spacing-lg); max-height: 0; overflow: hidden; opacity: 0; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);">
            <h4 style="color: var(--md3-on-error-container); margin: 0 0 var(--md3-spacing-md) 0; font-size: 0.9375rem; font-weight: 600; display: flex; align-items: center; gap: var(--md3-spacing-sm);">
                <span class="material-icons">error_outline</span>
                选择被拒绝的材料（可多选）
            </h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: var(--md3-spacing-sm);">
                {% for item in materials_list %}
                <label style="display: flex; align-items: center; gap: var(--md3-spacing-sm); color: var(--md3-on-error-container); font-size: 0.875rem; cursor: pointer; padding: var(--md3-spacing-sm) var(--md3-spacing-md); border-radius: var(--md3-radius-sm); transition: background 0.2s ease;">
                    <input type="checkbox" name="rejected_materials" value="{{ item.field }}" style="width: 18px; height: 18px; cursor: pointer; accent-color: var(--md3-error);">
                    {{ item.name }}
                </label>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- 审核意见 -->
        <div style="margin-bottom: var(--md3-spacing-lg);">
            <label for="staff_review_comment" style="display: block; margin-bottom: var(--md3-spacing-sm); font-weight: 600; color: var(--md3-on-surface); font-size: 0.9375rem;">审核意见</label>
            <textarea 
                id="staff_review_comment" 
                name="review_comment" 
                style="width: 100%; padding: var(--md3-spacing-md); background: var(--md3-surface-container-highest); border: 1px solid var(--md3-outline-variant); border-radius: var(--md3-radius-md); color: var(--md3-on-surface); font-family: inherit; font-size: 0.9375rem; resize: vertical; min-height: 120px; box-sizing: border-box; transition: all 0.2s ease;"
                placeholder="请输入您的审核意见（拒绝时必填）"
                rows="4"
                onfocus="this.style.borderColor='var(--md3-primary)'; this.style.boxShadow='0 0 0 3px var(--md3-primary-container)';"
                onblur="this.style.borderColor='var(--md3-outline-variant)'; this.style.boxShadow='none';"
            ></textarea>
            <!-- 兼容字段 -->
            <input type="hidden" name="review_comments" id="staff_review_comments" value="">
            <input type="hidden" name="comment" id="staff_comment" value="">
        </div>
        
        <!-- 操作按钮 -->
        <div style="display: flex; gap: var(--md3-spacing-md); margin-top: var(--md3-spacing-xl); padding-top: var(--md3-spacing-lg); border-top: 1px solid var(--md3-outline-variant);">
            <button type="submit" class="btn btn-primary" id="staff_submit_btn" style="flex: 1; display: none;">
                <span class="material-icons">send</span>
                提交审核
            </button>
            <a href="{% if cancel_url_args %}{% url cancel_url cancel_url_args %}{% else %}{% url cancel_url %}{% endif %}" class="btn btn-secondary" style="flex: 1; justify-content: center;">
                <span class="material-icons">arrow_back</span>
                返回
            </a>
        </div>
    </form>
</div>

<script>
(function() {
    // 使用IIFE避免全局污染
    const approveBtn = document.getElementById('staff_approve_btn');
    const rejectBtn = document.getElementById('staff_reject_btn');
    const submitBtn = document.getElementById('staff_submit_btn');
    const reviewStatus = document.getElementById('staff_review_status');
    const decision = document.getElementById('staff_decision');
    const rejectedMaterialsPanel = document.getElementById('staff_rejected_materials_panel');
    const reviewComment = document.getElementById('staff_review_comment');
    const reviewComments = document.getElementById('staff_review_comments');
    const comment = document.getElementById('staff_comment');
    const form = document.getElementById('staff_review_form');
    
    let selectedDecision = null;
    
    // 批准按钮点击
    if (approveBtn) {
        approveBtn.addEventListener('click', function() {
            selectedDecision = 'approved';
            reviewStatus.value = 'approved';
            decision.value = 'approved';
            
            // 更新按钮样式和宽度动画
            approveBtn.style.flex = '7';
            approveBtn.style.background = 'var(--md3-success)';
            approveBtn.style.color = 'var(--md3-on-success)';
            approveBtn.style.boxShadow = 'var(--md3-elevation-3)';
            
            rejectBtn.style.flex = '3';
            rejectBtn.style.background = 'var(--md3-error-container)';
            rejectBtn.style.color = 'var(--md3-on-error-container)';
            rejectBtn.style.boxShadow = 'none';
            
            // 隐藏材料选择面板
            if (rejectedMaterialsPanel) {
                rejectedMaterialsPanel.style.maxHeight = '0';
                rejectedMaterialsPanel.style.opacity = '0';
                rejectedMaterialsPanel.style.padding = '0';
            }
            
            // 显示提交按钮
            submitBtn.style.display = 'flex';
        });
    }
    
    // 拒绝按钮点击
    if (rejectBtn) {
        rejectBtn.addEventListener('click', function() {
            selectedDecision = 'rejected';
            reviewStatus.value = 'rejected';
            decision.value = 'rejected';
            
            // 更新按钮样式和宽度动画
            rejectBtn.style.flex = '7';
            rejectBtn.style.background = 'var(--md3-error)';
            rejectBtn.style.color = 'var(--md3-on-error)';
            rejectBtn.style.boxShadow = 'var(--md3-elevation-3)';
            
            approveBtn.style.flex = '3';
            approveBtn.style.background = 'var(--md3-success-container)';
            approveBtn.style.color = 'var(--md3-on-success-container)';
            approveBtn.style.boxShadow = 'none';
            
            // 显示材料选择面板
            if (rejectedMaterialsPanel) {
                rejectedMaterialsPanel.style.maxHeight = '500px';
                rejectedMaterialsPanel.style.opacity = '1';
                rejectedMaterialsPanel.style.padding = 'var(--md3-spacing-lg)';
            }
            
            // 显示提交按钮
            submitBtn.style.display = 'flex';
        });
    }
    
    // 表单提交验证
    if (form) {
        form.addEventListener('submit', function(e) {
            const commentValue = reviewComment.value.trim();
            
            // 同步评论字段
            reviewComments.value = commentValue;
            comment.value = commentValue;
            
            if (!selectedDecision) {
                e.preventDefault();
                alert('请先选择审核决定（通过或拒绝）！');
                return false;
            }
            
            if (selectedDecision === 'rejected') {
                if (commentValue === '') {
                    e.preventDefault();
                    alert('拒绝时必须填写审核意见！');
                    reviewComment.focus();
                    return false;
                }
                
                // 检查是否选择了被拒绝材料（如果有材料选择面板）
                if (rejectedMaterialsPanel) {
                    const checkedMaterials = form.querySelectorAll('input[name="rejected_materials"]:checked');
                    if (checkedMaterials.length === 0) {
                        e.preventDefault();
                        alert('拒绝时必须选择被拒绝的材料！');
                        return false;
                    }
                }
            }
            
            return true;
        });
    }
})();
</script>
