{% extends "clubs/base.html" %}

{% block title %}网站图标管理 - 社团管理系统{% endblock %}

{% block content %}
<div class="page-header">
    <span class="material-icons icon">image</span>
    <div class="page-header-content">
        <h1>网站图标管理</h1>
        <div class="subtitle">上传并更新网站的 Favicon 图标</div>
    </div>
</div>

<div class="main-content" style="max-width: 1200px; margin: 0 auto; padding: var(--md3-spacing-lg);">
    <div class="grid-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: var(--md3-spacing-xl);">
        
        <!-- Current Icon Card -->
        <div class="card card-outlined">
            <div class="card-header">
                <h3>当前图标</h3>
            </div>
            <div class="card-body" style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 200px;">
                {% if site_favicon_preview_url %}
                    <img src="{{ site_favicon_preview_url }}" alt="Current Favicon" style="width: 64px; height: 64px; object-fit: contain; border-radius: var(--md3-radius-sm); box-shadow: var(--md3-elevation-1);">
                    <p style="margin-top: var(--md3-spacing-lg); color: var(--md3-on-surface-variant); text-align: center;">
                        当前使用的网站图标<br>
                        <span style="font-size: 0.875rem; opacity: 0.7;">(将在浏览器标签页显示)</span>
                    </p>
                {% else %}
                    <div style="width: 80px; height: 80px; border: 2px dashed var(--md3-outline-variant); border-radius: var(--md3-radius-md); display: flex; align-items: center; justify-content: center; background-color: var(--md3-surface-container-highest);">
                        <span class="material-icons" style="color: var(--md3-outline); font-size: 32px;">image_not_supported</span>
                    </div>
                    <p style="margin-top: var(--md3-spacing-lg); color: var(--md3-on-surface-variant);">未设置自定义图标</p>
                {% endif %}
            </div>
        </div>

        <!-- Update Icon Card -->
        <div class="card card-filled">
            <div class="card-header">
                <h3>更新图标</h3>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data" id="favicon-form">
                    {% csrf_token %}
                    
                    <div class="form-group">
                        <label for="favicon-input">选择新图标</label>
                        <input type="file" name="favicon" accept=".ico,.png,.jpg,.jpeg" required id="favicon-input" class="form-control" style="background-color: var(--md3-surface);">
                        <div class="helper-text" style="margin-top: var(--md3-spacing-xs); font-size: 0.875rem; color: var(--md3-on-surface-variant);">
                            <span class="material-icons" style="font-size: 14px; vertical-align: middle;">info</span>
                            支持格式: .ico, .png, .jpg (建议使用 .ico)
                        </div>
                    </div>

                    <div class="form-group" id="cropper-wrapper" style="display: none;">
                        <label>裁剪预览</label>
                        <div class="cropper-container">
                            <canvas id="cropper-canvas" width="256" height="256"></canvas>
                        </div>
                        <div class="cropper-controls" style="margin-top: var(--md3-spacing-md);">
                            <div style="display: flex; align-items: center; gap: var(--md3-spacing-sm);">
                                <span class="material-icons" style="font-size: 18px; color: var(--md3-on-surface-variant);">zoom_in</span>
                                <input type="range" id="cropper-zoom" min="1" max="3" step="0.01" value="1" style="flex: 1;">
                            </div>
                            <div style="text-align: center; margin-top: 4px; font-size: 0.75rem; color: var(--md3-on-surface-variant);">拖动图片调整位置</div>
                        </div>
                    </div>

                    <div class="form-actions" style="margin-top: var(--md3-spacing-xl); display: flex; gap: var(--md3-spacing-md); justify-content: flex-end;">
                        <a href="{% url 'clubs:index' %}" class="btn btn-text">
                            返回首页
                        </a>
                        <button type="submit" class="btn btn-filled">
                            <span class="material-icons">upload</span>
                            上传更新
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    .cropper-container {
        width: 100%;
        max-width: 260px;
        height: 260px;
        border: 1px solid var(--md3-outline-variant);
        border-radius: var(--md3-radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--md3-surface-container-low);
        margin: var(--md3-spacing-sm) auto;
        overflow: hidden;
    }
    
    /* Range Slider Styling */
    input[type=range] {
        -webkit-appearance: none;
        width: 100%;
        background: transparent;
    }
    
    input[type=range]::-webkit-slider-thumb {
        -webkit-appearance: none;
        height: 16px;
        width: 16px;
        border-radius: 50%;
        background: var(--md3-primary);
        cursor: pointer;
        margin-top: -6px;
    }
    
    input[type=range]::-webkit-slider-runnable-track {
        width: 100%;
        height: 4px;
        cursor: pointer;
        background: var(--md3-secondary-container);
        border-radius: 2px;
    }
</style>

<script>
    (function() {
        var input = document.getElementById('favicon-input');
        var wrapper = document.getElementById('cropper-wrapper');
        var canvas = document.getElementById('cropper-canvas');
        var zoom = document.getElementById('cropper-zoom');
        var form = document.getElementById('favicon-form');
        if (!input || !wrapper || !canvas || !zoom || !form) {
            return;
        }
        var ctx = canvas.getContext('2d');
        var img = new Image();
        var imgReady = false;
        var dragging = false;
        var lastX = 0;
        var lastY = 0;
        var scale = 1;
        var minScale = 1;
        var offsetX = 0;
        var offsetY = 0;
        function clampOffsets() {
            var maxX = 0;
            var maxY = 0;
            var minX = canvas.width - img.width * scale;
            var minY = canvas.height - img.height * scale;
            if (img.width * scale < canvas.width) {
                minX = maxX = (canvas.width - img.width * scale) / 2;
            }
            if (img.height * scale < canvas.height) {
                minY = maxY = (canvas.height - img.height * scale) / 2;
            }
            offsetX = Math.min(maxX, Math.max(minX, offsetX));
            offsetY = Math.min(maxY, Math.max(minY, offsetY));
        }
        function draw() {
            if (!imgReady) {
                return;
            }
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, offsetX, offsetY, img.width * scale, img.height * scale);
        }
        function fitImage() {
            minScale = Math.max(canvas.width / img.width, canvas.height / img.height);
            scale = minScale;
            offsetX = (canvas.width - img.width * scale) / 2;
            offsetY = (canvas.height - img.height * scale) / 2;
            zoom.min = minScale.toFixed(4);
            zoom.max = (minScale * 3).toFixed(4);
            zoom.value = scale.toFixed(4);
            clampOffsets();
            draw();
        }
        function setScale(newScale) {
            var centerX = canvas.width / 2;
            var centerY = canvas.height / 2;
            var imgCenterX = (centerX - offsetX) / scale;
            var imgCenterY = (centerY - offsetY) / scale;
            scale = newScale;
            offsetX = centerX - imgCenterX * scale;
            offsetY = centerY - imgCenterY * scale;
            clampOffsets();
            draw();
        }
        input.addEventListener('change', function() {
            var file = input.files && input.files[0];
            if (!file) {
                wrapper.style.display = 'none';
                imgReady = false;
                return;
            }
            var reader = new FileReader();
            reader.onload = function(e) {
                img.onload = function() {
                    imgReady = true;
                    wrapper.style.display = 'block';
                    fitImage();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
        zoom.addEventListener('input', function() {
            if (!imgReady) {
                return;
            }
            setScale(parseFloat(zoom.value));
        });
        canvas.addEventListener('pointerdown', function(e) {
            if (!imgReady) {
                return;
            }
            dragging = true;
            lastX = e.clientX;
            lastY = e.clientY;
            canvas.setPointerCapture(e.pointerId);
        });
        canvas.addEventListener('pointermove', function(e) {
            if (!dragging || !imgReady) {
                return;
            }
            var dx = e.clientX - lastX;
            var dy = e.clientY - lastY;
            lastX = e.clientX;
            lastY = e.clientY;
            offsetX += dx;
            offsetY += dy;
            clampOffsets();
            draw();
        });
        canvas.addEventListener('pointerup', function(e) {
            dragging = false;
            canvas.releasePointerCapture(e.pointerId);
        });
        canvas.addEventListener('pointerleave', function(e) {
            dragging = false;
        });
        form.addEventListener('submit', function(e) {
            if (!imgReady) {
                return;
            }
            e.preventDefault();
            canvas.toBlob(function(blob) {
                if (!blob) {
                    form.submit();
                    return;
                }
                var data = new FormData();
                var csrf = form.querySelector('input[name="csrfmiddlewaretoken"]');
                if (csrf) {
                    data.append('csrfmiddlewaretoken', csrf.value);
                }
                data.append('favicon', blob, 'favicon.png');
                fetch(form.action || window.location.href, {
                    method: 'POST',
                    body: data,
                    headers: {
                        'X-CSRFToken': csrf ? csrf.value : ''
                    }
                }).then(function(res) {
                    if (res.ok) {
                        window.location.reload();
                    } else {
                        form.submit();
                    }
                }).catch(function() {
                    form.submit();
                });
            }, 'image/png');
        });
    })();
</script>
{% endblock %}