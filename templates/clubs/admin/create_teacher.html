{% extends 'clubs/base.html' %}
{% load custom_filters %}

{% block title %}åˆ›å»ºç”¨æˆ·è´¦æˆ·{% endblock %}

{% block extra_css %}
<style>
.create-user-container {
    max-width: 700px;
    margin: 0 auto;
    padding: 24px;
}

.create-user-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 32px;
}

.create-user-header h1 {
    font-size: 28px;
    font-weight: 500;
    margin: 0;
    color: var(--md-sys-color-on-background, #1c1b1f);
}

.md3-card {
    background: var(--md-sys-color-surface, #fffbfe);
    border-radius: 12px;
    padding: 32px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
}

.error-alert {
    background: var(--md-sys-color-error-container, #f9dedc);
    border-left: 4px solid var(--md-sys-color-error, #b3261e);
    color: var(--md-sys-color-on-error-container, #410e0b);
    padding: 16px;
    border-radius: 4px;
    margin-bottom: 24px;
}

.error-alert ul {
    margin: 0;
    padding-left: 20px;
}

.form-section {
    margin-bottom: 24px;
}

.form-section-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--md-sys-color-on-surface-variant, #49454f);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--md-sys-color-outline-variant, #cac4d0);
}

.form-group {
    margin-bottom: 20px;
}

.form-label {
    display: block;
    font-size: 14px;
    font-weight: 500;
    color: var(--md-sys-color-on-background, #1c1b1f);
    margin-bottom: 8px;
}

.form-label .required {
    color: var(--md-sys-color-error, #b3261e);
}

.form-input,
.form-select {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid var(--md-sys-color-outline, #79747e);
    border-radius: 4px;
    font-size: 14px;
    font-family: inherit;
    background: var(--md-sys-color-surface, #fffbfe);
    color: var(--md-sys-color-on-surface, #1c1b1f);
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
    box-sizing: border-box;
}

.form-input:focus,
.form-select:focus {
    outline: none;
    border-color: var(--md-sys-color-primary, #6750a4);
    box-shadow: 0 0 0 3px var(--md-sys-color-primary-container, #eaddff);
}

.form-input::placeholder {
    color: var(--md-sys-color-on-surface-variant, #49454f);
}

.form-helper {
    font-size: 12px;
    color: var(--md-sys-color-on-surface-variant, #49454f);
    margin-top: 6px;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
}

.form-row.full {
    grid-template-columns: 1fr;
}

.form-group-inline {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 12px;
}

.radio-group {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
}

.radio-item {
    display: flex;
    align-items: center;
    gap: 8px;
}

.radio-item input[type="radio"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
}

.radio-item label {
    cursor: pointer;
    font-size: 14px;
    margin: 0;
}

.btn-group {
    display: flex;
    gap: 12px;
    margin-top: 32px;
}

.btn {
    flex: 1;
    padding: 12px 24px;
    border: none;
    border-radius: 4px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    text-decoration: none;
}

.btn-primary {
    background: var(--md-sys-color-primary, #6750a4);
    color: var(--md-sys-color-on-primary, #fff);
}

.btn-primary:hover {
    background: var(--md-sys-color-primary, #6750a4);
    opacity: 0.9;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(103, 80, 164, 0.3);
}

.btn-secondary {
    background: var(--md-sys-color-secondary-container, #e8def8);
    color: var(--md-sys-color-on-secondary-container, #1d192b);
}

.btn-secondary:hover {
    background: var(--md-sys-color-secondary-container, #e8def8);
    opacity: 0.9;
}

.role-hint {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 12px;
    margin-top: 16px;
    padding: 12px;
    background: var(--md-sys-color-surface-container, #f7f2fa);
    border-radius: 4px;
}

.role-hint-item {
    font-size: 12px;
    color: var(--md-sys-color-on-surface-variant, #49454f);
}

.role-hint-item strong {
    display: block;
    color: var(--md-sys-color-on-surface, #1c1b1f);
    margin-bottom: 4px;
}

.club-selection {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 12px;
    margin-top: 12px;
    padding: 12px;
    background: var(--md-sys-color-surface-container-lowest, #ffffff);
    border: 1px solid var(--md-sys-color-outline-variant, #cac4d0);
    border-radius: 8px;
}

.club-checkbox {
    display: flex;
    align-items: center;
    gap: 8px;
}

.club-checkbox input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
    accent-color: var(--md-sys-color-primary, #6750a4);
}

.club-checkbox label {
    cursor: pointer;
    font-size: 14px;
    margin: 0;
    color: var(--md-sys-color-on-surface, #1c1b1f);
}

.form-hint {
    font-size: 12px;
    color: var(--md-sys-color-on-surface-variant, #49454f);
    margin-top: 8px;
    font-style: italic;
}

@media (max-width: 600px) {
    .create-user-container {
        padding: 16px;
    }
    
    .md3-card {
        padding: 20px;
    }
    
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .btn-group {
        flex-direction: column;
    }
    
    .btn {
        width: 100%;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="create-user-container">
    <div class="create-user-header">
        <span style="font-size: 32px;">ğŸ‘¤</span>
        <div>
            <h1>åˆ›å»ºç”¨æˆ·è´¦æˆ·</h1>
            <p style="margin: 4px 0 0 0; font-size: 14px; color: var(--md-sys-color-on-surface-variant, #49454f);">
                ä¸ºç³»ç»Ÿåˆ›å»ºæ–°çš„ç”¨æˆ·è´¦æˆ·
            </p>
        </div>
    </div>

    <div class="md3-card">
        {% if errors %}
        <div class="error-alert">
            <ul>
                {% for error in errors %}
                <li>{{ error }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <form method="post">
            {% csrf_token %}

            <!-- è´¦æˆ·ä¿¡æ¯ -->
            <div class="form-section">
                <div class="form-section-title">è´¦æˆ·ä¿¡æ¯</div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="username">
                            ç”¨æˆ·å <span class="required">*</span>
                        </label>
                        <input type="text" class="form-input" id="username" name="username" 
                               value="{{ form_data.username }}" required placeholder="è¾“å…¥ç”¨æˆ·å">
                        <div class="form-helper">ç”¨äºç™»å½•çš„å”¯ä¸€ç”¨æˆ·åï¼Œ3-30ä¸ªå­—ç¬¦</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="email">
                            é‚®ç®± <span class="required">*</span>
                        </label>
                        <input type="email" class="form-input" id="email" name="email" 
                               value="{{ form_data.email }}" required placeholder="example@email.com">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="password">
                            å¯†ç  <span class="required">*</span>
                        </label>
                        <input type="password" class="form-input" id="password" name="password" 
                               required placeholder="è¾“å…¥å¯†ç ">
                        <div class="form-helper">è‡³å°‘6ä¸ªå­—ç¬¦ï¼Œå»ºè®®åŒ…å«å¤§å°å†™å­—æ¯å’Œæ•°å­—</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="password2">
                            ç¡®è®¤å¯†ç  <span class="required">*</span>
                        </label>
                        <input type="password" class="form-input" id="password2" name="password2" 
                               required placeholder="å†æ¬¡è¾“å…¥å¯†ç ">
                    </div>
                </div>
            </div>

            <!-- ä¸ªäººä¿¡æ¯ -->
            <div class="form-section">
                <div class="form-section-title">ä¸ªäººä¿¡æ¯</div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="real_name">
                            å§“å <span class="required">*</span>
                        </label>
                        <input type="text" class="form-input" id="real_name" name="real_name" 
                               value="{{ form_data.real_name }}" required placeholder="è¾“å…¥çœŸå®å§“å">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="phone">
                            ç”µè¯ <span class="required">*</span>
                        </label>
                        <input type="tel" class="form-input" id="phone" name="phone" 
                               value="{{ form_data.phone }}" required placeholder="13800000000">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="wechat">
                            å¾®ä¿¡å· <span class="required">*</span>
                        </label>
                        <input type="text" class="form-input" id="wechat" name="wechat" 
                               value="{{ form_data.wechat }}" required placeholder="è¾“å…¥å¾®ä¿¡å·">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="student_id">
                            å­¦å· <span class="required">*</span>
                        </label>
                        <input type="text" class="form-input" id="student_id" name="student_id" 
                               value="{{ form_data.student_id }}" placeholder="è¾“å…¥å­¦å·ï¼ˆå¦‚éå­¦ç”Ÿå¯ç•™ç©ºï¼‰">
                    </div>
                </div>
            </div>

            <!-- è§’è‰²åˆ†é… -->
            <div class="form-section">
                <div class="form-section-title">ç”¨æˆ·è§’è‰²</div>
                
                <div class="form-group form-row full">
                    <label class="form-label">é€‰æ‹©ç”¨æˆ·è§’è‰² <span class="required">*</span></label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="role_user" name="role" value="user" 
                                   {% if form_data.role == 'user' or not form_data %}checked{% endif %} required>
                            <label for="role_user">æ™®é€šç”¨æˆ·</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="role_teacher" name="role" value="teacher"
                                   {% if form_data.role == 'teacher' %}checked{% endif %}>
                            <label for="role_teacher">è€å¸ˆ</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="role_staff" name="role" value="staff"
                                   {% if form_data.role == 'staff' %}checked{% endif %}>
                            <label for="role_staff">å¹²äº‹</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="role_president" name="role" value="president"
                                   {% if form_data.role == 'president' %}checked{% endif %}>
                            <label for="role_president">ç¤¾é•¿</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="role_admin" name="role" value="admin"
                                   {% if form_data.role == 'admin' %}checked{% endif %}>
                            <label for="role_admin">ç®¡ç†å‘˜</label>
                        </div>
                    </div>
                    <div class="role-hint">
                        <div class="role-hint-item">
                            <strong>ğŸ‘¤ æ™®é€šç”¨æˆ·</strong>
                            åŸºç¡€ç”¨æˆ·æƒé™
                        </div>
                        <div class="role-hint-item">
                            <strong>ğŸ‘¨â€ğŸ« è€å¸ˆ</strong>
                            æ•™èŒå‘˜æƒé™
                        </div>
                        <div class="role-hint-item">
                            <strong>ğŸ‘¥ å¹²äº‹</strong>
                            ç¤¾å›¢å¹²äº‹æƒé™
                        </div>
                        <div class="role-hint-item">
                            <strong>ğŸ‘‘ ç¤¾é•¿</strong>
                            ç¤¾å›¢è´Ÿè´£äºº
                        </div>
                        <div class="role-hint-item">
                            <strong>ğŸ” ç®¡ç†å‘˜</strong>
                            ç³»ç»Ÿç®¡ç†å‘˜æƒé™
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ•™å¸ˆç¤¾å›¢åˆ†é… -->
            <div class="form-section" id="teacher-clubs-section" style="display: none;">
                <div class="form-section-title">åˆ†é…ç¤¾å›¢</div>
                <div class="form-group form-row full">
                    <label class="form-label">é€‰æ‹©åˆ†é…çš„ç¤¾å›¢ <span class="required">*</span></label>
                    <div class="club-selection">
                        {% if clubs %}
                            {% for club in clubs %}
                            <div class="club-checkbox">
                                <input type="checkbox" id="club_{{ club.id }}" name="clubs" value="{{ club.id }}"
                                       {% if club.id|stringformat:"d" in selected_clubs %}checked{% endif %}>
                                <label for="club_{{ club.id }}">{{ club.name }}</label>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p style="color: #666; font-style: italic;">æš‚æ— å¯ç”¨ç¤¾å›¢</p>
                        {% endif %}
                    </div>
                    <div class="form-hint">é€‰æ‹©è¯¥æ•™å¸ˆå°†è¦æŒ‡å¯¼çš„ç¤¾å›¢ï¼ˆå¯å¤šé€‰ï¼‰</div>
                </div>
            </div>

            <div class="btn-group">
                <button type="submit" class="btn btn-primary">
                    <span>âœ“</span> åˆ›å»ºè´¦æˆ·
                </button>
                <a href="{% url 'clubs:manage_users' %}" class="btn btn-secondary">
                    <span>â†</span> è¿”å›
                </a>
            </div>
        </form>
    </div>
</div>

<script>
// å¤„ç†è§’è‰²å˜åŒ– - æ•™å¸ˆéœ€è¦é€‰æ‹©ç¤¾å›¢
document.querySelectorAll('input[name="role"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const clubsSection = document.getElementById('teacher-clubs-section');
        const clubCheckboxes = document.querySelectorAll('input[name="clubs"]');
        
        if (this.value === 'teacher') {
            clubsSection.style.display = 'block';
        } else {
            clubsSection.style.display = 'none';
            // æ¸…é™¤ä¹‹å‰çš„ç¤¾å›¢é€‰æ‹©
            clubCheckboxes.forEach(cb => cb.checked = false);
        }
    });
});

// åˆå§‹åŒ– - å¦‚æœç¼–è¾‘æ—¶å·²é€‰æ‹©æ•™å¸ˆï¼Œæ˜¾ç¤ºç¤¾å›¢é€‰æ‹©
const initialRole = document.querySelector('input[name="role"]:checked');
if (initialRole && initialRole.value === 'teacher') {
    document.getElementById('teacher-clubs-section').style.display = 'block';
}

// éªŒè¯å¯†ç åŒ¹é…å’Œæ•™å¸ˆç¤¾å›¢å¿…é€‰
document.querySelector('form').addEventListener('submit', function(e) {
    const password = document.getElementById('password').value;
    const password2 = document.getElementById('password2').value;
    const selectedRole = document.querySelector('input[name="role"]:checked').value;
    
    if (password !== password2) {
        e.preventDefault();
        alert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´ï¼Œè¯·æ£€æŸ¥ï¼');
        document.getElementById('password2').focus();
        return;
    }
    
    if (selectedRole === 'teacher') {
        const selectedClubs = document.querySelectorAll('input[name="clubs"]:checked');
        if (selectedClubs.length === 0) {
            e.preventDefault();
            alert('æ•™å¸ˆå¿…é¡»åˆ†é…è‡³å°‘ä¸€ä¸ªç¤¾å›¢ï¼');
            return;
        }
    }
});
</script>
{% endblock %}
