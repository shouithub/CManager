{% extends 'clubs/base.html' %}
{% load custom_filters %}

{% block title %}SMTP邮箱配置{% endblock %}

{% block extra_css %}
<style>
    .smtp-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: var(--md3-spacing-2xl);
        padding-bottom: calc(var(--md3-spacing-2xl) + 80px);
        box-sizing: border-box;
    }
    
    /* 页面标题 */
    .page-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--md3-spacing-md);
        margin-bottom: var(--md3-spacing-2xl);
        flex-wrap: wrap;
    }
    
    .page-header-left {
        display: flex;
        align-items: center;
        gap: var(--md3-spacing-md);
    }
    
    .page-header .material-icons {
        font-size: 2.5rem;
        color: var(--md3-primary);
    }
    
    .page-header h1 {
        margin: 0;
        font-size: 2rem;
        font-weight: 600;
        color: var(--md3-on-surface);
    }
    
    /* 卡片样式 */
    .md3-card {
        background: var(--md3-surface-container);
        border-radius: var(--md3-radius-xl);
        border: 1px solid var(--md3-outline-variant);
        margin-bottom: var(--md3-spacing-xl);
        transition: all var(--md3-motion-duration-short2) var(--md3-motion-easing-standard);
    }
    
    .md3-card-header {
        background: var(--md3-surface-container-high);
        padding: var(--md3-spacing-xl);
        border-bottom: 1px solid var(--md3-outline-variant);
        border-radius: var(--md3-radius-xl) var(--md3-radius-xl) 0 0;
        display: flex;
        align-items: center;
        gap: var(--md3-spacing-md);
    }
    
    .md3-card-header .material-icons {
        font-size: 1.75rem;
        color: var(--md3-primary);
    }
    
    .md3-card-header h2 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--md3-on-surface);
    }
    
    .md3-card-body {
        padding: var(--md3-spacing-xl);
    }
    
    /* 配置列表网格 */
    .config-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: var(--md3-spacing-lg);
    }
    
    /* 配置卡片 */
    .config-card {
        background: var(--md3-surface-container-low);
        border-radius: var(--md3-radius-lg);
        border: 1px solid var(--md3-outline-variant);
        overflow: hidden;
        transition: all var(--md3-motion-duration-short2) var(--md3-motion-easing-standard);
    }
    
    .config-card:hover {
        box-shadow: var(--md3-elevation-2);
    }
    
    .config-card.active .config-card-main {
        border-left: 4px solid var(--md3-success);
        background: var(--md3-success-container);
    }
    
    .config-card-main {
        padding: var(--md3-spacing-lg);
        border-left: 4px solid var(--md3-primary);
        cursor: pointer;
        transition: all var(--md3-motion-duration-short2) var(--md3-motion-easing-standard);
    }
    
    .config-card-main:hover {
        background: var(--md3-surface-container);
    }

    .config-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: var(--md3-spacing-md);
    }
    
    .config-provider {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--md3-on-surface);
        display: flex;
        align-items: center;
        gap: var(--md3-spacing-sm);
    }
    
    .config-provider .material-icons {
        font-size: 1.25rem;
        color: var(--md3-primary);
    }
    
    .config-status {
        display: inline-flex;
        align-items: center;
        gap: var(--md3-spacing-xs);
        padding: var(--md3-spacing-xs) var(--md3-spacing-md);
        border-radius: var(--md3-radius-full);
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .config-status .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: currentColor;
    }
    
    .config-status.active {
        background: var(--md3-success-container);
        color: var(--md3-on-success-container);
    }
    
    .config-status.inactive {
        background: var(--md3-surface-container-highest);
        color: var(--md3-on-surface-variant);
    }
    
    .config-details {
        font-size: 0.875rem;
        color: var(--md3-on-surface-variant);
        line-height: 1.8;
    }
    
    .config-details-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--md3-spacing-xs) 0;
        border-bottom: 1px dashed var(--md3-outline-variant);
    }
    
    .config-details-row:last-child {
        border-bottom: none;
    }
    
    .config-details-label {
        font-weight: 500;
        color: var(--md3-on-surface);
    }
    
    .config-details-value {
        font-family: 'Roboto Mono', monospace;
        font-size: 0.8125rem;
    }
    
    .config-expand-hint {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--md3-spacing-xs);
        margin-top: var(--md3-spacing-md);
        font-size: 0.75rem;
        color: var(--md3-on-surface-variant);
    }
    
    .config-expand-hint .material-icons {
        font-size: 1rem;
        transition: transform var(--md3-motion-duration-short2) var(--md3-motion-easing-standard);
    }
    
    .config-card.expanded .config-expand-hint .material-icons {
        transform: rotate(180deg);
    }
    
    /* 展开的操作区域 */
    .config-actions-panel {
        display: none;
        background: var(--md3-surface-container);
        border-top: 1px solid var(--md3-outline-variant);
        padding: var(--md3-spacing-lg);
    }
    
    .config-card.expanded .config-actions-panel {
        display: block;
    }
    
    .config-actions-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: var(--md3-spacing-md);
        margin-bottom: var(--md3-spacing-lg);
    }
    
    .config-action-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: var(--md3-spacing-sm);
        padding: var(--md3-spacing-lg);
        border-radius: var(--md3-radius-md);
        border: 1px solid var(--md3-outline-variant);
        background: var(--md3-surface);
        cursor: pointer;
        transition: all var(--md3-motion-duration-short2) var(--md3-motion-easing-standard);
    }
    
    .config-action-btn:hover {
        border-color: var(--md3-primary);
        background: var(--md3-primary-container);
    }
    
    .config-action-btn .material-icons {
        font-size: 1.5rem;
        color: var(--md3-primary);
    }
    
    .config-action-btn span:last-child {
        font-size: 0.8125rem;
        font-weight: 500;
        color: var(--md3-on-surface);
    }
    
    .config-action-btn.danger:hover {
        border-color: var(--md3-error);
        background: var(--md3-error-container);
    }
    
    .config-action-btn.danger .material-icons {
        color: var(--md3-error);
    }
    
    .config-action-btn.success:hover {
        border-color: var(--md3-success);
        background: var(--md3-success-container);
    }
    
    .config-action-btn.success .material-icons {
        color: var(--md3-success);
    }
    
    /* 测试邮件区域 */
    .test-email-section {
        padding-top: var(--md3-spacing-md);
        border-top: 1px dashed var(--md3-outline-variant);
    }
    
    .test-email-label {
        font-size: 0.8125rem;
        font-weight: 500;
        color: var(--md3-on-surface);
        margin-bottom: var(--md3-spacing-sm);
        display: block;
    }

    .config-actions {
        display: flex;
        flex-direction: column;
        gap: var(--md3-spacing-sm);
        margin-top: var(--md3-spacing-lg);
        padding-top: var(--md3-spacing-md);
        border-top: 1px solid var(--md3-outline-variant);
    }
    
    .config-actions form {
        width: 100%;
    }
    
    /* 测试邮件表单 */
    .test-email-form {
        margin-bottom: var(--md3-spacing-sm);
    }
    
    .test-email-input-group {
        display: flex;
        gap: var(--md3-spacing-sm);
    }
    
    .test-email-input-group .form-input {
        flex: 1;
        min-width: 0;
    }
    
    .form-input-sm {
        padding: var(--md3-spacing-sm) var(--md3-spacing-md);
        font-size: 0.8125rem;
    }
    
    /* 错误提示 */
    .error-alert {
        background: var(--md3-error-container);
        border-left: 4px solid var(--md3-error);
        color: var(--md3-on-error-container);
        padding: var(--md3-spacing-lg);
        border-radius: var(--md3-radius-md);
        margin-bottom: var(--md3-spacing-xl);
        display: flex;
        gap: var(--md3-spacing-md);
        align-items: flex-start;
    }
    
    .error-alert .material-icons {
        font-size: 1.5rem;
        flex-shrink: 0;
    }
    
    .error-alert ul {
        margin: 0;
        padding-left: var(--md3-spacing-lg);
    }
    
    .error-alert li {
        margin-bottom: var(--md3-spacing-xs);
    }
    
    /* 表单区域 */
    .form-section {
        padding-top: var(--md3-spacing-xl);
        margin-top: var(--md3-spacing-xl);
        border-top: 1px solid var(--md3-outline-variant);
    }
    
    .form-section-header {
        display: flex;
        align-items: center;
        gap: var(--md3-spacing-md);
        margin-bottom: var(--md3-spacing-xl);
    }
    
    .form-section-header .material-icons {
        font-size: 1.5rem;
        color: var(--md3-primary);
    }
    
    .form-section-header h2 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--md3-on-surface);
    }
    
    .form-row {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: var(--md3-spacing-lg);
        margin-bottom: var(--md3-spacing-lg);
    }
    
    .form-row.full {
        grid-template-columns: 1fr;
    }
    
    .form-group {
        margin-bottom: 0;
    }
    
    .form-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--md3-on-surface);
        margin-bottom: var(--md3-spacing-sm);
    }
    
    .form-label .required {
        color: var(--md3-error);
        margin-left: var(--md3-spacing-xs);
    }
    
    .form-input,
    .form-select {
        width: 100%;
        padding: var(--md3-spacing-md) var(--md3-spacing-lg);
        border: 1px solid var(--md3-outline);
        border-radius: var(--md3-radius-md);
        font-size: 0.9375rem;
        background: var(--md3-surface);
        color: var(--md3-on-surface);
        font-family: inherit;
        transition: all var(--md3-motion-duration-short2) var(--md3-motion-easing-standard);
        box-sizing: border-box;
    }
    
    .form-input:focus,
    .form-select:focus {
        outline: none;
        border-color: var(--md3-primary);
        box-shadow: 0 0 0 3px var(--md3-primary-container);
    }
    
    .form-input::placeholder {
        color: var(--md3-on-surface-variant);
    }
    
    .form-helper {
        font-size: 0.75rem;
        color: var(--md3-on-surface-variant);
        margin-top: var(--md3-spacing-xs);
        display: flex;
        align-items: center;
        gap: var(--md3-spacing-xs);
    }
    
    .form-helper .material-icons {
        font-size: 0.875rem;
    }
    
    /* 复选框区域 */
    .checkbox-row {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: var(--md3-spacing-lg);
        margin-bottom: var(--md3-spacing-xl);
    }
    
    .checkbox-group {
        display: flex;
        align-items: center;
        gap: var(--md3-spacing-md);
        padding: var(--md3-spacing-md) var(--md3-spacing-lg);
        border-radius: var(--md3-radius-md);
        background: var(--md3-surface-container-low);
        border: 1px solid var(--md3-outline-variant);
        cursor: pointer;
        transition: all var(--md3-motion-duration-short2) var(--md3-motion-easing-standard);
    }
    
    .checkbox-group:hover {
        background: var(--md3-surface-container);
        border-color: var(--md3-primary);
    }
    
    .checkbox-group input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
        accent-color: var(--md3-primary);
    }
    
    .checkbox-group label {
        margin: 0;
        cursor: pointer;
        font-size: 0.9375rem;
        color: var(--md3-on-surface);
        flex: 1;
    }
    
    /* 按钮区域 */
    .btn-group {
        display: flex;
        gap: var(--md3-spacing-md);
        margin-top: var(--md3-spacing-xl);
        flex-wrap: wrap;
    }
    
    .btn {
        padding: var(--md3-spacing-md) var(--md3-spacing-xl);
        border: none;
        border-radius: var(--md3-radius-full);
        font-size: 0.9375rem;
        font-weight: 500;
        cursor: pointer;
        transition: all var(--md3-motion-duration-short2) var(--md3-motion-easing-standard);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: var(--md3-spacing-sm);
        text-decoration: none;
        min-width: 120px;
    }
    
    .btn .material-icons {
        font-size: 1.125rem;
    }
    
    .btn-primary {
        background: var(--md3-primary);
        color: var(--md3-on-primary);
    }
    
    .btn-primary:hover {
        box-shadow: var(--md3-elevation-2);
        transform: translateY(-1px);
    }
    
    .btn-secondary {
        background: var(--md3-surface-container-highest);
        color: var(--md3-on-surface);
        border: 1px solid var(--md3-outline-variant);
    }
    
    .btn-secondary:hover {
        background: var(--md3-surface-container-high);
    }
    
    .btn-success {
        background: var(--md3-success);
        color: var(--md3-on-success);
    }
    
    .btn-success:hover {
        box-shadow: var(--md3-elevation-2);
    }
    
    .btn-danger {
        background: var(--md3-error);
        color: var(--md3-on-error);
    }
    
    .btn-danger:hover {
        box-shadow: var(--md3-elevation-2);
    }
    
    .btn-sm {
        padding: var(--md3-spacing-sm) var(--md3-spacing-md);
        font-size: 0.8125rem;
        min-width: auto;
    }
    
    .btn-block {
        width: 100%;
    }
    
    /* 编辑弹窗 */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all var(--md3-motion-duration-medium1) var(--md3-motion-easing-standard);
        padding: var(--md3-spacing-lg);
    }
    
    .modal-overlay.active {
        opacity: 1;
        visibility: visible;
    }
    
    .modal-content {
        background: var(--md3-surface-container);
        border-radius: var(--md3-radius-xl);
        max-width: 560px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        transform: scale(0.9) translateY(20px);
        transition: transform var(--md3-motion-duration-medium1) var(--md3-motion-easing-standard);
        box-shadow: var(--md3-elevation-3);
    }
    
    .modal-overlay.active .modal-content {
        transform: scale(1) translateY(0);
    }
    
    .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--md3-spacing-xl);
        border-bottom: 1px solid var(--md3-outline-variant);
        background: var(--md3-surface-container-high);
        border-radius: var(--md3-radius-xl) var(--md3-radius-xl) 0 0;
    }
    
    .modal-header-left {
        display: flex;
        align-items: center;
        gap: var(--md3-spacing-md);
    }
    
    .modal-header .material-icons {
        font-size: 1.5rem;
        color: var(--md3-primary);
    }
    
    .modal-header h3 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--md3-on-surface);
    }
    
    .modal-close {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: none;
        background: transparent;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--md3-on-surface-variant);
        transition: all var(--md3-motion-duration-short2) var(--md3-motion-easing-standard);
    }
    
    .modal-close:hover {
        background: var(--md3-surface-container-highest);
        color: var(--md3-on-surface);
    }
    
    .modal-body {
        padding: var(--md3-spacing-xl);
    }
    
    .modal-footer {
        padding: var(--md3-spacing-lg) var(--md3-spacing-xl);
        border-top: 1px solid var(--md3-outline-variant);
        display: flex;
        gap: var(--md3-spacing-md);
        justify-content: flex-end;
    }

    /* 空状态 */
    .empty-state {
        text-align: center;
        padding: var(--md3-spacing-3xl);
        color: var(--md3-on-surface-variant);
    }
    
    .empty-state .material-icons {
        font-size: 4rem;
        opacity: 0.4;
        margin-bottom: var(--md3-spacing-lg);
    }
    
    .empty-state-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: var(--md3-spacing-sm);
        color: var(--md3-on-surface);
    }
    
    .empty-state-text {
        font-size: 0.9375rem;
        color: var(--md3-on-surface-variant);
        max-width: 400px;
        margin: 0 auto;
    }
    
    /* 响应式设置 */
    @media (max-width: 768px) {
        .smtp-container {
            padding: var(--md3-spacing-lg);
            padding-bottom: calc(var(--md3-spacing-2xl) + 100px);
        }
        
        .page-header {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .page-header h1 {
            font-size: 1.5rem;
        }
        
        .page-header .material-icons {
            font-size: 2rem;
        }
        
        .form-row {
            grid-template-columns: 1fr;
        }
        
        .checkbox-row {
            grid-template-columns: 1fr;
        }
        
        .config-list {
            grid-template-columns: 1fr;
        }
        
        .config-card-header {
            flex-direction: column;
            gap: var(--md3-spacing-sm);
        }
        
        .config-actions-grid {
            grid-template-columns: 1fr 1fr;
        }
        
        .modal-content {
            max-height: 100%;
            border-radius: var(--md3-radius-lg);
        }
        
        .modal-body .form-row {
            grid-template-columns: 1fr;
        }
        
        .modal-footer {
            flex-direction: column-reverse;
        }
        
        .modal-footer .btn {
            width: 100%;
        }

        .btn-group {
            flex-direction: column;
        }
        
        .btn {
            width: 100%;
        }
        
        .md3-card-body {
            padding: var(--md3-spacing-lg);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="smtp-container">
    <!-- 页面标题 -->
    <div class="page-header">
        <div class="page-header-left">
            <span class="material-icons">mail</span>
            <h1>SMTP邮箱配置</h1>
        </div>
        <a href="{% url 'clubs:admin_dashboard' %}" class="btn btn-secondary">
            <span class="material-icons">arrow_back</span>
            返回管理面板
        </a>
    </div>

    {% if errors %}
    <div class="error-alert">
        <span class="material-icons">error</span>
        <div>
            <strong style="display: block; margin-bottom: 8px;">配置错误</strong>
            <ul>
                {% for error in errors %}
                <li>{{ error }}</li>
                {% endfor %}
            </ul>
        </div>
    </div>
    {% endif %}

    <!-- 现有配置列表 -->
    {% if configs %}
    <div class="md3-card">
        <div class="md3-card-header">
            <span class="material-icons">dns</span>
            <h2>已有配置</h2>
        </div>
        <div class="md3-card-body">
            <div class="config-list">
                {% for config in configs %}
                <div class="config-card {% if config.is_active %}active{% endif %}" data-config-id="{{ config.id }}">
                    <div class="config-card-main" onclick="toggleConfigCard(this)">
                        <div class="config-card-header">
                            <span class="config-provider">
                                <span class="material-icons">email</span>
                                {{ config.get_provider_display }}
                            </span>
                            <span class="config-status {% if config.is_active %}active{% else %}inactive{% endif %}">
                                <span class="status-dot"></span>
                                {% if config.is_active %}激活中{% else %}未激活{% endif %}
                            </span>
                        </div>
                        <div class="config-details">
                            <div class="config-details-row">
                                <span class="config-details-label">服务地址</span>
                                <span class="config-details-value">{{ config.smtp_host }}:{{ config.smtp_port }}</span>
                            </div>
                            <div class="config-details-row">
                                <span class="config-details-label">邮箱</span>
                                <span class="config-details-value">{{ config.sender_email }}</span>
                            </div>
                            <div class="config-details-row">
                                <span class="config-details-label">加密</span>
                                <span class="config-details-value">{% if config.use_tls %}TLS{% else %}无{% endif %}</span>
                            </div>
                        </div>
                        <div class="config-expand-hint">
                            <span class="material-icons">expand_more</span>
                            <span>点击展开操作</span>
                        </div>
                    </div>
                    <div class="config-actions-panel">
                        <div class="config-actions-grid">
                            <button type="button" class="config-action-btn" 
                                    onclick="openEditModal({{ config.id }}, '{{ config.provider }}', '{{ config.smtp_host }}', {{ config.smtp_port }}, '{{ config.sender_email }}', {{ config.use_tls|yesno:'true,false' }})">
                                <span class="material-icons">edit</span>
                                <span>编辑配置</span>
                            </button>
                            {% if not config.is_active %}
                            <form method="post" style="display: contents;">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="activate">
                                <input type="hidden" name="config_id" value="{{ config.id }}">
                                <button type="submit" class="config-action-btn success">
                                    <span class="material-icons">check_circle</span>
                                    <span>激活此配置</span>
                                </button>
                            </form>
                            {% else %}
                            <div class="config-action-btn" style="opacity: 0.5; cursor: default;">
                                <span class="material-icons" style="color: var(--md3-success);">verified</span>
                                <span>当前已激活</span>
                            </div>
                            {% endif %}
                            <form method="post" style="display: contents;" onsubmit="return confirm('确定要删除此配置吗？此操作不可撤销');">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="delete">
                                <input type="hidden" name="config_id" value="{{ config.id }}">
                                <button type="submit" class="config-action-btn danger">
                                    <span class="material-icons">delete</span>
                                    <span>删除配置</span>
                                </button>
                            </form>
                            <div class="config-action-btn" onclick="toggleTestEmail(this)">
                                <span class="material-icons">send</span>
                                <span>发送测试邮件</span>
                            </div>
                        </div>
                        <div class="test-email-section" style="display: none;">
                            <label class="test-email-label">发送测试邮件</label>
                            <form method="post" class="test-email-form">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="test_email">
                                <input type="hidden" name="config_id" value="{{ config.id }}">
                                <div class="test-email-input-group">
                                    <input type="email" name="test_email" class="form-input form-input-sm" 
                                           placeholder="输入接收测试邮件的邮箱地址" required>
                                    <button type="submit" class="btn btn-primary btn-sm">
                                        <span class="material-icons">send</span>
                                        发送
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% else %}
    <div class="md3-card">
        <div class="md3-card-body">
            <div class="empty-state">
                <span class="material-icons">mail_outline</span>
                <div class="empty-state-title">暂无SMTP配置</div>
                <p class="empty-state-text">请创建一个新的SMTP配置以启用邮件发送功能。</p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- 创建新配置表单 -->
    <div class="md3-card">
        <div class="md3-card-header">
            <span class="material-icons">add_circle</span>
            <h2>创建新的SMTP配置</h2>
        </div>
        <div class="md3-card-body">
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="create">

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="provider">
                            邮箱服务 <span class="required">*</span>
                        </label>
                        <select class="form-select" id="provider" name="provider" required 
                                onchange="fillSmtpDefaults(this.value)">
                            <option value="">-- 请选择 --</option>
                            <option value="qq">QQ邮箱</option>
                            <option value="163">163邮箱</option>
                            <option value="outlook">Outlook</option>
                            <option value="gmail">Gmail</option>
                            <option value="custom">自定义</option>
                        </select>
                        <div class="form-helper">
                            <span class="material-icons">info</span>
                            选择邮箱服务商后将自动填充相应配置
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="sender_email">
                            发送邮箱地址<span class="required">*</span>
                        </label>
                        <input type="email" class="form-input" id="sender_email" name="sender_email" 
                               value="{{ form_data.sender_email }}" required
                               placeholder="example@qq.com">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="smtp_host">
                            SMTP服务器地址<span class="required">*</span>
                        </label>
                        <input type="text" class="form-input" id="smtp_host" name="smtp_host" 
                               value="{{ form_data.smtp_host }}" required
                               placeholder="smtp.qq.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="smtp_port">
                            SMTP端口<span class="required">*</span>
                        </label>
                        <input type="number" class="form-input" id="smtp_port" name="smtp_port" 
                               value="{{ form_data.smtp_port }}" required
                               placeholder="587" min="1" max="65535">
                    </div>
                </div>

                <div class="form-row full">
                    <div class="form-group">
                        <label class="form-label" for="sender_password">
                            邮箱密码/授权码 <span class="required">*</span>
                        </label>
                        <input type="password" class="form-input" id="sender_password" name="sender_password" required
                               placeholder="请输入邮箱密码或授权码">
                        <div class="form-helper">
                            <span class="material-icons">info</span>
                            某些邮箱需要使用授权码而非密码（如QQ邮箱需16位授权码）
                        </div>
                    </div>
                </div>

                <div class="checkbox-row">
                    <div class="checkbox-group">
                        <input type="checkbox" id="use_tls" name="use_tls" 
                               {% if form_data.use_tls or not form_data %}checked{% endif %}>
                        <label for="use_tls">使用TLS加密</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="is_active" name="is_active">
                        <label for="is_active">创建后立即激活</label>
                    </div>
                </div>

                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">
                        <span class="material-icons">check</span>
                        创建配置
                    </button>
                    <a href="{% url 'clubs:admin_dashboard' %}" class="btn btn-secondary">
                        <span class="material-icons">arrow_back</span>
                        返回
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function fillSmtpDefaults(provider) {
    const defaults = {
        qq: {
            smtp_host: 'smtp.qq.com',
            smtp_port: 587
        },
        163: {
            smtp_host: 'smtp.163.com',
            smtp_port: 994
        },
        outlook: {
            smtp_host: 'smtp-mail.outlook.com',
            smtp_port: 587
        },
        gmail: {
            smtp_host: 'smtp.gmail.com',
            smtp_port: 587
        }
    };

    if (defaults[provider]) {
        document.getElementById('smtp_host').value = defaults[provider].smtp_host;
        document.getElementById('smtp_port').value = defaults[provider].smtp_port;
    }
}

// 配置卡片展开/收起
function toggleConfigCard(element) {
    const card = element.closest('.config-card');
    const wasExpanded = card.classList.contains('expanded');
    
    // 先收起所有卡片
    document.querySelectorAll('.config-card.expanded').forEach(c => {
        c.classList.remove('expanded');
    });
    
    // 如果之前未展开，则展开当前卡片
    if (!wasExpanded) {
        card.classList.add('expanded');
    }
}

// 切换测试邮件区域
function toggleTestEmail(element) {
    const panel = element.closest('.config-actions-panel');
    const testSection = panel.querySelector('.test-email-section');
    const isVisible = testSection.style.display !== 'none';
    testSection.style.display = isVisible ? 'none' : 'block';
    if (!isVisible) {
        testSection.querySelector('input[type="email"]').focus();
    }
}

// 打开编辑弹窗
function openEditModal(id, provider, host, port, email, useTls) {
    const modal = document.getElementById('editModal');
    document.getElementById('edit_config_id').value = id;
    document.getElementById('edit_provider').value = provider;
    document.getElementById('edit_smtp_host').value = host;
    document.getElementById('edit_smtp_port').value = port;
    document.getElementById('edit_sender_email').value = email;
    document.getElementById('edit_use_tls').checked = useTls;
    document.getElementById('edit_sender_password').value = '';
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
}

// 关闭编辑弹窗
function closeEditModal() {
    const modal = document.getElementById('editModal');
    modal.classList.remove('active');
    document.body.style.overflow = '';
}

// 点击遮罩关闭弹窗
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('editModal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeEditModal();
            }
        });
    }
    
    // ESC关闭弹窗
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeEditModal();
        }
    });
});

// 编辑表单中的服务商变更时填充默认值
function fillEditSmtpDefaults(provider) {
    const defaults = {
        qq: { smtp_host: 'smtp.qq.com', smtp_port: 587 },
        163: { smtp_host: 'smtp.163.com', smtp_port: 994 },
        outlook: { smtp_host: 'smtp-mail.outlook.com', smtp_port: 587 },
        gmail: { smtp_host: 'smtp.gmail.com', smtp_port: 587 }
    };

    if (defaults[provider]) {
        document.getElementById('edit_smtp_host').value = defaults[provider].smtp_host;
        document.getElementById('edit_smtp_port').value = defaults[provider].smtp_port;
    }
}
</script>

<!-- 编辑配置弹窗 -->
<div class="modal-overlay" id="editModal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-header-left">
                <span class="material-icons">edit</span>
                <h3>编辑SMTP配置</h3>
            </div>
            <button type="button" class="modal-close" onclick="closeEditModal()">
                <span class="material-icons">close</span>
            </button>
        </div>
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="edit">
            <input type="hidden" name="config_id" id="edit_config_id">
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="edit_provider">
                            邮箱服务 <span class="required">*</span>
                        </label>
                        <select class="form-select" id="edit_provider" name="provider" required
                                onchange="fillEditSmtpDefaults(this.value)">
                            <option value="">-- 请选择 --</option>
                            <option value="qq">QQ邮箱</option>
                            <option value="163">163邮箱</option>
                            <option value="outlook">Outlook</option>
                            <option value="gmail">Gmail</option>
                            <option value="custom">自定义</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="edit_sender_email">
                            发送邮箱地址<span class="required">*</span>
                        </label>
                        <input type="email" class="form-input" id="edit_sender_email" name="sender_email" required
                               placeholder="example@qq.com">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="edit_smtp_host">
                            SMTP服务器地址<span class="required">*</span>
                        </label>
                        <input type="text" class="form-input" id="edit_smtp_host" name="smtp_host" required
                               placeholder="smtp.qq.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="edit_smtp_port">
                            SMTP端口<span class="required">*</span>
                        </label>
                        <input type="number" class="form-input" id="edit_smtp_port" name="smtp_port" required
                               placeholder="587" min="1" max="65535">
                    </div>
                </div>

                <div class="form-row full">
                    <div class="form-group">
                        <label class="form-label" for="edit_sender_password">
                            邮箱密码/授权码
                        </label>
                        <input type="password" class="form-input" id="edit_sender_password" name="sender_password"
                               placeholder="留空则保持原密码不变">
                        <div class="form-helper">
                            <span class="material-icons">info</span>
                            如不需要修改密码，请留空此
                        </div>
                    </div>
                </div>

                <div class="checkbox-row" style="margin-bottom: 0;">
                    <div class="checkbox-group">
                        <input type="checkbox" id="edit_use_tls" name="use_tls">
                        <label for="edit_use_tls">使用TLS加密</label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeEditModal()">
                    <span class="material-icons">close</span>
                    取消
                </button>
                <button type="submit" class="btn btn-primary">
                    <span class="material-icons">save</span>
                    保存修改
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}
