{% extends 'clubs/base.html' %}

{% block title %}å¹´å®¡è®°å½• - {{ club.name }}{% endblock %}

{% block extra_css %}
<style>
    .page-header {
        display: flex;
        align-items: center;
        gap: var(--md3-spacing-md);
        margin-bottom: var(--md3-spacing-2xl);
        padding: var(--md3-spacing-xl);
        background: var(--md3-surface-container-low);
        border-radius: var(--md3-radius-lg);
    }
    
    .page-header .material-icons {
        font-size: 2.5rem;
        color: var(--md3-primary);
    }
    
    .page-header h1 {
        margin: 0;
        font-size: 2rem;
        font-weight: 600;
        color: var(--md3-on-surface);
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <span class="material-icons">assignment</span>
    <h1>å¹´å®¡è®°å½• - {{ club.name }}</h1>
</div>

<div class="card">
    <div class="card-header">
        <h3>æäº¤å†å²</h3>
    </div>

    {% if submissions %}
    <div class="submissions-container">
        {% for submission in submissions %}
        <div class="year-submission">
            <h4>{{ submission.submission_year }} å¹´å¹´å®¡</h4>
            
            <div class="info-row">
                <div>
                    <strong>æäº¤æ—¶é—´:</strong> {{ submission.submitted_at|date:"Y-m-d H:i" }}
                </div>
                <div>
                    <strong>æäº¤æ¬¡æ•°:</strong> 
                    ç¬¬ {{ submission.resubmission_attempt }} æ¬¡
                    {% if submission.resubmission_attempt > 1 %}
                        <span style="color: var(--md3-error); font-weight: 500;">(å·²é‡æ–°æäº¤)</span>
                    {% endif %}
                </div>
                <div>
                    <strong>çŠ¶æ€:</strong> 
                    <span class="status-badge {{ submission.status }}">
                        {{ submission.get_status_display }}
                    </span>
                </div>
                {% if submission.reviewed_at %}
                <div>
                    <strong>æœ€ç»ˆå®¡æ ¸æ—¶é—´:</strong> {{ submission.reviewed_at|date:"Y-m-d H:i" }}
                </div>
                {% endif %}
                {% if submission.status == 'approved' or submission.status == 'rejected' %}
                <div>
                    <strong>å·²è¯»çŠ¶æ€:</strong> 
                    <span class="status-read {% if submission.is_read_by_president %}read{% else %}unread{% endif %}">
                        {% if submission.is_read_by_president %}å·²è¯»{% else %}æœªè¯»{% endif %}
                    </span>
                </div>
                {% endif %}
                {% if submission.status == 'pending' %}
                <div>
                    <form action="{% url 'clubs:cancel_submission' submission.id %}" method="post" onsubmit="return confirm('ç¡®å®šè¦å–æ¶ˆæ­¤å¹´å®¡è¯·æ±‚å—ï¼Ÿæ‰€æœ‰å·²ä¸Šä¼ çš„æ–‡ä»¶å°†è¢«åˆ é™¤ï¼Œæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-error">
                            âŒ å–æ¶ˆæäº¤
                        </button>
                    </form>
                </div>
                {% endif %}
            </div>
            
            <!-- å®¡æ ¸è®°å½•å¡ç‰‡æ¨ªå‘æ’åˆ— -->
            {% if submission.reviews.all %}
            <div class="reviews-section" style="margin-bottom: 20px;">
                <p style="margin-bottom: 10px; font-weight: bold;">å®¡æ ¸è®°å½•:</p>
                <div class="reviews-grid" style="display: flex; flex-wrap: wrap; gap: 15px;">
                    {% for review in submission.reviews.all %}
                    <div class="review-card" style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #e9ecef; min-width: 220px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <span style="font-weight: bold; font-size: 14px;">{% if review.reviewer %}{{ review.reviewer.profile.get_full_name }}{% else %}æœªè®¾ç½®{% endif %}</span>
                            <span style="font-size: 12px; color: #666;">{{ review.reviewed_at|date:"Y-m-d H:i" }}</span>
                        </div>
                        <div style="font-size: 12px; background-color: {% if review.status == 'approved' %}#d4edda{% elif review.status == 'rejected' %}#f8d7da{% else %}#e9ecef{% endif %}; color: {% if review.status == 'approved' %}#155724{% elif review.status == 'rejected' %}#721c24{% else %}#495057{% endif %}; padding: 2px 6px; border-radius: 3px; display: inline-block;">
                            {% if review.status == 'approved' %}é€šè¿‡{% elif review.status == 'rejected' %}æ‹’ç»{% else %}{{ review.status }}{% endif %}
                        </div>
                        {% if review.comment %}
                        <div style="margin-top: 5px; font-size: 14px; color: #555;">{{ review.comment }}</div>
                        {% endif %}
                        
                        <!-- æ˜¾ç¤ºè¢«æ‹’ç»çš„ææ–™ -->
                        {% if review.status == 'rejected' and review.rejected_materials %}
                        <div style="margin-top: 10px; padding: 10px; background-color: #f8f9fa; border: 1px solid #f8d7da; border-radius: 4px;">
                            <div style="margin-bottom: 8px; font-weight: bold; color: #721c24; font-size: 14px;">
                                <span class="material-icons" style="vertical-align: middle; font-size: 1em;">warning</span> è¢«æ‹’ç»çš„ææ–™:
                            </div>
                            <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px;">
                                {% for material in review.rejected_materials %}
                                <span style="font-size: 12px; background-color: #f8d7da; color: #721c24; padding: 3px 8px; border-radius: 3px;">
                                    {% if material == 'self_assessment_form' %}è‡ªæŸ¥è¡¨{% endif %}
                                    {% if material == 'club_constitution' %}ç¤¾å›¢ç« ç¨‹{% endif %}
                                    {% if material == 'leader_learning_work_report' %}è´Ÿè´£äººå­¦ä¹ åŠå·¥ä½œæƒ…å†µè¡¨{% endif %}
                                    {% if material == 'annual_activity_list' %}ç¤¾å›¢å¹´åº¦æ´»åŠ¨æ¸…å•{% endif %}
                                    {% if material == 'advisor_performance_report' %}æŒ‡å¯¼æ•™å¸ˆå±¥èŒæƒ…å†µè¡¨{% endif %}
                                    {% if material == 'financial_report' %}å¹´åº¦è´¢åŠ¡æƒ…å†µè¡¨{% endif %}
                                    {% if material == 'member_composition_list' %}ç¤¾å›¢æˆå‘˜æ„æˆè¡¨{% endif %}
                                    {% if material == 'new_media_account_report' %}æ–°åª’ä½“è´¦å·åŠè¿ç»´æƒ…å†µè¡¨{% endif %}
                                    {% if material == 'other_materials' %}å…¶ä»–ææ–™{% endif %}
                                </span>
                                {% endfor %}
                            </div>
                            <!-- é‡æ–°æäº¤æŒ‰é’® -->
                            <div style="text-align: right;">
                                    <a href="{% url 'clubs:submit_review' club.id %}?resubmit={{ submission.id }}" class="btn btn-danger btn-sm">
                                        ğŸ”„ æ›´æ”¹å¹¶é‡æ–°æäº¤
                                    </a>
                                </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- ä¸‹è½½æŒ‰é’®æ¨ªå‘æ’åˆ— -->
            <div class="download-buttons" style="display: flex; gap: 10px; flex-wrap: wrap;">
                <!-- æŒ‰ç…§è¦æ±‚çš„é¡ºåºæ˜¾ç¤ºææ–™ -->
                {% if submission.self_assessment_form %}
                <a href="{{ submission.self_assessment_form.url }}" class="btn btn-primary" download>
                    <span class="material-icons" style="vertical-align: middle;">assignment</span> è‡ªæŸ¥è¡¨
                </a>
                {% endif %}
                {% if submission.club_constitution %}
                <a href="{{ submission.club_constitution.url }}" class="btn btn-primary" download>
                    ğŸ“‘ ç¤¾å›¢ç« ç¨‹
                </a>
                {% endif %}
                {% if submission.leader_learning_work_report %}
                <a href="{{ submission.leader_learning_work_report.url }}" class="btn btn-primary" download>
                    <span class="material-icons">person</span> è´Ÿè´£äººå­¦ä¹ åŠå·¥ä½œæƒ…å†µè¡¨
                </a>
                {% endif %}
                {% if submission.annual_activity_list %}
                <a href="{{ submission.annual_activity_list.url }}" class="btn btn-primary" download>
                    ğŸ“… ç¤¾å›¢å¹´åº¦æ´»åŠ¨æ¸…å•
                </a>
                {% endif %}
                {% if submission.advisor_performance_report %}
                <a href="{{ submission.advisor_performance_report.url }}" class="btn btn-primary" download>
                    <span class="material-icons">school</span> æŒ‡å¯¼æ•™å¸ˆå±¥èŒæƒ…å†µè¡¨
                </a>
                {% endif %}
                {% if submission.financial_report %}
                <a href="{{ submission.financial_report.url }}" class="btn btn-primary" download>
                    <span class="material-icons" style="vertical-align: middle;">attach_money</span> å¹´åº¦è´¢åŠ¡æƒ…å†µè¡¨
                </a>
                {% endif %}
                {% if submission.member_composition_list %}
                <a href="{{ submission.member_composition_list.url }}" class="btn btn-primary" download>
                    <span class="material-icons" style="vertical-align: middle;">group</span> ç¤¾å›¢æˆå‘˜æ„æˆè¡¨
                </a>
                {% endif %}
                {% if submission.new_media_account_report %}
                <a href="{{ submission.new_media_account_report.url }}" class="btn btn-primary" download>
                    ğŸ“± æ–°åª’ä½“è´¦å·åŠè¿ç»´æƒ…å†µè¡¨
                </a>
                {% endif %}
                {% if submission.other_materials %}
                <a href="{{ submission.other_materials.url }}" class="btn btn-primary" download>
                    ğŸ“¦ å…¶ä»–ææ–™
                </a>
                {% endif %}
                
                <!-- åˆå¹¶ä¸‹è½½å’ŒZIPæ‰“åŒ…ä¸‹è½½æŒ‰é’® -->
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px dashed #ddd; width: 100%;">

                    <a href="{% url 'clubs:zip_review_docs' submission.id %}" class="btn btn-primary" style="margin-bottom: 10px; width: 100%;">
                        ğŸ—œï¸ æ‰“åŒ…æ‰€æœ‰ææ–™ä¸ºZIPæ–‡ä»¶
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p style="color: #666; padding: 20px; text-align: center;">æš‚æ— å¹´å®¡æäº¤è®°å½•</p>
    {% endif %}

    <div style="margin-top: 20px;">
        <a href="{% url 'clubs:user_dashboard' %}" class="btn btn-primary">è¿”å›</a>
    </div>
</div>
{% endblock %}
