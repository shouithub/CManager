{% extends 'clubs/base.html' %}

{% block title %}用户仪表板{% endblock %}

{% block extra_css %}
<style>
@media (max-width: 900px) {
    a.btn.btn-primary .see-detail-text {
        display: none !important;
    }
}
    .dashboard-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: var(--md3-spacing-2xl);
        box-sizing: border-box;
        overflow-x: hidden;
    }
    
    /* 页面标题 */
    .dashboard-title {
        display: flex !important;
        flex-direction: row !important;
        align-items: center !important;
        justify-content: space-between !important;
        gap: var(--md3-spacing-md);
        margin-bottom: var(--md3-spacing-lg);
        width: 100%;
    }
    
    .dashboard-title .material-icons {
        font-size: 2.5rem;
        color: var(--md3-primary);
        flex-shrink: 0;
        display: inline-block !important;
    }
    
    .dashboard-title h1 {
        margin: 0;
        font-size: 2rem;
        font-weight: 600;
        color: var(--md3-on-surface);
        white-space: nowrap !important;
        writing-mode: horizontal-tb !important;
        text-orientation: mixed;
        display: inline-block !important;
    }
    
    .dashboard-subtitle {
        color: var(--md3-on-surface-variant);
        font-size: 1rem;
        margin-bottom: var(--md3-spacing-2xl);
    }
    
    /* 未读通知卡片 */
    .unread-alert {
        background: var(--md3-error-container);
        color: var(--md3-on-error-container);
        padding: var(--md3-spacing-xl);
        border-radius: var(--md3-radius-xl);
        margin-bottom: var(--md3-spacing-2xl);
        display: flex;
        align-items: center;
        gap: var(--md3-spacing-lg);
        border: 1px solid var(--md3-error);
    }
    
    .unread-alert .material-icons {
        font-size: 2rem;
    }
    
                <a href="{% url 'clubs:approval_center' 'annual_review' %}" class="btn btn-primary">
                    <span class="material-icons">visibility</span>
                    <span class="see-detail-text">查看详情</span>
                </a>
    
    .unread-alert-content h3 {
        margin: 0 0 var(--md3-spacing-sm) 0;
        font-size: 1.25rem;
    }
    
    .unread-alert-content p {
        margin: 0;
    }
    
    /* 社团卡片网格 */
    .clubs-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
        gap: var(--md3-spacing-xl);
        margin-bottom: var(--md3-spacing-2xl);
    }
    
    .club-card {
        background: var(--md3-surface-container);
        border-radius: var(--md3-radius-xl);
        padding: var(--md3-spacing-xl);
        border: 1px solid var(--md3-outline-variant);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .club-card:hover {
        background: var(--md3-surface-container-high);
        box-shadow: var(--md3-elevation-2);
        transform: translateY(-4px);
    }
    
    .club-card-header {
        display: flex;
        align-items: center;
        gap: var(--md3-spacing-md);
        margin-bottom: var(--md3-spacing-lg);
        padding-bottom: var(--md3-spacing-md);
        border-bottom: 1px solid var(--md3-outline-variant);
    }
    
    .club-card-header .material-icons {
        font-size: 2rem;
        color: var(--md3-primary);
    }
    
    .club-card-header h3 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--md3-on-surface);
    }
    
    .club-info-item {
        display: flex;
        align-items: flex-start;
        gap: var(--md3-spacing-md);
        margin-bottom: var(--md3-spacing-md);
    }
    
    .club-info-item .material-icons {
        font-size: 1.25rem;
        color: var(--md3-primary);
        margin-top: 2px;
    }
    
    .club-info-content {
        flex: 1;
    }
    
    .club-info-label {
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--md3-on-surface-variant);
        margin-bottom: var(--md3-spacing-xs);
    }
    
    .club-info-value {
        font-size: 1rem;
        color: var(--md3-on-surface);
    }
    
    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: var(--md3-spacing-xs);
        padding: var(--md3-spacing-xs) var(--md3-spacing-sm);
        border-radius: var(--md3-radius-sm);
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .status-badge.success {
        background: var(--md3-success-container);
        color: var(--md3-on-success-container);
    }
    
    .status-badge.pending {
        background: var(--md3-warning-container);
        color: var(--md3-on-warning-container);
    }
    
    .status-badge .material-icons {
        font-size: 1rem;
    }
    
    .staff-list {
        display: flex;
        flex-direction: column;
        gap: var(--md3-spacing-sm);
    }
    
    .staff-item {
        padding: var(--md3-spacing-sm);
        background: var(--md3-surface-container-highest);
        border-radius: var(--md3-radius-md);
        font-size: 0.875rem;
    }
    
    .staff-name {
        color: var(--md3-primary);
        font-weight: 600;
    }
    
    /* 快捷操作按钮 */
    .quick-actions {
        margin-top: var(--md3-spacing-lg);
        padding-top: var(--md3-spacing-lg);
        border-top: 1px solid var(--md3-outline-variant);
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: var(--md3-spacing-md);
    }
    
    .quick-actions .btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--md3-spacing-xs);
        padding: var(--md3-spacing-md);
        font-size: 0.875rem;
        text-decoration: none;
    }
    
    .quick-actions .btn .material-icons {
        font-size: 1.125rem;
    }
    
    /* 未读审核结果区域 */
    .unread-reviews-section {
        margin-top: var(--md3-spacing-2xl);
    }
    
    .section-header {
        display: flex;
        align-items: center;
        gap: var(--md3-spacing-md);
        margin-bottom: var(--md3-spacing-xl);
        padding: var(--md3-spacing-lg);
        background: var(--md3-surface-container-low);
        border-radius: var(--md3-radius-lg);
    }
    
    .section-header .material-icons {
        font-size: 1.75rem;
        color: var(--md3-primary);
    }
    
    .section-header h2 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--md3-on-surface);
    }
    
    .reviews-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: var(--md3-spacing-lg);
    }
    
    .review-card {
        background: var(--md3-surface-container);
        border-radius: var(--md3-radius-lg);
        padding: var(--md3-spacing-lg);
        border: 1px solid var(--md3-outline-variant);
    }
    
    .review-card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: var(--md3-spacing-md);
    }
    
    .review-card-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--md3-on-surface);
        margin: 0;
    }
    
    .review-info {
        display: flex;
        flex-direction: column;
        gap: var(--md3-spacing-sm);
        margin-bottom: var(--md3-spacing-md);
    }
    
    .review-info-item {
        display: flex;
        justify-content: space-between;
        font-size: 0.875rem;
    }
    
    .review-info-label {
        color: var(--md3-on-surface-variant);
    }
    
    .review-info-value {
        color: var(--md3-on-surface);
        font-weight: 500;
    }
    
    /* 空状态 */
    .empty-state {
        text-align: center;
        padding: var(--md3-spacing-3xl);
        background: var(--md3-surface-container-low);
        border-radius: var(--md3-radius-xl);
        color: var(--md3-on-surface-variant);
    }
    
    .empty-state .material-icons {
        font-size: 4rem;
        opacity: 0.5;
        margin-bottom: var(--md3-spacing-lg);
    }
    
    /* 响应式设计 */
    @media (max-width: 900px) {
        .dashboard-container {
            padding: var(--md3-spacing-lg);
            overflow-x: hidden;
        }
        
        .dashboard-title {
            flex-direction: row;
            justify-content: flex-start;
            margin-bottom: var(--md3-spacing-md);
            width: 100%;
        }
        
        .dashboard-title .material-icons {
            font-size: 2rem;
        }
        
        .dashboard-title h1 {
            font-size: 1.25rem;
            white-space: nowrap;
            writing-mode: horizontal-tb;
        }
        
        .clubs-grid {
            grid-template-columns: 1fr;
        }
        
        .reviews-grid {
            grid-template-columns: 1fr;
        }
        
        .quick-actions {
            grid-template-columns: 1fr;
        }
    }
</style>
<style>
@media (max-width: 900px) {
    .see-detail-text {
        display: none !important;
    }
}
</style>
<style>
@media (max-width: 900px) {
    .see-detail-text {
        display: none !important;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- 页面标题 -->
    <div class="dashboard-title">
        <div style="display: flex; align-items: center; gap: var(--md3-spacing-md);">
            <span class="material-icons">dashboard</span>
            <h1>我的社团</h1>
        </div>
        <div style="margin-left: auto;">
            <a href="{% url 'clubs:register_club' %}" class="btn btn-primary">
                创建新社团
            </a>
        </div>
    </div>
    <p class="dashboard-subtitle">欢迎 {{ user.profile.get_full_name }}，以下是您的社团管理信息</p>

    <!-- 未读通知 -->
    {% if unread_approval_counts.total > 0 %}
    <div class="unread-alert">
        <span class="material-icons">notifications_active</span>
        <div class="unread-alert-content">
            <h3>未读通知</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--md3-spacing-md);">
                {% if unread_approval_counts.annual_review > 0 %}
                <div style="display: flex; align-items: center; gap: var(--md3-spacing-xs);">
                    <span class="material-icons" style="font-size: 1.25rem;">assignment</span>
                    <span>年审: <strong>{{ unread_approval_counts.annual_review }}</strong></span>
                </div>
                {% endif %}
                {% if unread_approval_counts.registration > 0 %}
                <div style="display: flex; align-items: center; gap: var(--md3-spacing-xs);">
                    <span class="material-icons" style="font-size: 1.25rem;">add_circle</span>
                    <span>注册: <strong>{{ unread_approval_counts.registration }}</strong></span>
                </div>
                {% endif %}
                {% if unread_approval_counts.application > 0 %}
                <div style="display: flex; align-items: center; gap: var(--md3-spacing-xs);">
                    <span class="material-icons" style="font-size: 1.25rem;">description</span>
                    <span>申请: <strong>{{ unread_approval_counts.application }}</strong></span>
                </div>
                {% endif %}
                {% if unread_approval_counts.reimbursement > 0 %}
                <div style="display: flex; align-items: center; gap: var(--md3-spacing-xs);">
                    <span class="material-icons" style="font-size: 1.25rem;">receipt</span>
                    <span>报销: <strong>{{ unread_approval_counts.reimbursement }}</strong></span>
                </div>
                {% endif %}
                {% if unread_approval_counts.activity > 0 %}
                <div style="display: flex; align-items: center; gap: var(--md3-spacing-xs);">
                    <span class="material-icons" style="font-size: 1.25rem;">event</span>
                    <span>活动: <strong>{{ unread_approval_counts.activity }}</strong></span>
                </div>
                {% endif %}
                {% if unread_approval_counts.transition > 0 %}
                <div style="display: flex; align-items: center; gap: var(--md3-spacing-xs);">
                    <span class="material-icons" style="font-size: 1.25rem;">swap_horiz</span>
                    <span>换届: <strong>{{ unread_approval_counts.transition }}</strong></span>
                </div>
                {% endif %}
            </div>
        </div>
        <a href="{% url 'clubs:approval_center' 'annual_review' %}" class="btn btn-primary">
            <span class="material-icons">visibility</span>
            <span class="see-detail-text">查看详情</span>
        </a>
    </div>
    {% endif %}

    <!-- 我的社团 -->
    <div class="section-header">
        <span class="material-icons">school</span>
        <h2>我的社团 ({{ club_count }})</h2>
    </div>
    
    {% if clubs_with_submission_status %}
    <div class="clubs-grid">
        {% for club_data in clubs_with_submission_status %}
        <div class="club-card">
            <div class="club-card-header">
                <span class="material-icons">flag</span>
                <h3>{{ club_data.club.name }}</h3>
            </div>
            
            {% if club_data.review_enabled %}
            <div class="club-info-item">
                <span class="material-icons">assignment</span>
                <div class="club-info-content">
                    <div class="club-info-label">年审状态</div>
                    <div class="club-info-value">
                        {% if club_data.has_submitted_review %}
                        <span class="status-badge success">
                            <span class="material-icons">check_circle</span> 已提交
                        </span>
                        {% else %}
                        <span class="status-badge pending">
                            <span class="material-icons">schedule</span> 未提交
                        </span>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% if club_data.registration_enabled %}
            <div class="club-info-item">
                <span class="material-icons">add_circle</span>
                <div class="club-info-content">
                    <div class="club-info-label">社团注册</div>
                    <div class="club-info-value">
                        {% if club_data.has_submitted_registration %}
                        <span class="status-badge success">
                            <span class="material-icons">check_circle</span> 已提交
                        </span>
                        {% else %}
                        <span class="status-badge pending">
                            <span class="material-icons">schedule</span> 未提交
                        </span>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
            
            <div class="club-info-item">
                <span class="material-icons">person</span>
                <div class="club-info-content">
                    <div class="club-info-label">负责干事</div>
                    <div class="club-info-value">
                        {% if club_data.assigned_staff %}
                        <div class="staff-list">
                            {% for staff in club_data.assigned_staff %}
                            <div class="staff-item">
                                <span class="staff-name">{{ staff.name|default:'未设置' }}</span><br>
                                电话: {{ staff.phone }} | 微信: {{ staff.wechat }}<br>
                                <small>分配时间: {{ staff.assigned_at|date:"Y-m-d" }}</small>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <span style="color: var(--md3-on-surface-variant);">暂未分配</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="club-info-item">
                <span class="material-icons">notifications</span>
                <div class="club-info-content">
                    <div class="club-info-label">未读审核</div>
                    <div class="club-info-value">
                        {% if club_data.unread_submissions_count > 0 %}
                        <span class="status-badge pending">{{ club_data.unread_submissions_count }} 条</span>
                        {% else %}
                        <span class="status-badge success">0 条</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="quick-actions">
                <a href="{% url 'clubs:club_detail' club_data.club.id %}" class="btn btn-outlined">
                    <span class="material-icons">info</span> 详情
                </a>
                {% if club_data.club.review_enabled %}
                    {% if club_data.has_submitted_review %}
                    <span class="btn btn-outlined" style="opacity: 0.6; cursor: not-allowed;">
                        <span class="material-icons">check_circle</span> 年审已提交
                    </span>
                    {% else %}
                    <a href="{% url 'clubs:submit_review' club_data.club.id %}" class="btn btn-success">
                        <span class="material-icons">assignment</span> 年审
                    </a>
                    {% endif %}
                {% else %}
                <span class="btn btn-outlined" style="opacity: 0.5; cursor: not-allowed;" title="年审功能未开启">
                    <span class="material-icons">block</span> 年审未开启
                </span>
                {% endif %}
                {% if club_data.club.registration_enabled %}
                    {% if club_data.has_submitted_registration %}
                    <span class="btn btn-outlined" style="opacity: 0.6; cursor: not-allowed;">
                        <span class="material-icons">check_circle</span> 注册已提交
                    </span>
                    {% else %}
                    <a href="{% url 'clubs:submit_club_registration' club_data.club.id %}" class="btn btn-primary">
                        <span class="material-icons">add_circle</span> 注册
                    </a>
                    {% endif %}
                {% else %}
                <span class="btn btn-outlined" style="opacity: 0.5; cursor: not-allowed;" title="注册功能未开启">
                    <span class="material-icons">block</span> 注册未开启
                </span>
                {% endif %}
                <a href="{% url 'clubs:submit_reimbursement' club_data.club.id %}" class="btn btn-info">
                    <span class="material-icons">attach_money</span> 报销
                </a>
                <a href="{% url 'clubs:submit_activity_application' club_data.club.id %}" class="btn btn-primary">
                    <span class="material-icons">event</span> 活动申请
                </a>
                <a href="{% url 'clubs:submit_president_transition' club_data.club.id %}" class="btn btn-warning">
                    <span class="material-icons">swap_horiz</span> 社长换届
                </a>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <span class="material-icons">school</span>
        <p>您目前没有管理任何社团</p>
    </div>
    {% endif %}
</div>
{% endblock %}