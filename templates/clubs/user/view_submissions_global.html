{% extends 'clubs/base.html' %}

{% block title %}å¹´å®¡è®°å½•{% endblock %}

{% block content %}
<style>
/* çŠ¶æ€æ ‡ç­¾æ ·å¼ */
.status-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 3px;
    font-size: 12px;
    font-weight: 500;
}

.status-badge.pending {
    background-color: #f39c12;
    color: white;
}

.status-badge.approved {
    background-color: #27ae60;
    color: white;
}

.status-badge.rejected {
    background-color: #e74c3c;
    color: white;
}

.status-badge.active {
    background-color: #3498db;
    color: white;
}

.status-badge.inactive {
    background-color: #95a5a6;
    color: white;
}

.status-badge.suspended {
    background-color: #e74c3c !important;
    color: white !important;
    padding: 4px 8px;
    border-radius: 3px;
    font-size: 12px;
    font-weight: 500;
    display: inline-block;
}

/* å®¡æ ¸è®°å½•å¡ç‰‡æ ·å¼ */
.review-card {
    background: white;
    padding: 12px;
    border-radius: 6px;
    border: 1px solid #e9ecef;
    min-width: 220px;
    flex: 1;
    max-width: calc(33.333% - 10px);
    box-sizing: border-box;
}

/* å®¡æ ¸è®°å½•ç½‘æ ¼æ ·å¼ */
.reviews-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
}
</style>
<div class="card">
    <div class="card-header">
        <h3><span class="material-icons" style="vertical-align: middle;">assignment</span> æ‰€æœ‰ç¤¾å›¢å¹´å®¡è®°å½•</h3>
    </div>

    {% if submissions %}
    <div class="submissions-container">
        {% for submission in submissions %}
        <div class="year-submission" style="margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
            <!-- å¹´ä»½æ ‡é¢˜å•ç‹¬ä¸€è¡Œ -->
            <h4 style="margin-top: 0; margin-bottom: 15px; color: #333; font-size: 18px;">{{ submission.submission_year }} å¹´å¹´å®¡</h4>
            <div style="margin-bottom: 10px; color: #666;">
                <strong>ç¤¾å›¢åç§°:</strong> {{ submission.club.name }}
            </div>
            
            <!-- ä¿¡æ¯è¡Œæ¨ªå‘æ’åˆ— -->
            <div class="info-row" style="display: flex; gap: 25px; margin-bottom: 20px; flex-wrap: wrap;">
                <div>
                    <strong>æäº¤æ—¶é—´:</strong> {{ submission.submitted_at|date:"Y-m-d H:i" }}
                </div>
                <div>
                    <strong>çŠ¶æ€:</strong> 
                    <span class="status-badge {{ submission.status }}">
                        {{ submission.get_status_display }}
                    </span>
                </div>
                {% if submission.reviewed_at %}
                <div>
                    <strong>æœ€ç»ˆå®¡æ ¸æ—¶é—´:</strong> {{ submission.reviewed_at|date:"Y-m-d H:i" }}
                </div>
                {% endif %}
                {% if submission.status == 'approved' or submission.status == 'rejected' %}
                <div>
                    <strong>å·²è¯»çŠ¶æ€:</strong> 
                    <span style="font-size: 12px; background-color: {% if submission.is_read_by_president %}#d4edda{% else %}#fff3cd{% endif %}; color: {% if submission.is_read_by_president %}#155724{% else %}#856404{% endif %}; padding: 2px 6px; border-radius: 3px;">
                        {% if submission.is_read_by_president %}å·²è¯»{% else %}æœªè¯»{% endif %}
                    </span>
                </div>
                {% endif %}
            </div>
            
            <!-- å®¡æ ¸è®°å½•å¡ç‰‡æ¨ªå‘æ’åˆ— -->
            {% if submission.reviews.all %}
            <div class="reviews-section" style="margin-bottom: 20px;">
                <p style="margin-bottom: 10px; font-weight: bold;">å®¡æ ¸è®°å½•:</p>
                <div class="reviews-grid" style="display: flex; flex-wrap: wrap; gap: 15px;">
                    {% for review in submission.reviews.all %}
                    <div class="review-card" style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #e9ecef; min-width: 220px; flex: 1; max-width: calc(33.333% - 10px); box-sizing: border-box;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <span style="font-weight: bold; font-size: 14px;">{% if review.reviewer %}{{ review.reviewer.profile.get_full_name }}{% else %}æœªè®¾ç½®{% endif %}</span>
                            <span style="font-size: 12px; color: #666;">{{ review.reviewed_at|date:"Y-m-d H:i" }}</span>
                        </div>
                        <div style="font-size: 12px; background-color: {% if review.status == 'approved' %}#d4edda{% elif review.status == 'rejected' %}#f8d7da{% else %}#e9ecef{% endif %}; color: {% if review.status == 'approved' %}#155724{% elif review.status == 'rejected' %}#721c24{% else %}#495057{% endif %}; padding: 2px 6px; border-radius: 3px; display: inline-block;">
                            {% if review.status == 'approved' %}é€šè¿‡{% elif review.status == 'rejected' %}æ‹’ç»{% else %}{{ review.status }}{% endif %}
                        </div>
                        {% if review.comment %}
                        <div style="margin-top: 5px; font-size: 14px; color: #555;">{{ review.comment }}</div>
                        {% endif %}
                        
                        <!-- æ˜¾ç¤ºè¢«æ‹’ç»çš„ææ–™ -->
                        {% if review.status == 'rejected' and review.rejected_materials %}
                        <div style="margin-top: 10px; padding: 10px; background-color: #f8f9fa; border: 1px solid #f8d7da; border-radius: 4px;">
                            <div style="margin-bottom: 8px; font-weight: bold; color: #721c24; font-size: 14px;">
                                <span class="material-icons" style="vertical-align: middle; font-size: 1em;">warning</span> è¢«æ‹’ç»çš„ææ–™:
                            </div>
                            <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px;">
                                {% for material in review.rejected_materials %}
                                <span style="font-size: 12px; background-color: #f8d7da; color: #721c24; padding: 3px 8px; border-radius: 3px;">
                                    {% if material == 'self_assessment_form' %}è‡ªæŸ¥è¡¨{% endif %}
                                    {% if material == 'club_constitution' %}ç¤¾å›¢ç« ç¨‹{% endif %}
                                    {% if material == 'leader_learning_work_report' %}è´Ÿè´£äººå­¦ä¹ åŠå·¥ä½œæƒ…å†µè¡¨{% endif %}
                                    {% if material == 'annual_activity_list' %}ç¤¾å›¢å¹´åº¦æ´»åŠ¨æ¸…å•{% endif %}
                                    {% if material == 'advisor_performance_report' %}æŒ‡å¯¼æ•™å¸ˆå±¥èŒæƒ…å†µè¡¨{% endif %}
                                    {% if material == 'financial_report' %}å¹´åº¦è´¢åŠ¡æƒ…å†µè¡¨{% endif %}
                                    {% if material == 'member_composition_list' %}ç¤¾å›¢æˆå‘˜æ„æˆè¡¨{% endif %}
                                    {% if material == 'new_media_account_report' %}æ–°åª’ä½“è´¦å·åŠè¿ç»´æƒ…å†µè¡¨{% endif %}
                                    {% if material == 'other_materials' %}å…¶ä»–ææ–™{% endif %}
                                </span>
                                {% endfor %}
                            </div>
                            <!-- é‡æ–°æäº¤æŒ‰é’® -->
                            <div style="text-align: right;">
                                <a href="{% url 'clubs:submit_review' submission.club.id %}?resubmit={{ submission.id }}" class="btn btn-danger btn-sm">
                                    ğŸ”„ ä¿®æ”¹å¹¶é‡æ–°æäº¤
                                </a>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- ä¸‹è½½æŒ‰é’®æ¨ªå‘æ’åˆ— -->
            <div class="download-buttons" style="display: flex; gap: 10px; flex-wrap: wrap;">
                <!-- æŒ‰ç…§è¦æ±‚çš„é¡ºåºæ˜¾ç¤ºææ–™ -->
                {% if submission.self_assessment_form %}
                <a href="{{ submission.self_assessment_form.url }}" class="btn btn-primary" download>
                    <span class="material-icons" style="vertical-align: middle;">assignment</span> è‡ªæŸ¥è¡¨
                </a>
                {% endif %}
                {% if submission.club_constitution %}
                <a href="{{ submission.club_constitution.url }}" class="btn btn-primary" download>
                    ğŸ“‘ ç¤¾å›¢ç« ç¨‹
                </a>
                {% endif %}
                {% if submission.leader_learning_work_report %}
                <a href="{{ submission.leader_learning_work_report.url }}" class="btn btn-primary" download>
                    <span class="material-icons">person</span> è´Ÿè´£äººå­¦ä¹ åŠå·¥ä½œæƒ…å†µè¡¨
                </a>
                {% endif %}
                {% if submission.annual_activity_list %}
                <a href="{{ submission.annual_activity_list.url }}" class="btn btn-primary" download>
                    ğŸ“… ç¤¾å›¢å¹´åº¦æ´»åŠ¨æ¸…å•
                </a>
                {% endif %}
                {% if submission.advisor_performance_report %}
                <a href="{{ submission.advisor_performance_report.url }}" class="btn btn-primary" download>
                    <span class="material-icons">school</span> æŒ‡å¯¼æ•™å¸ˆå±¥èŒæƒ…å†µè¡¨
                </a>
                {% endif %}
                {% if submission.financial_report %}
                <a href="{{ submission.financial_report.url }}" class="btn btn-primary" download>
                    <span class="material-icons" style="vertical-align: middle;">attach_money</span> å¹´åº¦è´¢åŠ¡æƒ…å†µè¡¨
                </a>
                {% endif %}
                {% if submission.member_composition_list %}
                <a href="{{ submission.member_composition_list.url }}" class="btn btn-primary" download>
                    <span class="material-icons" style="vertical-align: middle;">group</span> ç¤¾å›¢æˆå‘˜æ„æˆè¡¨
                </a>
                {% endif %}
                {% if submission.new_media_account_report %}
                <a href="{{ submission.new_media_account_report.url }}" class="btn btn-primary" download>
                    ğŸ“± æ–°åª’ä½“è´¦å·åŠè¿ç»´æƒ…å†µè¡¨
                </a>
                {% endif %}
                {% if submission.other_materials %}
                <a href="{{ submission.other_materials.url }}" class="btn btn-primary" download>
                    ğŸ“¦ å…¶ä»–ææ–™
                </a>
                {% endif %}
                
                <!-- åˆå¹¶ä¸‹è½½å’ŒZIPæ‰“åŒ…ä¸‹è½½æŒ‰é’® -->
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px dashed #ddd; width: 100%;">

                    <a href="{% url 'clubs:zip_review_docs' submission.id %}" class="btn btn-primary" style="margin-bottom: 10px; width: 100%;">
                        ğŸ—œï¸ æ‰“åŒ…æ‰€æœ‰ææ–™ä¸ºZIPæ–‡ä»¶
                    </a>
                    

                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p style="color: #666; padding: 20px; text-align: center;">æš‚æ— å¹´å®¡æäº¤è®°å½•</p>
    {% endif %}

    <div style="margin-top: 20px;">
        <a href="{% url 'clubs:user_dashboard' %}" class="btn btn-primary">è¿”å›</a>
    </div>
</div>
{% endblock %}