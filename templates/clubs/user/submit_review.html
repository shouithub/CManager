{% extends 'clubs/base.html' %}
{% load custom_filters %}

{% block title %}æäº¤å¹´å®¡ææ–™ - {{ club.name }}{% endblock %}

{% block extra_css %}
<style>
@media (max-width: 768px) {
    .submit-container {
        padding: var(--md3-spacing-lg) !important;
        padding-bottom: calc(var(--md3-spacing-2xl) + 100px) !important;

    }
    .form-grid {
        grid-template-columns: 1fr !important;
    }
    .template-grid {
        grid-template-columns: 1fr !important;
    }
}

/* MD3 æäº¤é¡µé¢æ ·å¼ */
.submit-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: var(--md3-spacing-2xl);
    padding-bottom: 120px; /* é˜²æ­¢è¢«åº•æ é®æŒ¡ */
    box-sizing: border-box;
}

/* é¡µé¢æ ‡é¢˜ */
    /* .page-title removed in favor of .page-header in style.css */

/* ä¿¡æ¯å¡ç‰‡ */
.info-card {
    background: var(--md3-surface-container);
    border: 1px solid var(--md3-outline-variant);
    border-radius: var(--md3-radius-lg);
    padding: var(--md3-spacing-xl);
    margin-bottom: var(--md3-spacing-xl);
    box-shadow: var(--md3-elevation-1);
}

.info-card.warning {
    background: var(--md3-error-container);
    border-color: var(--md3-error);
}

.info-card.info {
    background: var(--md3-primary-container);
    border-color: var(--md3-primary);
}

.info-card h5 {
    margin: 0 0 var(--md3-spacing-md) 0;
    font-size: 1.125rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: var(--md3-spacing-sm);
}

.info-card.warning h5 {
    color: var(--md3-on-error-container);
}

.info-card.warning h5 .material-icons {
    color: var(--md3-on-error-container);
}

.info-card.info h5 {
    color: var(--md3-on-primary-container);
}

.info-card.info h5 .material-icons {
    color: var(--md3-on-primary-container);
}

.info-card p {
    margin: 0 0 var(--md3-spacing-sm) 0;
    line-height: 1.5;
}

.info-card ul {
    margin: var(--md3-spacing-sm) 0 0 0;
    padding-left: var(--md3-spacing-lg);
}

.info-card li {
    margin-bottom: var(--md3-spacing-xs);
}

/* æ¨¡æ¿ä¸‹è½½å¡ç‰‡ */
.template-card {
    background: var(--md3-surface-container);
    border: 1px solid var(--md3-outline-variant);
    border-radius: var(--md3-radius-lg);
    padding: var(--md3-spacing-xl);
    margin-bottom: var(--md3-spacing-xl);
    box-shadow: var(--md3-elevation-1);
}

.template-card h4 {
    margin: 0 0 var(--md3-spacing-md) 0;
    color: var(--md3-on-surface);
    font-size: 1.25rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: var(--md3-spacing-sm);
}

.template-card h4 .material-icons {
    color: var(--md3-primary);
}

.template-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: var(--md3-spacing-lg);
}

.template-section {
    background: var(--md3-surface-container-low);
    border-radius: var(--md3-radius-md);
    padding: var(--md3-spacing-md);
}

.template-section h5 {
    margin: 0 0 var(--md3-spacing-sm) 0;
    color: var(--md3-on-surface);
    font-size: 1rem;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: var(--md3-spacing-sm);
}

.template-section h5 .material-icons {
    font-size: 1.25rem;
    color: var(--md3-secondary);
}

.template-section ul {
    margin: 0;
    padding-left: var(--md3-spacing-lg);
}

.template-section li {
    margin-bottom: var(--md3-spacing-xs);
}

.template-section a {
    color: var(--md3-primary);
    text-decoration: none;
}

.template-section a:hover {
    text-decoration: underline;
}

/* è¡¨å•å¡ç‰‡ */
.form-card {
    background: var(--md3-surface-container);
    border: 1px solid var(--md3-outline-variant);
    border-radius: var(--md3-radius-lg);
    padding: var(--md3-spacing-xl);
    margin-bottom: var(--md3-spacing-xl);
    box-shadow: var(--md3-elevation-1);
}

.form-card h3 {
    margin: 0 0 var(--md3-spacing-lg) 0;
    color: var(--md3-on-surface);
    font-size: 1.5rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: var(--md3-spacing-sm);
}

.form-card h3 .material-icons {
    color: var(--md3-primary);
}

/* è¡¨å•ç½‘æ ¼ */
.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: var(--md3-spacing-lg);
}

/* è¡¨å•ç»„ */
.form-group {
    display: flex;
    flex-direction: column;
    gap: var(--md3-spacing-sm);
}

.form-group label {
    font-weight: 500;
    color: var(--md3-on-surface);
    display: flex;
    align-items: center;
    gap: var(--md3-spacing-xs);
}

.form-group label .material-icons {
    font-size: 1.125rem;
    color: var(--md3-secondary);
}

.form-group input[type="file"] {
    padding: var(--md3-spacing-sm) var(--md3-spacing-md);
    border: 1px solid var(--md3-outline);
    border-radius: var(--md3-radius-md);
    background: var(--md3-surface-container-highest);
    color: var(--md3-on-surface);
    transition: all 0.2s ease;
}

.form-group input[type="file"]:focus {
    outline: none;
    border-color: var(--md3-primary);
    box-shadow: 0 0 0 2px var(--md3-primary-container);
}

.form-group input[type="number"] {
    padding: var(--md3-spacing-sm) var(--md3-spacing-md);
    border: 1px solid var(--md3-outline);
    border-radius: var(--md3-radius-md);
    background: var(--md3-surface-container-highest);
    color: var(--md3-on-surface);
    transition: all 0.2s ease;
}

.form-group input[type="number"]:focus {
    outline: none;
    border-color: var(--md3-primary);
    box-shadow: 0 0 0 2px var(--md3-primary-container);
}

.form-group small {
    color: var(--md3-on-surface-variant);
    font-size: 0.875rem;
}

.form-group small a {
    color: var(--md3-primary);
    text-decoration: none;
}

.form-group small a:hover {
    text-decoration: underline;
}

/* é”™è¯¯ä¿¡æ¯ */
.error-message {
    background: var(--md3-error-container);
    border: 1px solid var(--md3-error);
    border-radius: var(--md3-radius-md);
    padding: var(--md3-spacing-md);
    margin-bottom: var(--md3-spacing-lg);
    color: var(--md3-on-error-container);
}

.error-message ul {
    margin: var(--md3-spacing-sm) 0 0 0;
    padding-left: var(--md3-spacing-lg);
}

.error-message li {
    margin-bottom: var(--md3-spacing-xs);
}

.action-buttons {
        display: flex;
        gap: var(--md3-spacing-md);
        margin-top: var(--md3-spacing-2xl);
        justify-content: flex-end;
    }
    
    .btn-primary {
        background: var(--md3-primary);
        color: var(--md3-on-primary);
        border: none;
        padding: 10px 24px;
        border-radius: var(--md3-radius-full);
        font-weight: 600;
        font-size: 0.9375rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: var(--md3-spacing-sm);
        box-shadow: var(--md3-elevation-1);
    }
    
    .btn-primary:hover {
        background: var(--md3-primary-dim);
        box-shadow: var(--md3-elevation-2);
    }
    
    .btn-secondary {
        background: var(--md3-surface-container-high);
        color: var(--md3-on-surface);
        border: 1px solid var(--md3-outline);
        padding: 10px 24px;
        border-radius: var(--md3-radius-full);
        font-weight: 600;
        font-size: 0.9375rem;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: var(--md3-spacing-sm);
    }
    
    .btn-secondary:hover {
        background: var(--md3-surface-container-highest);
        box-shadow: var(--md3-elevation-1);
    }

    .btn-primary .material-icons,
    .btn-secondary .material-icons {
        font-size: 1.125rem;
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
        .action-buttons {
            flex-direction: column;
        }
    
        .action-buttons button, 
        .action-buttons a {
            width: 100%;
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="submit-container">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="page-header">
        <span class="material-icons">assignment</span>
        <div class="page-header-content">
            <h1>{% if is_resubmission %}é‡æ–°æäº¤å¹´å®¡ææ–™{% else %}æäº¤å¹´å®¡ææ–™{% endif %}</h1>
            <p class="subtitle">{{ club.name }}</p>
        </div>
    </div>

    <!-- é”™è¯¯ä¿¡æ¯ -->
    {% if errors %}
    <div class="error-message">
        <div style="display: flex; align-items: center; gap: var(--md3-spacing-sm); margin-bottom: var(--md3-spacing-sm);">
            <span class="material-icons">error</span>
            <strong>è¯·æ£€æŸ¥ä»¥ä¸‹é”™è¯¯ï¼š</strong>
        </div>
        <ul>
            {% for error in errors %}
            <li>{{ error }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <!-- æäº¤è¯´æ˜ -->
    {% if is_resubmission %}
    <div class="info-card warning">
        <h5>
            <span class="material-icons">warning</span>
            é‡æ–°æäº¤è¯´æ˜
        </h5>
        <p>æ‚¨çš„å¹´å®¡ææ–™ä¸­æœ‰éƒ¨åˆ†å†…å®¹éœ€è¦ä¿®æ”¹ï¼Œè¯·é‡æ–°ä¸Šä¼ ä»¥ä¸‹è¢«æ‹’ç»çš„ææ–™ï¼š</p>
        <ul>
            {% for review in rejected_submission.submissionreview_set.all %}
                {% if review.rejected_materials %}
                    {% for material in review.rejected_materials %}
                        <li>
                            {% if material == 'self_assessment_form' %}ğŸ“‹ è‡ªæŸ¥è¡¨{% endif %}
                            {% if material == 'club_constitution' %}ğŸ“‘ ç¤¾å›¢ç« ç¨‹{% endif %}
                            {% if material == 'leader_learning_work_report' %}ğŸ‘¤ è´Ÿè´£äººå­¦ä¹ åŠå·¥ä½œæƒ…å†µè¡¨{% endif %}
                            {% if material == 'annual_activity_list' %}ğŸ“… ç¤¾å›¢å¹´åº¦æ´»åŠ¨æ¸…å•{% endif %}
                            {% if material == 'advisor_performance_report' %}ğŸ“ æŒ‡å¯¼æ•™å¸ˆå±¥èŒæƒ…å†µè¡¨{% endif %}
                            {% if material == 'financial_report' %}ğŸ’° å¹´åº¦è´¢åŠ¡æƒ…å†µè¡¨{% endif %}
                            {% if material == 'member_composition_list' %}ğŸ‘¥ ç¤¾å›¢æˆå‘˜æ„æˆè¡¨{% endif %}
                            {% if material == 'new_media_account_report' %}ğŸ“± æ–°åª’ä½“è´¦å·åŠè¿ç»´æƒ…å†µè¡¨{% endif %}
                            {% if material == 'other_materials' %}ğŸ“¦ å…¶ä»–ææ–™{% endif %}
                        </li>
                    {% endfor %}
                {% endif %}
            {% endfor %}
        </ul>
    </div>
    {% else %}
    <div class="info-card info">
        <h5>
            <span class="material-icons">info</span>
            æäº¤è¯´æ˜
        </h5>
        <p>è¯·ä¸‹è½½ç›¸åº”æ¨¡æ¿å¹¶å¡«å†™å®Œæ•´åä¸Šä¼ ã€‚æ‰€æœ‰æ ‡è®°ä¸º <strong style="color: var(--md3-error);">*</strong> çš„å­—æ®µä¸ºå¿…å¡«é¡¹ã€‚</p>
        <p><strong>é‡è¦æé†’ï¼š</strong>æ‰€æœ‰æ–‡ä»¶å¿…é¡»ä¸ºWordæ ¼å¼(.docæˆ–.docx)ã€‚</p>
    </div>
    {% endif %}

    <!-- æ¨¡æ¿ä¸‹è½½ -->
    {% if financial_templates or activity_templates or member_list_templates or self_assessment_templates or club_constitution_templates or leader_report_templates or annual_activity_templates or advisor_report_templates or member_composition_templates or media_account_templates %}
    <div class="template-card">
        <h4>
            å¯ç”¨æ¨¡æ¿ä¸‹è½½
        </h4>

        <div class="template-grid">
            <!-- è‡ªæŸ¥è¡¨æ¨¡æ¿ -->
            {% if self_assessment_templates %}
            <div class="template-section">
                <h5>
                    <span class="material-icons">assignment</span>
                    è‡ªæŸ¥è¡¨æ¨¡æ¿
                </h5>
                <ul>
                    {% for template in self_assessment_templates %}
                    <li>
                        <a href="{{ template.file.url }}" download>{{ template.name }}</a>
                        {% if template.description %} - {{ template.description }}{% endif %}
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <!-- ç¤¾å›¢ç« ç¨‹æ¨¡æ¿ -->
            {% if club_constitution_templates %}
            <div class="template-section">
                <h5>
                    <span class="material-icons">description</span>
                    ç¤¾å›¢ç« ç¨‹æ¨¡æ¿
                </h5>
                <ul>
                    {% for template in club_constitution_templates %}
                    <li>
                        <a href="{{ template.file.url }}" download>{{ template.name }}</a>
                        {% if template.description %} - {{ template.description }}{% endif %}
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <!-- è´Ÿè´£äººå­¦ä¹ åŠå·¥ä½œæƒ…å†µè¡¨æ¨¡æ¿ -->
            {% if leader_report_templates %}
            <div class="template-section">
                <h5>
                    <span class="material-icons">person</span>
                    è´Ÿè´£äººå­¦ä¹ åŠå·¥ä½œæƒ…å†µè¡¨æ¨¡æ¿
                </h5>
                <ul>
                    {% for template in leader_report_templates %}
                    <li>
                        <a href="{{ template.file.url }}" download>{{ template.name }}</a>
                        {% if template.description %} - {{ template.description }}{% endif %}
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <!-- ç¤¾å›¢å¹´åº¦æ´»åŠ¨æ¸…å•æ¨¡æ¿ -->
            {% if annual_activity_templates %}
            <div class="template-section">
                <h5>
                    <span class="material-icons">event_note</span>
                    ç¤¾å›¢å¹´åº¦æ´»åŠ¨æ¸…å•æ¨¡æ¿
                </h5>
                <ul>
                    {% for template in annual_activity_templates %}
                    <li>
                        <a href="{{ template.file.url }}" download>{{ template.name }}</a>
                        {% if template.description %} - {{ template.description }}{% endif %}
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <!-- æŒ‡å¯¼æ•™å¸ˆå±¥èŒæƒ…å†µè¡¨æ¨¡æ¿ -->
            {% if advisor_report_templates %}
            <div class="template-section">
                <h5>
                    <span class="material-icons">school</span>
                    æŒ‡å¯¼æ•™å¸ˆå±¥èŒæƒ…å†µè¡¨æ¨¡æ¿
                </h5>
                <ul>
                    {% for template in advisor_report_templates %}
                    <li>
                        <a href="{{ template.file.url }}" download>{{ template.name }}</a>
                        {% if template.description %} - {{ template.description }}{% endif %}
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <!-- å¹´åº¦è´¢åŠ¡æƒ…å†µè¡¨æ¨¡æ¿ -->
            {% if financial_templates %}
            <div class="template-section">
                <h5>
                    <span class="material-icons">attach_money</span>
                    å¹´åº¦è´¢åŠ¡æƒ…å†µè¡¨æ¨¡æ¿
                </h5>
                <ul>
                    {% for template in financial_templates %}
                    <li>
                        <a href="{{ template.file.url }}" download>{{ template.name }}</a>
                        {% if template.description %} - {{ template.description }}{% endif %}
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <!-- ç¤¾å›¢æˆå‘˜æ„æˆè¡¨æ¨¡æ¿ -->
            {% if member_composition_templates %}
            <div class="template-section">
                <h5>
                    <span class="material-icons">group</span>
                    ç¤¾å›¢æˆå‘˜æ„æˆè¡¨æ¨¡æ¿
                </h5>
                <ul>
                    {% for template in member_composition_templates %}
                    <li>
                        <a href="{{ template.file.url }}" download>{{ template.name }}</a>
                        {% if template.description %} - {{ template.description }}{% endif %}
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <!-- æ–°åª’ä½“è´¦å·åŠè¿ç»´æƒ…å†µè¡¨æ¨¡æ¿ -->
            {% if media_account_templates %}
            <div class="template-section">
                <h5>
                    <span class="material-icons">smartphone</span>
                    æ–°åª’ä½“è´¦å·åŠè¿ç»´æƒ…å†µè¡¨æ¨¡æ¿
                </h5>
                <ul>
                    {% for template in media_account_templates %}
                    <li>
                        <a href="{{ template.file.url }}" download>{{ template.name }}</a>
                        {% if template.description %} - {{ template.description }}{% endif %}
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}    <!-- ææ–™ä¸Šä¼ è¡¨å• -->
    <div class="form-card">
        <h3>
            <span class="material-icons">assignment</span>
            ææ–™ä¸Šä¼ 
        </h3>

        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}

            <!-- æäº¤å¹´ä»½ -->
            <div class="form-group">
                <label for="submission_year">
                    æäº¤å¹´ä»½ <span style="color: var(--md3-error);">*</span>
                </label>
                <input type="number" id="submission_year" name="submission_year" value="{% if is_resubmission %}{{ rejected_submission.submission_year }}{% else %}{{ current_year }}{% endif %}" min="2000" max="2100" required>
                <small>è¯·é€‰æ‹©è¦æäº¤å¹´å®¡ææ–™çš„å¹´ä»½</small>
            </div>

            <div class="form-grid">
                {% for req in requirements %}
                    {% if not is_resubmission or req.id in rejected_req_ids or not req.is_required %}
                    
                    {% comment %} Prepare existing file object if resubmission {% endcomment %}
                    {% if is_resubmission %}
                        {% for req_id, file_info in existing_files.items %}
                            {% if req_id == req.id %}
                                {% include 'clubs/components/_file_upload.html' with field_name="material_"|concat_str:req.id label=req.name is_required=req.is_required allowed_extensions=req.allowed_extensions description=req.description existing_file=file_info icon=req.icon|default:"folder" %}
                            {% endif %}
                        {% endfor %}
                        
                        {% comment %} If no existing file found in loop (should be rare if logic correct), just render upload {% endcomment %}
                        {% if req.id not in existing_files %}
                             {% include 'clubs/components/_file_upload.html' with field_name="material_"|concat_str:req.id label=req.name is_required=req.is_required allowed_extensions=req.allowed_extensions description=req.description icon=req.icon|default:"folder" %}
                        {% endif %}
                    {% else %}
                        {% include 'clubs/components/_file_upload.html' with field_name="material_"|concat_str:req.id label=req.name is_required=req.is_required allowed_extensions=req.allowed_extensions description=req.description icon=req.icon|default:"folder" %}
                    {% endif %}

                    {% endif %}
                {% endfor %}
            </div>

            <!-- æŒ‰é’®ç»„ -->
            <div class="action-buttons">
                <a href="{% url 'clubs:club_detail' club.id %}" class="btn-secondary">
                    <span class="material-icons">arrow_back</span>
                    è¿”å›
                </a>
                <button type="submit" class="btn-primary">
                    <span class="material-icons">check_circle</span>
                    æäº¤å®¡æ ¸
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}
