{% extends 'clubs/base.html' %}
{% load custom_filters %}

{% block title %}提交年审材料 - {{ club.name }}{% endblock %}

{% block extra_css %}
<style>
@media (max-width: 768px) {
    .submit-container {
        padding: var(--md3-spacing-lg) !important;
        padding-bottom: calc(var(--md3-spacing-2xl) + 100px) !important;

    }
    .form-grid {
        grid-template-columns: 1fr !important;
    }
}

/* MD3 提交页面样式 */
.submit-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: var(--md3-spacing-2xl);
    padding-bottom: 120px; /* 防止被底栏遮挡 */
    box-sizing: border-box;
}

/* 页面标题 */
    /* .page-title removed in favor of .page-header in style.css */

/* 信息卡片 */
.info-card {
    background: var(--md3-surface-container);
    border: 1px solid var(--md3-outline-variant);
    border-radius: var(--md3-radius-lg);
    padding: var(--md3-spacing-xl);
    margin-bottom: var(--md3-spacing-xl);
    box-shadow: var(--md3-elevation-1);
}

.info-card.warning {
    background: var(--md3-error-container);
    border-color: var(--md3-error);
}

.info-card.info {
    background: var(--md3-primary-container);
    border-color: var(--md3-primary);
}

.info-card h5 {
    margin: 0 0 var(--md3-spacing-md) 0;
    font-size: 1.125rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: var(--md3-spacing-sm);
}

.info-card.warning h5 {
    color: var(--md3-on-error-container);
}

.info-card.warning h5 .material-icons {
    color: var(--md3-on-error-container);
}

.info-card.info h5 {
    color: var(--md3-on-primary-container);
}

.info-card.info h5 .material-icons {
    color: var(--md3-on-primary-container);
}

.info-card p {
    margin: 0 0 var(--md3-spacing-sm) 0;
    line-height: 1.5;
}

.info-card ul {
    margin: var(--md3-spacing-sm) 0 0 0;
    padding-left: var(--md3-spacing-lg);
}

.info-card li {
    margin-bottom: var(--md3-spacing-xs);
}

/* 模板下载卡片样式已移除，统一使用表单卡片 */

/* 表单卡片 */
.form-card {
    background: var(--md3-surface-container);
    border: 1px solid var(--md3-outline-variant);
    border-radius: var(--md3-radius-lg);
    padding: var(--md3-spacing-xl);
    margin-bottom: var(--md3-spacing-xl);
    box-shadow: var(--md3-elevation-1);
}

.form-card h3 {
    margin: 0 0 var(--md3-spacing-lg) 0;
    color: var(--md3-on-surface);
    font-size: 1.5rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: var(--md3-spacing-sm);
}

.form-card h3 .material-icons {
    color: var(--md3-primary);
}

/* 表单网格 */
.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: var(--md3-spacing-lg);
}

/* 表单组 */
.form-group {
    display: flex;
    flex-direction: column;
    gap: var(--md3-spacing-sm);
}

.form-group label {
    font-weight: 500;
    color: var(--md3-on-surface);
    display: flex;
    align-items: center;
    gap: var(--md3-spacing-xs);
}

.form-group label .material-icons {
    font-size: 1.125rem;
    color: var(--md3-secondary);
}

.form-group input[type="file"] {
    padding: var(--md3-spacing-sm) var(--md3-spacing-md);
    border: 1px solid var(--md3-outline);
    border-radius: var(--md3-radius-md);
    background: var(--md3-surface-container-highest);
    color: var(--md3-on-surface);
    transition: all 0.2s ease;
}

.form-group input[type="file"]:focus {
    outline: none;
    border-color: var(--md3-primary);
    box-shadow: 0 0 0 2px var(--md3-primary-container);
}

.form-group input[type="number"] {
    padding: var(--md3-spacing-sm) var(--md3-spacing-md);
    border: 1px solid var(--md3-outline);
    border-radius: var(--md3-radius-md);
    background: var(--md3-surface-container-highest);
    color: var(--md3-on-surface);
    transition: all 0.2s ease;
}

.form-group input[type="number"]:focus {
    outline: none;
    border-color: var(--md3-primary);
    box-shadow: 0 0 0 2px var(--md3-primary-container);
}

.form-group small {
    color: var(--md3-on-surface-variant);
    font-size: 0.875rem;
}

.form-group small a {
    color: var(--md3-primary);
    text-decoration: none;
}

.form-group small a:hover {
    text-decoration: underline;
}

/* 错误信息 */
.error-message {
    background: var(--md3-error-container);
    border: 1px solid var(--md3-error);
    border-radius: var(--md3-radius-md);
    padding: var(--md3-spacing-md);
    margin-bottom: var(--md3-spacing-lg);
    color: var(--md3-on-error-container);
}

.error-message ul {
    margin: var(--md3-spacing-sm) 0 0 0;
    padding-left: var(--md3-spacing-lg);
}

.error-message li {
    margin-bottom: var(--md3-spacing-xs);
}

.action-buttons {
        display: flex;
        gap: var(--md3-spacing-md);
        margin-top: var(--md3-spacing-2xl);
        justify-content: flex-end;
    }
    
    .btn-primary {
        background: var(--md3-primary);
        color: var(--md3-on-primary);
        border: none;
        padding: 10px 24px;
        border-radius: var(--md3-radius-full);
        font-weight: 600;
        font-size: 0.9375rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: var(--md3-spacing-sm);
        box-shadow: var(--md3-elevation-1);
    }
    
    .btn-primary:hover {
        background: var(--md3-primary-dim);
        box-shadow: var(--md3-elevation-2);
    }
    
    .btn-secondary {
        background: var(--md3-surface-container-high);
        color: var(--md3-on-surface);
        border: 1px solid var(--md3-outline);
        padding: 10px 24px;
        border-radius: var(--md3-radius-full);
        font-weight: 600;
        font-size: 0.9375rem;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: var(--md3-spacing-sm);
    }
    
    .btn-secondary:hover {
        background: var(--md3-surface-container-highest);
        box-shadow: var(--md3-elevation-1);
    }

    .btn-primary .material-icons,
    .btn-secondary .material-icons {
        font-size: 1.125rem;
    }

    /* 响应式设计 */
    @media (max-width: 768px) {
        .action-buttons {
            flex-direction: column;
        }
    
        .action-buttons button, 
        .action-buttons a {
            width: 100%;
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="submit-container">
    <!-- 页面标题 -->
    <div class="page-header">
        <span class="material-icons">assignment</span>
        <div class="page-header-content">
            <h1>{% if is_resubmission %}重新提交年审材料{% else %}提交年审材料{% endif %}</h1>
            <p class="subtitle">{{ club.name }}</p>
        </div>
    </div>

    <!-- 错误信息 -->
    {% if errors %}
    <div class="error-message">
        <div style="display: flex; align-items: center; gap: var(--md3-spacing-sm); margin-bottom: var(--md3-spacing-sm);">
            <span class="material-icons">error</span>
            <strong>请检查以下错误：</strong>
        </div>
        <ul>
            {% for error in errors %}
            <li>{{ error }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <!-- 提交说明 -->
    {% if is_resubmission %}
    <div class="info-card warning">
        <h5>
            <span class="material-icons">warning</span>
            重新提交说明
        </h5>
        <p>您的年审材料中有部分内容需要修改，请重新上传以下被拒绝的材料：</p>
        <ul>
            {% for review in rejected_submission.submissionreview_set.all %}
                {% if review.rejected_materials %}
                    {% for material in review.rejected_materials %}
                        <li>
                            {% with req=material|get_material_requirement %}
                                {% if req %}
                                    <span class="material-icons" style="font-size: 1.1em; vertical-align: text-bottom; margin-right: 4px; color: var(--md3-error);">{{ req.icon|default:"description" }}</span>
                                    {{ req.name }}
                                {% else %}
                                    {{ material|material_name }}
                                {% endif %}
                            {% endwith %}
                        </li>
                    {% endfor %}
                {% endif %}
            {% endfor %}
        </ul>
    </div>
    {% else %}
    <div class="info-card info">
        <h5>
            <span class="material-icons">info</span>
            提交说明
        </h5>
        <p>请下载相应模板并填写完整后上传。所有标记为 <strong style="color: var(--md3-error);">*</strong> 的字段为必填项。</p>
        <p><strong>重要提醒：</strong>所有文件必须为Word格式(.doc或.docx)。</p>
    </div>
    {% endif %}

    <!-- 材料上传表单 -->
    <div class="form-card">
        <h3>
            <span class="material-icons">assignment</span>
            材料上传
        </h3>

        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}

            <!-- 提交年份 -->
            <div class="form-group">
                <label for="submission_year">
                    提交年份 <span style="color: var(--md3-error);">*</span>
                </label>
                <input type="number" id="submission_year" name="submission_year" value="{% if is_resubmission %}{{ rejected_submission.submission_year }}{% else %}{{ current_year }}{% endif %}" min="2000" max="2100" required>
                <small>请选择要提交年审材料的年份</small>
            </div>

            <div class="form-grid">
                {% for req in requirements %}
                    {% if not is_resubmission or req.id in rejected_req_ids or not req.is_required %}
                    
                    {% comment %} Prepare existing file object if resubmission {% endcomment %}
                    {% if is_resubmission %}
                        {% for req_id, file_info in existing_files.items %}
                            {% if req_id == req.id %}
                                {% if req.template_file %}
                                    {% include 'clubs/components/_file_upload.html' with field_name="material_"|concat_str:req.id label=req.name is_required=req.is_required allowed_extensions=req.allowed_extensions description=req.description existing_file=file_info icon=req.icon|default:"folder" template_url=req.template_file.url %}
                                {% else %}
                                    {% include 'clubs/components/_file_upload.html' with field_name="material_"|concat_str:req.id label=req.name is_required=req.is_required allowed_extensions=req.allowed_extensions description=req.description existing_file=file_info icon=req.icon|default:"folder" %}
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                        
                        {% comment %} If no existing file found in loop (should be rare if logic correct), just render upload {% endcomment %}
                        {% if req.id not in existing_files %}
                             {% if req.template_file %}
                                 {% include 'clubs/components/_file_upload.html' with field_name="material_"|concat_str:req.id label=req.name is_required=req.is_required allowed_extensions=req.allowed_extensions description=req.description icon=req.icon|default:"folder" template_url=req.template_file.url %}
                             {% else %}
                                 {% include 'clubs/components/_file_upload.html' with field_name="material_"|concat_str:req.id label=req.name is_required=req.is_required allowed_extensions=req.allowed_extensions description=req.description icon=req.icon|default:"folder" %}
                             {% endif %}
                        {% endif %}
                    {% else %}
                        {% if req.template_file %}
                            {% include 'clubs/components/_file_upload.html' with field_name="material_"|concat_str:req.id label=req.name is_required=req.is_required allowed_extensions=req.allowed_extensions description=req.description icon=req.icon|default:"folder" template_url=req.template_file.url %}
                        {% else %}
                            {% include 'clubs/components/_file_upload.html' with field_name="material_"|concat_str:req.id label=req.name is_required=req.is_required allowed_extensions=req.allowed_extensions description=req.description icon=req.icon|default:"folder" %}
                        {% endif %}
                    {% endif %}

                    {% endif %}
                {% endfor %}
            </div>

            <!-- 按钮组 -->
            <div class="action-buttons">
                <a href="{% url 'clubs:club_detail' club.id %}" class="btn-secondary">
                    <span class="material-icons">arrow_back</span>
                    返回
                </a>
                <button type="submit" class="btn-primary">
                    <span class="material-icons">check_circle</span>
                    提交审核
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}
