{% extends 'clubs/base.html' %}
{% load custom_filters %}

{% block title %}个人中心{% endblock %}

{% block extra_css %}
<style>
    /* ===== MD3 完整重构 ===== */
    :root {
        --md3-spacing-xs: 4px;
        --md3-spacing-sm: 8px;
        --md3-spacing-md: 12px;
        --md3-spacing-lg: 16px;
        --md3-spacing-xl: 24px;
        --md3-spacing-2xl: 32px;
    }
    
    body {
        background: var(--md3-surface);
    }

    .profile-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: var(--md3-spacing-2xl);
        padding-bottom: calc(var(--md3-spacing-2xl) + 100px);
        box-sizing: border-box;
    }
    
    /* ===== 页面顶部标题 ===== */
    .page-header {
        display: flex;
        align-items: center;
        gap: var(--md3-spacing-md);
        margin-bottom: var(--md3-spacing-2xl);
        padding: var(--md3-spacing-xl) var(--md3-spacing-2xl);
        background: linear-gradient(135deg, var(--md3-primary-container) 0%, var(--md3-secondary-container) 100%);
        border-radius: var(--md3-radius-xl);
        box-shadow: var(--md3-elevation-2);
    }
    
    .page-header .material-icons {
        font-size: 2.5rem;
        color: var(--md3-primary);
    }
    
    .page-header h1 {
        margin: 0;
        font-size: 2rem;
        font-weight: 500;
        color: var(--md3-on-surface);
        letter-spacing: 0;
    }
    
    /* ===== 选项卡导航 ===== */
    .tabs {
        display: flex;
        gap: var(--md3-spacing-md);
        margin-bottom: var(--md3-spacing-xl);
        border-bottom: 1px solid var(--md3-outline-variant);
        padding-bottom: 0;
    }
    
    .tab-btn {
        background: none;
        border: none;
        padding: var(--md3-spacing-md) var(--md3-spacing-xl);
        font-size: 1rem;
        font-weight: 500;
        color: var(--md3-on-surface-variant);
        cursor: pointer;
        position: relative;
        transition: all 0.2s;
        border-radius: var(--md3-radius-lg) var(--md3-radius-lg) 0 0;
    }
    
    .tab-btn:hover {
        background: var(--md3-surface-container-high);
        color: var(--md3-on-surface);
    }
    
    .tab-btn.active {
        color: var(--md3-primary);
        background: var(--md3-surface-container-low);
    }
    
    .tab-btn.active::after {
        content: '';
        position: absolute;
        bottom: -1px;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--md3-primary);
        border-radius: 3px 3px 0 0;
    }

    /* ===== 卡片容器 ===== */
    .card {
        background: var(--md3-surface-container-low);
        border-radius: var(--md3-radius-xl);
        padding: var(--md3-spacing-2xl);
        margin-bottom: var(--md3-spacing-xl);
        box-shadow: var(--md3-elevation-1);
        border: 1px solid var(--md3-outline-variant);
        display: none; /* 默认隐藏，通过JS控制显示 */
    }
    
    .card.active {
        display: block;
        animation: fadeIn 0.3s ease-out;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .card-header {
        display: flex;
        align-items: center;
        gap: var(--md3-spacing-md);
        margin-bottom: var(--md3-spacing-lg);
        padding-bottom: var(--md3-spacing-lg);
        border-bottom: 2px solid var(--md3-outline-variant);
    }
    
    .card-header .material-icons {
        font-size: 1.5rem;
        color: var(--md3-primary);
    }
    
    .card-header h2 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 500;
        color: var(--md3-on-surface);
    }

    /* ===== 表单样式 ===== */
    .form-group {
        margin-bottom: var(--md3-spacing-lg);
    }
    
    .form-label {
        display: block;
        margin-bottom: var(--md3-spacing-xs);
        color: var(--md3-on-surface-variant);
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .form-control {
        width: 100%;
        padding: var(--md3-spacing-md);
        border: 1px solid var(--md3-outline);
        border-radius: var(--md3-radius-md);
        background: var(--md3-surface);
        color: var(--md3-on-surface);
        font-size: 1rem;
        transition: all 0.2s;
        box-sizing: border-box;
    }
    
    .form-control:focus {
        border-color: var(--md3-primary);
        box-shadow: 0 0 0 2px var(--md3-primary-container);
        outline: none;
    }
    
    .btn-primary {
        background: var(--md3-primary);
        color: var(--md3-on-primary);
        border: none;
        padding: var(--md3-spacing-md) var(--md3-spacing-xl);
        border-radius: var(--md3-radius-full);
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: var(--md3-spacing-sm);
    }
    
    .btn-primary:hover {
        box-shadow: var(--md3-elevation-2);
        opacity: 0.9;
    }

    /* ===== 头像上传样式 ===== */
    .avatar-preview-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: var(--md3-spacing-lg);
        padding: var(--md3-spacing-xl);
        background: var(--md3-surface);
        border-radius: var(--md3-radius-lg);
        border: 2px dashed var(--md3-outline-variant);
        margin-bottom: var(--md3-spacing-lg);
    }
    
    .current-avatar {
        width: 128px;
        height: 128px;
        border-radius: 50%;
        object-fit: cover;
        box-shadow: var(--md3-elevation-2);
        background: var(--md3-surface-container-high);
    }
    
    .avatar-placeholder {
        width: 128px;
        height: 128px;
        border-radius: 50%;
        background: var(--md3-primary-container);
        color: var(--md3-on-primary-container);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3rem;
        font-weight: bold;
    }
    
    .file-input-wrapper {
        position: relative;
        overflow: hidden;
        display: inline-block;
    }
    
    .file-input-wrapper input[type=file] {
        font-size: 100px;
        position: absolute;
        left: 0;
        top: 0;
        opacity: 0;
        cursor: pointer;
    }
    
    .upload-btn {
        background: var(--md3-secondary-container);
        color: var(--md3-on-secondary-container);
        padding: var(--md3-spacing-md) var(--md3-spacing-lg);
        border-radius: var(--md3-radius-lg);
        display: flex;
        align-items: center;
        gap: var(--md3-spacing-sm);
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .upload-btn:hover {
        background: var(--md3-secondary-container-hover, #e8def8);
        box-shadow: var(--md3-elevation-1);
    }

    /* Cropper Styles */
    .cropper-container {
        width: 260px;
        height: 260px;
        border: 1px solid var(--md3-outline);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--md3-surface);
        margin: 0 auto;
        overflow: hidden;
        touch-action: none;
        cursor: move;
    }
    
    .cropper-controls {
        margin-top: 1rem;
        width: 260px;
        margin-left: auto;
        margin-right: auto;
    }

    /* 移动端适配 */
    @media (max-width: 768px) {
        .page-header {
            padding: var(--md3-spacing-lg);
            flex-direction: column;
            text-align: center;
        }
        
        .tabs {
            overflow-x: auto;
            white-space: nowrap;
        }
        
        .card {
            padding: var(--md3-spacing-lg);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="profile-container">
    <div class="page-header">
        <span class="material-icons">account_circle</span>
        <div class="header-content">
            <h1>个人中心</h1>
        </div>
    </div>
    
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('info')">基本信息</button>
        <button class="tab-btn" onclick="switchTab('avatar')">头像设置</button>
        <button class="tab-btn" onclick="switchTab('security')">账号安全</button>
    </div>

    <!-- 基本信息卡片 -->
    <div id="tab-info" class="card active">
        <div class="card-header">
            <span class="material-icons">badge</span>
            <h2>修改个人资料</h2>
        </div>
        
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="update_info">
            
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">真实姓名</label>
                    <input type="text" name="real_name" class="form-control" value="{{ profile.real_name }}" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">邮箱</label>
                    <input type="email" name="email" class="form-control" value="{{ user.email }}" placeholder="用于找回密码和接收通知">
                </div>
                
                <div class="form-group">
                    <label class="form-label">手机号码</label>
                    <input type="tel" name="phone" class="form-control" value="{{ profile.phone }}" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">微信号</label>
                    <input type="text" name="wechat" class="form-control" value="{{ profile.wechat }}" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">学号</label>
                    <input type="text" name="student_id" class="form-control" value="{{ profile.student_id }}" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">政治面貌</label>
                    <select name="political_status" class="form-control" required>
                        <option value="">请选择</option>
                        {% for value, label in political_status_choices %}
                            <option value="{{ value }}" {% if profile.political_status == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="form-group" style="margin-top: 20px;">
                <label class="checkbox-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" name="is_info_public" {% if profile.is_info_public %}checked{% endif %} style="width: 20px; height: 20px;">
                    <span style="color: var(--md3-on-surface);">向其他用户公开我的联系方式</span>
                </label>
            </div>
            
            <div style="margin-top: 32px; text-align: right;">
                <button type="submit" class="btn-primary">
                    <span class="material-icons">save</span>
                    保存更改
                </button>
            </div>
        </form>
    </div>

    <!-- 头像设置卡片 -->
    <div id="tab-avatar" class="card">
        <div class="card-header">
            <span class="material-icons">face</span>
            <h2>修改头像</h2>
        </div>
        
        <form method="post" enctype="multipart/form-data" id="avatar-form">
            {% csrf_token %}
            <input type="hidden" name="action" value="upload_avatar">
            <input type="hidden" name="avatar_base64" id="avatar-base64">
            
            <div class="avatar-preview-container">
                <!-- 当前头像展示 -->
                <div id="current-avatar-view" {% if not profile.avatar %}style="display: none;"{% endif %}>
                    <img src="{% if profile.avatar %}{{ profile.avatar.url }}{% endif %}" alt="当前头像" class="current-avatar">
                    <p style="text-align: center; margin-top: 10px; color: var(--md3-on-surface-variant);">当前头像</p>
                </div>

                <!-- 默认占位符 -->
                <div id="avatar-placeholder" class="avatar-placeholder" {% if profile.avatar %}style="display: none;"{% endif %}>
                    {{ profile.real_name|first }}
                </div>
                
                <!-- 裁剪区域 (初始隐藏) -->
                <div id="cropper-wrapper" style="display: none; width: 100%;">
                    <div class="cropper-container">
                        <canvas id="cropper-canvas" width="256" height="256"></canvas>
                    </div>
                    <div class="cropper-controls">
                        <label class="form-label" style="text-align: center;">缩放图片</label>
                        <input type="range" id="cropper-zoom" min="1" max="3" step="0.01" value="1" class="form-control" style="padding: 0;">
                    </div>
                </div>
                
                <p style="color: var(--md3-on-surface-variant); margin: 0; text-align: center;">支持 JPG, PNG 格式，建议使用正方形图片</p>
                
                <div class="file-input-wrapper">
                    <div class="upload-btn">
                        <span class="material-icons">upload_file</span>
                        选择图片
                    </div>
                    <input type="file" name="avatar" accept="image/*" id="avatar-input">
                </div>
            </div>
            
            <div style="margin-top: 32px; text-align: right;">
                <button type="submit" class="btn-primary" id="save-avatar-btn">
                    <span class="material-icons">cloud_upload</span>
                    上传头像
                </button>
            </div>
        </form>
    </div>

    <!-- 账号安全卡片 -->
    <div id="tab-security" class="card">
        <div class="card-header">
            <span class="material-icons">security</span>
            <h2>账号安全设置</h2>
        </div>
        
        <!-- 修改用户名 -->
        <div style="margin-bottom: var(--md3-spacing-2xl);">
            <h3 style="font-size: 1.1rem; color: var(--md3-on-surface); margin-bottom: var(--md3-spacing-lg);">修改用户名</h3>
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="change_username">
                
                <div class="form-group">
                    <label class="form-label">新用户名</label>
                    <input type="text" name="new_username" class="form-control" value="{{ user.username }}" minlength="3" required>
                    <small style="color: var(--md3-on-surface-variant);">当前用户名: {{ user.username }}</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">当前密码</label>
                    <input type="password" name="password" class="form-control" placeholder="验证身份以修改用户名" required>
                </div>
                
                <div style="text-align: right;">
                    <button type="submit" class="btn-primary">
                        <span class="material-icons">badge</span>
                        修改用户名
                    </button>
                </div>
            </form>
        </div>
        
        <div style="border-top: 1px solid var(--md3-outline-variant); margin: var(--md3-spacing-xl) 0;"></div>
        
        <!-- 修改密码 -->
        <div>
            <h3 style="font-size: 1.1rem; color: var(--md3-on-surface); margin-bottom: var(--md3-spacing-lg);">修改密码</h3>
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="change_password">
                
                <div class="form-group">
                    <label class="form-label">当前密码</label>
                    <input type="password" name="old_password" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">新密码</label>
                    <input type="password" name="new_password" class="form-control" minlength="6" required>
                    <small style="color: var(--md3-on-surface-variant);">密码长度至少需6位</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">确认新密码</label>
                    <input type="password" name="confirm_password" class="form-control" minlength="6" required>
                </div>
                
                <div style="text-align: right;">
                    <button type="submit" class="btn-primary">
                        <span class="material-icons">lock_reset</span>
                        修改密码
                    </button>
                </div>
            </form>
        </div>
        
        <div style="border-top: 1px solid var(--md3-outline-variant); margin: var(--md3-spacing-xl) 0;"></div>
        
        <!-- 删除账户 -->
        <div>
            <h3 style="font-size: 1.1rem; color: var(--md3-error); margin-bottom: var(--md3-spacing-lg);">危险区域</h3>
            <p style="color: var(--md3-on-surface-variant); margin-bottom: var(--md3-spacing-md);">删除账户是不可逆的操作。所有相关数据将被永久删除。</p>
            <div style="text-align: right;">
                <button type="button" class="btn-primary" style="background: var(--md3-error); color: var(--md3-on-error);" onclick="document.getElementById('delete-account-modal').showModal()">
                    <span class="material-icons">delete_forever</span>
                    删除账户
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 删除账户确认模态框 -->
<dialog id="delete-account-modal" style="padding: 0; border: none; border-radius: 28px; background: var(--md3-surface-container-high); max-width: 400px; width: 90%;">
    <div style="padding: 24px;">
        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px; color: var(--md3-error);">
            <span class="material-icons" style="font-size: 24px;">warning</span>
            <h3 style="margin: 0; font-size: 24px;">确认删除账户？</h3>
        </div>
        <p style="margin-bottom: 24px; color: var(--md3-on-surface-variant);">
            此操作无法撤销。请输入您的用户名 <strong>{{ user.username }}</strong> 以确认删除。
        </p>
        <form action="{% url 'clubs:delete_account' %}" method="post">
            {% csrf_token %}
            <div class="form-group">
                <input type="text" name="confirm_username" class="form-control" placeholder="{{ user.username }}" required>
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 8px; margin-top: 24px;">
                <button type="button" class="btn-primary" style="background: transparent; color: var(--md3-primary); box-shadow: none;" onclick="document.getElementById('delete-account-modal').close()">取消</button>
                <button type="submit" class="btn-primary" style="background: var(--md3-error); color: var(--md3-on-error);">确认删除</button>
            </div>
        </form>
    </div>
</dialog>

<script>
    function switchTab(tabId) {
        // 隐藏所有卡片
        document.querySelectorAll('.card').forEach(card => {
            card.classList.remove('active');
        });
        
        // 取消所有标签激活状态
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // 激活选中的标签和卡片
        document.getElementById('tab-' + tabId).classList.add('active');
        event.currentTarget.classList.add('active');
    }

    // 头像裁剪逻辑
    (function() {
        var input = document.getElementById('avatar-input');
        var wrapper = document.getElementById('cropper-wrapper');
        var canvas = document.getElementById('cropper-canvas');
        var zoom = document.getElementById('cropper-zoom');
        var form = document.getElementById('avatar-form');
        var currentView = document.getElementById('current-avatar-view');
        var placeholder = document.getElementById('avatar-placeholder');
        var base64Input = document.getElementById('avatar-base64');
        
        if (!input || !wrapper || !canvas || !zoom || !form) {
            return;
        }
        
        var ctx = canvas.getContext('2d');
        var img = new Image();
        var imgReady = false;
        var dragging = false;
        var lastX = 0;
        var lastY = 0;
        var scale = 1;
        var minScale = 1;
        var offsetX = 0;
        var offsetY = 0;
        
        function clampOffsets() {
            var maxX = 0;
            var maxY = 0;
            var minX = canvas.width - img.width * scale;
            var minY = canvas.height - img.height * scale;
            
            if (img.width * scale < canvas.width) {
                minX = maxX = (canvas.width - img.width * scale) / 2;
            }
            if (img.height * scale < canvas.height) {
                minY = maxY = (canvas.height - img.height * scale) / 2;
            }
            
            offsetX = Math.min(maxX, Math.max(minX, offsetX));
            offsetY = Math.min(maxY, Math.max(minY, offsetY));
        }
        
        function draw() {
            if (!imgReady) {
                return;
            }
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, offsetX, offsetY, img.width * scale, img.height * scale);
        }
        
        function fitImage() {
            minScale = Math.max(canvas.width / img.width, canvas.height / img.height);
            scale = minScale;
            offsetX = (canvas.width - img.width * scale) / 2;
            offsetY = (canvas.height - img.height * scale) / 2;
            
            zoom.min = minScale.toFixed(4);
            zoom.max = (minScale * 3).toFixed(4);
            zoom.value = scale.toFixed(4);
            
            clampOffsets();
            draw();
        }
        
        function setScale(newScale) {
            var centerX = canvas.width / 2;
            var centerY = canvas.height / 2;
            var imgCenterX = (centerX - offsetX) / scale;
            var imgCenterY = (centerY - offsetY) / scale;
            
            scale = newScale;
            
            offsetX = centerX - imgCenterX * scale;
            offsetY = centerY - imgCenterY * scale;
            
            clampOffsets();
            draw();
        }
        
        input.addEventListener('change', function() {
            var file = input.files && input.files[0];
            if (!file) {
                return;
            }
            
            var reader = new FileReader();
            reader.onload = function(e) {
                img.onload = function() {
                    imgReady = true;
                    wrapper.style.display = 'block';
                    if (currentView) currentView.style.display = 'none';
                    if (placeholder) placeholder.style.display = 'none';
                    fitImage();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
        
        zoom.addEventListener('input', function() {
            if (!imgReady) return;
            setScale(parseFloat(zoom.value));
        });
        
        canvas.addEventListener('pointerdown', function(e) {
            if (!imgReady) return;
            dragging = true;
            lastX = e.clientX;
            lastY = e.clientY;
            canvas.setPointerCapture(e.pointerId);
            e.preventDefault(); // 防止滚动
        });
        
        canvas.addEventListener('pointermove', function(e) {
            if (!dragging || !imgReady) return;
            var dx = e.clientX - lastX;
            var dy = e.clientY - lastY;
            lastX = e.clientX;
            lastY = e.clientY;
            
            offsetX += dx;
            offsetY += dy;
            
            clampOffsets();
            draw();
        });
        
        canvas.addEventListener('pointerup', function(e) {
            dragging = false;
        });
        
        // 表单提交前将Canvas内容转换为Base64
        form.addEventListener('submit', function(e) {
            if (imgReady) {
                var dataURL = canvas.toDataURL('image/jpeg', 0.9);
                base64Input.value = dataURL;
            }
        });
    })();
</script>
{% endblock %}
