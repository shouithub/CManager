{% load static %}
<!DOCTYPE html>
<html lang="zh-hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=5, user-scalable=yes">
    <meta name="color-scheme" content="light dark">
    <meta name="format-detection" content="telephone=no">
    <title>{% block title %}社团管理系统{% endblock %}</title>
    <!-- 阻止页面闪烁：在CSS加载前立即设置主题 -->
    <script>
        (function() {
            var theme = localStorage.getItem('md3-theme-mode');
            if (!theme) {
                theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            }
            document.documentElement.setAttribute('data-theme', theme);
        })();
    </script>
    <link href="https://fonts.font.im/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/style.css' %}?v=20251207">
    <style>
        /* 防止移动设备自动缩放 */
        html, body {
            width: 100%;
            height: 100%;
            overflow-x: hidden;
        }
        body {
            position: relative;
        }
    </style>
    {% block extra_css %}{% endblock %}
    <script src="{% static 'js/theme-toggle.js' %}"></script>
</head>
<body>
    <!-- 遮罩层 (移动端) -->
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
    
    <!-- 左侧导航栏 -->
    <nav class="sidebar-nav" id="sidebar">
        <!-- 头部 -->
        <div class="sidebar-header">
            <span class="logo-icon"><span class="material-icons" style="font-size: 1.5em;">flag</span></span>
            <h1>社团管理系统</h1>
        </div>
        
        <!-- 导航菜单 -->
        <div class="sidebar-menu">
            {% if user.is_authenticated %}
                <!-- 通用导航 -->
                <div class="sidebar-menu-section">
                    <div class="sidebar-menu-title">主要功能</div>
                    {% if user.profile.role != 'president' %}
                        <a href="{% url 'clubs:index' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">home</span></span>
                            <span>首页</span>
                        </a>
                    {% endif %}
                    <a href="{% url 'clubs:public_activities' %}" class="sidebar-menu-item">
                        <span class="icon"><span class="material-icons">event</span></span>
                        <span>活动</span>
                    </a>
                    
                    {% if user.profile.role == 'admin' %}
                        <a href="{% url 'clubs:admin_dashboard' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">settings</span></span>
                            <span>管理后台</span>
                        </a>
                        <a href="{% url 'clubs:manage_users' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">group</span></span>
                            <span>用户管理</span>
                        </a>
                        <a href="{% url 'clubs:staff_management' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">business_center</span></span>
                            <span>社团管理</span>
                        </a>
                    {% elif user.profile.role == 'staff' %}
                        <a href="{% url 'clubs:staff_management' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">business_center</span></span>
                            <span>社团管理</span>
                        </a>
                        {% if user.profile.staff_level == 'director' and user.profile.department %}
                        <a href="{% url 'clubs:manage_department_staff' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">supervisor_account</span></span>
                            <span>部门管理</span>
                        </a>
                        {% endif %}
                    {% endif %}
                    
                    {% if user.profile.role == 'staff' or user.profile.role == 'admin' %}
                        <a href="{% url 'clubs:admin_booking_management' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">calendar_month</span></span>
                            <span>预约概览</span>
                        </a>
                    {% endif %}

                    {% if user.profile.role == 'president' %}
                        <a href="{% url 'clubs:user_dashboard' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">folder</span></span>
                            <span>我的社团</span>
                        </a>
                    {% endif %}
                </div>
                
                {% if user.profile.role == 'staff' or user.profile.role == 'admin' %}


                <div class="sidebar-menu-section">
                    <div class="sidebar-menu-title collapsible" onclick="toggleMenuSection(this)">
                        <span>审核中心</span>
                        <span class="material-icons expand-icon">expand_more</span>
                    </div>
                    <div class="sidebar-menu-items">
                        <a href="{% url 'clubs:staff_audit_center' 'annual-review' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">assignment</span></span>
                            <span>年审材料</span>
                            {% if audit_center_counts.annual_review > 0 %}
                            <span class="badge-count">{{ audit_center_counts.annual_review }}</span>
                            {% endif %}
                        </a>
                        <a href="{% url 'clubs:staff_audit_center' 'registration' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">add_circle</span></span>
                            <span>社团注册</span>
                            {% if audit_center_counts.registration > 0 %}
                            <span class="badge-count">{{ audit_center_counts.registration }}</span>
                            {% endif %}
                        </a>
                        <a href="{% url 'clubs:staff_audit_center' 'application' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">create</span></span>
                            <span>新社团申请</span>
                            {% if audit_center_counts.application > 0 %}
                            <span class="badge-count">{{ audit_center_counts.application }}</span>
                            {% endif %}
                        </a>
                        <a href="{% url 'clubs:staff_audit_center' 'reimbursement' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">receipt</span></span>
                            <span>报销申请</span>
                            {% if audit_center_counts.reimbursement > 0 %}
                            <span class="badge-count">{{ audit_center_counts.reimbursement }}</span>
                            {% endif %}
                        </a>
                        <a href="{% url 'clubs:staff_audit_center' 'activity-application' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">event</span></span>
                            <span>活动申请</span>
                            {% if audit_center_counts.activity_application > 0 %}
                            <span class="badge-count">{{ audit_center_counts.activity_application }}</span>
                            {% endif %}
                        </a>
                        <a href="{% url 'clubs:staff_audit_center' 'president-transition' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">swap_horiz</span></span>
                            <span>社长换届</span>
                            {% if audit_center_counts.president_transition > 0 %}
                            <span class="badge-count">{{ audit_center_counts.president_transition }}</span>
                            {% endif %}
                        </a>
                    </div>
                </div>
                {% endif %}

                <!-- 审批中心 - 仅社长可见（折叠式） -->
                {% if user.profile.role == 'president' %}
                <div class="sidebar-menu-section">
                    <div class="sidebar-menu-title collapsible" onclick="toggleMenuSection(this)">
                        <span>审批中心</span>
                        <span class="material-icons expand-icon">expand_more</span>
                    </div>
                    <div class="sidebar-menu-items">
                        <a href="{% url 'clubs:approval_center' 'annual_review' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">assignment</span></span>
                            <span>年审记录</span>
                            {% if unread_approval_counts.annual_review > 0 %}
                            <span class="badge-count">{{ unread_approval_counts.annual_review }}</span>
                            {% endif %}
                        </a>
                        <a href="{% url 'clubs:approval_center' 'registration' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">add_circle</span></span>
                            <span>社团注册</span>
                            {% if unread_approval_counts.registration > 0 %}
                            <span class="badge-count">{{ unread_approval_counts.registration }}</span>
                            {% endif %}
                        </a>
                        <a href="{% url 'clubs:approval_center' 'application' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">create</span></span>
                            <span>社团申请</span>
                            {% if unread_approval_counts.application > 0 %}
                            <span class="badge-count">{{ unread_approval_counts.application }}</span>
                            {% endif %}
                        </a>
                        <a href="{% url 'clubs:approval_center' 'reimbursement' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">receipt</span></span>
                            <span>报销记录</span>
                            {% if unread_approval_counts.reimbursement > 0 %}
                            <span class="badge-count">{{ unread_approval_counts.reimbursement }}</span>
                            {% endif %}
                        </a>
                        <a href="{% url 'clubs:approval_center' 'activity_application' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">event</span></span>
                            <span>活动申请</span>
                            {% if unread_approval_counts.activity > 0 %}
                            <span class="badge-count">{{ unread_approval_counts.activity }}</span>
                            {% endif %}
                        </a>
                        <a href="{% url 'clubs:approval_center' 'president_transition' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">swap_horiz</span></span>
                            <span>社长换届</span>
                            {% if unread_approval_counts.transition > 0 %}
                            <span class="badge-count">{{ unread_approval_counts.transition }}</span>
                            {% endif %}
                        </a>
                    </div>
                </div>
                {% endif %}
                
                <!-- 房间管理 - 仅社长和干事可见 -->
                {% if user.profile.role == 'president' or user.profile.role == 'staff' or user.profile.role == 'admin' %}
                <div class="sidebar-menu-section">
                    <div class="sidebar-menu-title collapsible" onclick="toggleMenuSection(this)">
                        <span>房间管理</span>
                        <span class="material-icons expand-icon">expand_more</span>
                    </div>
                    <div class="sidebar-menu-items">
                        <a href="{% url 'clubs:room_calendar' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">event</span></span>
                            <span>房间日历</span>
                        </a>
                        <a href="{% url 'clubs:my_room_bookings' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">list</span></span>
                            <span>我的预约</span>
                        </a>
                    </div>
                </div>
                {% endif %}
            {% endif %}
        </div>
        
        <!-- 底部 (用户信息) -->
        {% if user.is_authenticated %}
        <div class="sidebar-footer">
            <div class="sidebar-user" onclick="toggleUserDropdown()">
                <div class="sidebar-user-avatar">
                    <span class="material-icons">person</span>
                </div>
                <div class="sidebar-user-info">
                    <div class="sidebar-user-name">{{ user.username }}</div>
                    <div class="sidebar-user-role">
                        {% if user.profile.role == 'admin' %}
                            管理员
                        {% elif user.profile.role == 'staff' %}
                            干事
                        {% elif user.profile.role == 'president' %}
                            社长
                        {% endif %}
                    </div>
                </div>
                <span class="dropdown-arrow"></span>
            </div>
            
            <div class="sidebar-user-dropdown" id="userDropdown">
                <a href="{% url 'clubs:change_account_settings' %}">
                    <span><span class="material-icons" style="vertical-align: middle;">lock</span></span>
                    <span>修改账户设置</span>
                </a>
                <a href="{% url 'clubs:edit_profile' %}">
                    <span><span class="material-icons" style="vertical-align: middle;">person</span></span>
                    <span>修改个人信息</span>
                </a>
                <a href="{% url 'clubs:logout' %}" class="logout">
                    <span><span class="material-icons" style="vertical-align: middle;">lock_open</span></span>
                    <span>登出</span>
                </a>
            </div>
            
            <div class="sidebar-theme-toggle" onclick="toggleTheme()" title="切换主题">
                <span id="theme-icon" class="material-icons">brightness_4</span>
                <span class="theme-text">切换主题</span>
            </div>
        </div>
        {% endif %}
    </nav>
    <script>
        (function() {
            // 立即恢复侧边栏折叠状态，防止页面闪烁
            // Restore collapsed state immediately to prevent flicker
            function initMenuSections() {
                const collapsibleTitles = document.querySelectorAll('.sidebar-menu-title.collapsible');
                collapsibleTitles.forEach(title => {
                    const sectionName = title.textContent.trim().split('\n')[0].trim();
                    let shouldCollapse = localStorage.getItem(`sidebar-${sectionName}-collapsed`);
                    
                    // 默认折叠逻辑 (Default collapse logic)
                    if (sectionName === '房间管理' && shouldCollapse === null) shouldCollapse = 'false';
                    if (sectionName === '审批中心' && shouldCollapse === null) shouldCollapse = 'false';
                    if (sectionName === '审核中心' && shouldCollapse === null) shouldCollapse = 'false';
                    
                    if (shouldCollapse === 'true') {
                        title.classList.add('collapsed');
                        const items = title.parentElement.querySelector('.sidebar-menu-items');
                        if (items) items.classList.add('collapsed');
                    }
                });
            }
            initMenuSections();

            // 恢复侧边栏滚动位置
            // Restore sidebar scroll position
            const sidebarMenu = document.querySelector('.sidebar-menu');
            if (sidebarMenu) {
                const savedScroll = localStorage.getItem('sidebar-menu-scroll-position');
                if (savedScroll) {
                    sidebarMenu.scrollTop = parseInt(savedScroll, 10);
                }

                // 保存滚动位置 (Save scroll position)
                sidebarMenu.addEventListener('scroll', function() {
                    localStorage.setItem('sidebar-menu-scroll-position', sidebarMenu.scrollTop);
                });
            }
        })();
    </script>
    
    <!-- 主内容区 -->
    <div class="main-wrapper" id="mainWrapper">
        <div class="main-content">
            {% if messages %}
            <div class="messages-container">
                {% for message in messages %}
                <div class="message {% if message.tags %}{{ message.tags }}{% endif %}">
                    {{ message }}
                </div>
                {% endfor %}
            </div>
            {% endif %}

            {% block content %}{% endblock %}
        </div>
        
        <footer>
            <p>上海海洋大学社团管理服务中心 技术支持</p>
        </footer>
    </div>
    
    <!-- 底部导航栏 (移动端) -->
    {% if user.is_authenticated %}
    <nav class="bottom-nav">
        <div class="bottom-nav-items">
            {% if user.profile.role != 'president' %}
                <a href="{% url 'clubs:index' %}" class="bottom-nav-item">
                    <span class="icon"><span class="material-icons">home</span></span>
                    <span>首页</span>
                </a>
            {% endif %}
            
            {% if user.profile.role == 'admin' %}
                <a href="{% url 'clubs:admin_dashboard' %}" class="bottom-nav-item">
                    <span class="icon"><span class="material-icons">settings</span></span>
                    <span>管理</span>
                </a>
                <a href="{% url 'clubs:staff_audit_center_mobile' %}" class="bottom-nav-item">
                    <span class="icon">
                        <span class="material-icons">check_circle</span>
                        {% with total=audit_center_counts.annual_review|add:audit_center_counts.registration|add:audit_center_counts.application|add:audit_center_counts.reimbursement|add:audit_center_counts.activity_application|add:audit_center_counts.president_transition %}
                        {% if total > 0 %}
                        <span class="nav-badge">{{ total }}</span>
                        {% endif %}
                        {% endwith %}
                    </span>
                    <span>审核</span>
                </a>
                <a href="{% url 'clubs:staff_management' %}" class="bottom-nav-item">
                    <span class="icon"><span class="material-icons">business_center</span></span>
                    <span>社团</span>
                </a>
            {% elif user.profile.role == 'staff' %}
                <a href="{% url 'clubs:staff_audit_center_mobile' %}" class="bottom-nav-item">
                    <span class="icon">
                        <span class="material-icons">check_circle</span>
                        {% with total=audit_center_counts.annual_review|add:audit_center_counts.registration|add:audit_center_counts.application|add:audit_center_counts.reimbursement|add:audit_center_counts.activity_application|add:audit_center_counts.president_transition %}
                        {% if total > 0 %}
                        <span class="nav-badge">{{ total }}</span>
                        {% endif %}
                        {% endwith %}
                    </span>
                    <span>审核</span>
                </a>
                <a href="{% url 'clubs:staff_management' %}" class="bottom-nav-item">
                    <span class="icon"><span class="material-icons">business_center</span></span>
                    <span>社团</span>
                </a>
            {% elif user.profile.role == 'president' %}
                <a href="{% url 'clubs:user_dashboard' %}" class="bottom-nav-item">
                    <span class="icon"><span class="material-icons">folder</span></span>
                    <span>我的</span>
                </a>
                <a href="{% url 'clubs:approval_center_mobile' %}" class="bottom-nav-item">
                    <span class="icon">
                        <span class="material-icons">check_circle</span>
                        {% if unread_approval_counts.total > 0 %}
                        <span class="nav-badge">{{ unread_approval_counts.total }}</span>
                        {% endif %}
                    </span>
                    <span>审批</span>
                </a>
            {% endif %}
            
            <a href="javascript:void(0)" class="bottom-nav-item" onclick="toggleSidebar()">
                <span class="icon"><span class="material-icons">person</span></span>
                <span>用户</span>
            </a>
        </div>
    </nav>
    {% endif %}

    <script src="{% static 'js/main.js' %}"></script>
    <script>
        (function() {
            /* 修复后的单一脚本：
               - 防止页面水平溢出
               - 切换侧边栏/用户下拉/菜单折叠
               - 初始化折叠与高亮
            */
            function checkOverflow() {
                const body = document.body;
                if (body.scrollWidth > window.innerWidth) {
                    const elements = document.querySelectorAll('*');
                    elements.forEach(el => {
                        const rect = el.getBoundingClientRect();
                        if (rect.right > window.innerWidth || rect.left < 0) {
                            if (el.style.overflow !== 'auto' && el.style.overflow !== 'scroll') {
                                el.style.maxWidth = '100vw';
                                el.style.overflowX = 'hidden';
                            }
                        }
                    });
                }
            }

            function toggleSidebar() {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.querySelector('.sidebar-overlay');
                if (sidebar) sidebar.classList.toggle('active');
                if (overlay) overlay.classList.toggle('active');
            }

            function toggleUserDropdown() {
                const dropdown = document.getElementById('userDropdown');
                if (dropdown) dropdown.classList.toggle('active');
            }

            function toggleMenuSection(titleElement) {
                const section = titleElement.parentElement;
                const items = section.querySelector('.sidebar-menu-items');
                titleElement.classList.toggle('collapsed');
                if (items) items.classList.toggle('collapsed');

                const sectionName = titleElement.textContent.trim().split('\n')[0].trim();
                localStorage.setItem(`sidebar-${sectionName}-collapsed`, titleElement.classList.contains('collapsed'));
            }

            document.addEventListener('click', function(event) {
                const userDropdown = document.getElementById('userDropdown');
                const userButton = event.target.closest('.sidebar-user');
                if (userDropdown && !userButton && userDropdown.classList.contains('active')) {
                    userDropdown.classList.remove('active');
                }
            });

            window.toggleSidebar = toggleSidebar;
            window.toggleUserDropdown = toggleUserDropdown;
            window.toggleMenuSection = toggleMenuSection;

            document.addEventListener('DOMContentLoaded', function() {
                checkOverflow();
                window.addEventListener('resize', checkOverflow);

                // 高亮当前页面
                const currentPath = window.location.pathname;
                const menuItems = document.querySelectorAll('.sidebar-menu-item, .bottom-nav-item');
                menuItems.forEach(item => { try { if (item.getAttribute('href') === currentPath) item.classList.add('active'); } catch (e) {} });
            });
        })();
    </script>
    {% block extra_js %}{% endblock %}
</body>
</html>
