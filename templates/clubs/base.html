{% load static %}
<!DOCTYPE html>
<html lang="zh-hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=5, user-scalable=yes">
    <meta name="color-scheme" content="light dark">
    <meta name="format-detection" content="telephone=no">
    <title>{% block title %}ç¤¾å›¢ç®¡ç†ç³»ç»Ÿ{% endblock %}</title>
    <link href="https://cdn.bootcss.com/material-design-icons/3.0.1/iconfont/material-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/style.css' %}?v=20251207">
    <style>
        /* é˜²æ­¢ç§»åŠ¨è®¾å¤‡è‡ªåŠ¨ç¼©æ”¾ */
        html, body {
            width: 100%;
            height: 100%;
            overflow-x: hidden;
        }
        body {
            position: relative;
        }
    </style>
    {% block extra_css %}{% endblock %}
    <script src="{% static 'js/theme-toggle.js' %}"></script>
</head>
<body>
    <!-- é®ç½©å±‚ (ç§»åŠ¨ç«¯) -->
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
    
    <!-- å·¦ä¾§å¯¼èˆªæ  -->
    <nav class="sidebar-nav" id="sidebar">
        <!-- å¤´éƒ¨ -->
        <div class="sidebar-header">
            <span class="logo-icon"><span class="material-icons" style="font-size: 1.5em;">flag</span></span>
            <h1>ç¤¾å›¢ç®¡ç†ç³»ç»Ÿ</h1>
        </div>
        
        <!-- å¯¼èˆªèœå• -->
        <div class="sidebar-menu">
            {% if user.is_authenticated %}
                <!-- é€šç”¨å¯¼èˆª -->
                <div class="sidebar-menu-section">
                    <div class="sidebar-menu-title">ä¸»è¦åŠŸèƒ½</div>
                    <a href="{% url 'clubs:index' %}" class="sidebar-menu-item">
                        <span class="icon"><span class="material-icons">home</span></span>
                        <span>é¦–é¡µ</span>
                    </a>
                    <a href="{% url 'clubs:public_activities' %}" class="sidebar-menu-item">
                        <span class="icon"><span class="material-icons">event</span></span>
                        <span>æ´»åŠ¨</span>
                    </a>
                    
                    {% if user.profile.role == 'admin' %}
                        <a href="{% url 'clubs:admin_dashboard' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">settings</span></span>
                            <span>ç®¡ç†åå°</span>
                        </a>
                        <a href="{% url 'clubs:manage_users' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">group</span></span>
                            <span>ç”¨æˆ·ç®¡ç†</span>
                        </a>
                        <a href="{% url 'clubs:staff_dashboard' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">check_circle</span></span>
                            <span>å®¡æ ¸ä¸­å¿ƒ</span>
                        </a>
                        <a href="{% url 'clubs:staff_management' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">business_center</span></span>
                            <span>ç¤¾å›¢ç®¡ç†</span>
                        </a>
                        <a href="{% url 'clubs:publish_announcement' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">book</span></span>
                            <span>å‘å¸ƒå…¬å‘Š</span>
                        </a>
                    {% elif user.profile.role == 'staff' %}
                        <a href="{% url 'clubs:staff_dashboard' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">check_circle</span></span>
                            <span>å®¡æ ¸ä¸­å¿ƒ</span>
                        </a>
                        <a href="{% url 'clubs:staff_management' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">business_center</span></span>
                            <span>ç¤¾å›¢ç®¡ç†</span>
                        </a>
                    {% elif user.profile.role == 'teacher' %}
                        <a href="{% url 'clubs:teacher_dashboard' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">school</span></span>
                            <span>å·¥ä½œå°</span>
                        </a>
                    {% elif user.profile.role == 'president' %}
                        <a href="{% url 'clubs:user_dashboard' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">folder</span></span>
                            <span>æˆ‘çš„ç¤¾å›¢</span>
                        </a>
                        <a href="{% url 'clubs:approval_center' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">check_circle</span></span>
                            <span>å®¡æ‰¹ä¸­å¿ƒ</span>
                            {% if unread_approval_counts.total > 0 %}
                            <span class="badge-count">{{ unread_approval_counts.total }}</span>
                            {% endif %}
                        </a>
                    {% else %}
                        <!-- æ™®é€šç”¨æˆ·åªèƒ½çœ‹åˆ°æ´»åŠ¨åˆ—è¡¨ -->
                    {% endif %}
                </div>
                
                <!-- 222æˆ¿é—´å€Ÿç”¨ - ä»…ç¤¾é•¿å’Œå¹²äº‹å¯è§ -->
                {% if user.profile.role == 'president' or user.profile.role == 'staff' or user.profile.role == 'admin' %}
                <div class="sidebar-menu-section">
                    <div class="sidebar-menu-title">æˆ¿é—´ç®¡ç†</div>
                    <a href="{% url 'clubs:room222_calendar' %}" class="sidebar-menu-item">
                        <span class="icon"><span class="material-icons">event</span></span>
                        <span>222æˆ¿é—´æ—¥å†</span>
                    </a>
                    <a href="{% url 'clubs:submit_room222_booking' %}" class="sidebar-menu-item">
                        <span class="icon"><span class="material-icons">add_circle</span></span>
                        <span>é¢„çº¦æˆ¿é—´</span>
                    </a>
                    <a href="{% url 'clubs:my_room222_bookings' %}" class="sidebar-menu-item">
                        <span class="icon"><span class="material-icons">list</span></span>
                        <span>æˆ‘çš„é¢„çº¦</span>
                    </a>
                </div>
                {% endif %}
            {% endif %}
        </div>
        
        <!-- åº•éƒ¨ (ç”¨æˆ·ä¿¡æ¯) -->
        {% if user.is_authenticated %}
        <div class="sidebar-footer">
            <div class="sidebar-user" onclick="toggleUserDropdown()">
                <div class="sidebar-user-avatar">
                    <span class="material-icons">person</span>
                </div>
                <div class="sidebar-user-info">
                    <div class="sidebar-user-name">{{ user.username }}</div>
                    <div class="sidebar-user-role">
                        {% if user.profile.role == 'admin' %}
                            ç®¡ç†å‘˜
                        {% elif user.profile.role == 'staff' %}
                            å¹²äº‹
                        {% elif user.profile.role == 'teacher' %}
                            è€å¸ˆ
                        {% elif user.profile.role == 'president' %}
                            ç¤¾é•¿
                        {% else %}
                            æ™®é€šç”¨æˆ·
                        {% endif %}
                    </div>
                </div>
                <span class="dropdown-arrow">â–²</span>
            </div>
            
            <div class="sidebar-user-dropdown" id="userDropdown">
                <a href="{% url 'clubs:change_account_settings' %}">
                    <span><span class="material-icons" style="vertical-align: middle;">lock</span></span>
                    <span>ä¿®æ”¹è´¦æˆ·è®¾ç½®</span>
                </a>
                <a href="{% url 'clubs:edit_profile' %}">
                    <span><span class="material-icons" style="vertical-align: middle;">person</span></span>
                    <span>ä¿®æ”¹ä¸ªäººä¿¡æ¯</span>
                </a>
                <a href="{% url 'clubs:logout' %}" class="logout">
                    <span><span class="material-icons" style="vertical-align: middle;">lock_open</span></span>
                    <span>ç™»å‡º</span>
                </a>
            </div>
            
            <div class="sidebar-theme-toggle" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">
                <span id="theme-icon">ğŸŒ™</span>
                <span class="theme-text">åˆ‡æ¢ä¸»é¢˜</span>
            </div>
        </div>
        {% endif %}
    </nav>
    
    <!-- ä¸»å†…å®¹åŒº -->
    <div class="main-wrapper" id="mainWrapper">
        <div class="main-content">
            {% if messages %}
            <div class="messages-container">
                {% for message in messages %}
                <div class="message {% if message.tags %}{{ message.tags }}{% endif %}">
                    {{ message }}
                </div>
                {% endfor %}
            </div>
            {% endif %}

            {% block content %}{% endblock %}
        </div>
        
        <footer>
            <p>ä¸Šæµ·æµ·æ´‹å¤§å­¦ç¤¾å›¢ç®¡ç†æœåŠ¡ä¸­å¿ƒ æŠ€æœ¯æ”¯æŒ</p>
        </footer>
    </div>
    
    <!-- åº•éƒ¨å¯¼èˆªæ  (ç§»åŠ¨ç«¯) -->
    {% if user.is_authenticated %}
    <nav class="bottom-nav">
        <div class="bottom-nav-items">
            <a href="{% url 'clubs:index' %}" class="bottom-nav-item">
                <span class="icon"><span class="material-icons">home</span></span>
                <span>é¦–é¡µ</span>
            </a>
            
            {% if user.profile.role == 'admin' %}
                <a href="{% url 'clubs:admin_dashboard' %}" class="bottom-nav-item">
                    <span class="icon"><span class="material-icons">settings</span></span>
                    <span>ç®¡ç†</span>
                </a>
                <a href="{% url 'clubs:staff_dashboard' %}" class="bottom-nav-item">
                    <span class="icon"><span class="material-icons">check_circle</span></span>
                    <span>å®¡æ ¸</span>
                </a>
                <a href="{% url 'clubs:staff_management' %}" class="bottom-nav-item">
                    <span class="icon"><span class="material-icons">business_center</span></span>
                    <span>ç¤¾å›¢</span>
                </a>
            {% elif user.profile.role == 'staff' %}
                <a href="{% url 'clubs:staff_dashboard' %}" class="bottom-nav-item">
                    <span class="icon"><span class="material-icons">check_circle</span></span>
                    <span>å®¡æ ¸</span>
                </a>
                <a href="{% url 'clubs:staff_management' %}" class="bottom-nav-item">
                    <span class="icon"><span class="material-icons">business_center</span></span>
                    <span>ç¤¾å›¢</span>
                </a>
            {% elif user.profile.role == 'teacher' %}
                <a href="{% url 'clubs:teacher_dashboard' %}" class="bottom-nav-item">
                    <span class="icon"><span class="material-icons">school</span></span>
                    <span>å·¥ä½œå°</span>
                </a>
                <a href="{% url 'clubs:public_activities' %}" class="bottom-nav-item">
                    <span class="icon"><span class="material-icons">event</span></span>
                    <span>æ´»åŠ¨</span>
                </a>
            {% elif user.profile.role == 'president' %}
                <a href="{% url 'clubs:user_dashboard' %}" class="bottom-nav-item">
                    <span class="icon"><span class="material-icons">folder</span></span>
                    <span>æˆ‘çš„</span>
                </a>
                <a href="{% url 'clubs:approval_center' %}" class="bottom-nav-item">
                    <span class="icon"><span class="material-icons">check_circle</span></span>
                    <span>å®¡æ‰¹</span>
                </a>
            {% else %}
                <!-- æ™®é€šç”¨æˆ· -->
                <a href="{% url 'clubs:public_activities' %}" class="bottom-nav-item">
                    <span class="icon"><span class="material-icons">event</span></span>
                    <span>æ´»åŠ¨</span>
                </a>
            {% endif %}
            
            <a href="javascript:void(0)" class="bottom-nav-item" onclick="toggleSidebar()">
                <span class="icon"><span class="material-icons">person</span></span>
                <span>æˆ‘</span>
            </a>
        </div>
    </nav>
    {% endif %}

    <script src="{% static 'js/main.js' %}"></script>
    <script>
        // é˜²æ­¢ç§»åŠ¨è®¾å¤‡è‡ªåŠ¨ç¼©æ”¾
        document.addEventListener('DOMContentLoaded', function() {
            // ç¡®ä¿æ²¡æœ‰å­å…ƒç´ è¶…å‡ºè§†å£å®½åº¦
            const checkOverflow = function() {
                const body = document.body;
                const html = document.documentElement;
                
                if (body.scrollWidth > window.innerWidth) {
                    // æ‰¾å‡ºå¯¼è‡´æº¢å‡ºçš„å…ƒç´ 
                    const elements = document.querySelectorAll('*');
                    elements.forEach(el => {
                        const rect = el.getBoundingClientRect();
                        if (rect.right > window.innerWidth || rect.left < 0) {
                            // ç¡®ä¿å…ƒç´ åœ¨è§†å£å†…
                            if (el.style.overflow !== 'auto' && el.style.overflow !== 'scroll') {
                                el.style.maxWidth = '100vw';
                                el.style.overflowX = 'hidden';
                            }
                        }
                    });
                }
            };
            
            // é¦–æ¬¡åŠ è½½æ—¶æ£€æŸ¥
            checkOverflow();
            
            // çª—å£å¤§å°æ”¹å˜æ—¶æ£€æŸ¥
            window.addEventListener('resize', checkOverflow);
        });

        // åˆ‡æ¢ä¾§è¾¹æ æ˜¾ç¤º/éšè—
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }
        
        // åˆ‡æ¢ç”¨æˆ·ä¸‹æ‹‰èœå•
        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('active');
        }
        
        // ç‚¹å‡»ä¾§è¾¹æ å¤–éƒ¨å…³é—­
        document.addEventListener('click', function(event) {
            const sidebar = document.getElementById('sidebar');
            const menuToggle = document.querySelector('.menu-toggle');
            const userDropdown = document.getElementById('userDropdown');
            const userButton = event.target.closest('.sidebar-user');
            
            // å…³é—­ç”¨æˆ·ä¸‹æ‹‰èœå•
            if (userDropdown && !userButton && userDropdown.classList.contains('active')) {
                userDropdown.classList.remove('active');
            }
        });
        
        // é«˜äº®å½“å‰é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            const currentPath = window.location.pathname;
            const menuItems = document.querySelectorAll('.sidebar-menu-item, .bottom-nav-item');
            
            menuItems.forEach(item => {
                if (item.getAttribute('href') === currentPath) {
                    item.classList.add('active');
                }
            });
        });
    </script>
    {% block extra_js %}{% endblock %}
</body>
</html>
