{% load static %}
<!DOCTYPE html>
<html lang="zh-hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=5, user-scalable=yes">
    <meta name="color-scheme" content="light dark">
    <meta name="format-detection" content="telephone=no">
    <title>{% block title %}ç¤¾å›¢ç®¡ç†ç³»ç»Ÿ{% endblock %}</title>
    <link href="https://cdn.bootcss.com/material-design-icons/3.0.1/iconfont/material-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/style.css' %}?v=20251207">
    <style>
        /* é˜²æ­¢ç§»åŠ¨è®¾å¤‡è‡ªåŠ¨ç¼©æ”¾ */
        html, body {
            width: 100%;
            height: 100%;
            overflow-x: hidden;
        }
        body {
            position: relative;
        }
    </style>
    {% block extra_css %}{% endblock %}
    <script src="{% static 'js/theme-toggle.js' %}"></script>
</head>
<body>
    <!-- é®ç½©å±‚ (ç§»åŠ¨ç«¯) -->
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
    
    <!-- å·¦ä¾§å¯¼èˆªæ  -->
    <nav class="sidebar-nav" id="sidebar">
        <!-- å¤´éƒ¨ -->
        <div class="sidebar-header">
            <span class="logo-icon"><span class="material-icons" style="font-size: 1.5em;">flag</span></span>
            <h1>ç¤¾å›¢ç®¡ç†ç³»ç»Ÿ</h1>
        </div>
        
        <!-- å¯¼èˆªèœå• -->
        <div class="sidebar-menu">
            {% if user.is_authenticated %}
                <!-- é€šç”¨å¯¼èˆª -->
                <div class="sidebar-menu-section">
                    <div class="sidebar-menu-title">ä¸»è¦åŠŸèƒ½</div>
                    {% if user.profile.role != 'president' %}
                        <a href="{% url 'clubs:index' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">home</span></span>
                            <span>é¦–é¡µ</span>
                        </a>
                    {% endif %}
                    <a href="{% url 'clubs:public_activities' %}" class="sidebar-menu-item">
                        <span class="icon"><span class="material-icons">event</span></span>
                        <span>æ´»åŠ¨</span>
                    </a>
                    
                    {% if user.profile.role == 'admin' %}
                        <a href="{% url 'clubs:admin_dashboard' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">settings</span></span>
                            <span>ç®¡ç†åå°</span>
                        </a>
                        <a href="{% url 'clubs:manage_users' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">group</span></span>
                            <span>ç”¨æˆ·ç®¡ç†</span>
                        </a>
                        <a href="{% url 'clubs:staff_management' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">business_center</span></span>
                            <span>ç¤¾å›¢ç®¡ç†</span>
                        </a>
                        <a href="{% url 'clubs:publish_announcement' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">book</span></span>
                            <span>å‘å¸ƒå…¬å‘Š</span>
                        </a>
                    {% elif user.profile.role == 'staff' %}
                        <a href="{% url 'clubs:staff_management' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">business_center</span></span>
                            <span>ç¤¾å›¢ç®¡ç†</span>
                        </a>
                        {% if user.profile.staff_level == 'director' and user.profile.department %}
                        <a href="{% url 'clubs:manage_department_staff' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">supervisor_account</span></span>
                            <span>éƒ¨é—¨ç®¡ç†</span>
                        </a>
                        {% endif %}
                    {% elif user.profile.role == 'president' %}
                        <a href="{% url 'clubs:user_dashboard' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">folder</span></span>
                            <span>æˆ‘çš„ç¤¾å›¢</span>
                        </a>
                    {% else %}
                        <!-- æ™®é€šç”¨æˆ·åªèƒ½çœ‹åˆ°æ´»åŠ¨åˆ—è¡¨ -->
                    {% endif %}
                </div>
                
                {% if user.profile.role == 'staff' or user.profile.role == 'admin' %}
                <div class="sidebar-menu-section">
                    <div class="sidebar-menu-title collapsible" onclick="toggleMenuSection(this)">
                        <span>å®¡æ ¸ä¸­å¿ƒ</span>
                        <span class="material-icons expand-icon">expand_more</span>
                    </div>
                    <div class="sidebar-menu-items">
                        <a href="{% url 'clubs:staff_audit_center' 'annual_review' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">assignment</span></span>
                            <span>å¹´å®¡ææ–™</span>
                        </a>
                        <a href="{% url 'clubs:staff_audit_center' 'registration' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">add_circle</span></span>
                            <span>ç¤¾å›¢æ³¨å†Œ</span>
                        </a>
                        <a href="{% url 'clubs:staff_audit_center' 'application' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">create</span></span>
                            <span>æ–°ç¤¾å›¢ç”³è¯·</span>
                        </a>
                        <a href="{% url 'clubs:staff_audit_center' 'reimbursement' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">receipt</span></span>
                            <span>æŠ¥é”€ç”³è¯·</span>
                        </a>
                        <a href="{% url 'clubs:staff_audit_center' 'activity_application' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">event</span></span>
                            <span>æ´»åŠ¨ç”³è¯·</span>
                        </a>
                        <a href="{% url 'clubs:staff_audit_center' 'president_transition' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">swap_horiz</span></span>
                            <span>ç¤¾é•¿æ¢å±Š</span>
                        </a>
                    </div>
                </div>
                {% endif %}

                <!-- å®¡æ‰¹ä¸­å¿ƒ - ä»…ç¤¾é•¿å¯è§ï¼ˆæŠ˜å å¼ï¼‰ -->
                {% if user.profile.role == 'president' %}
                <div class="sidebar-menu-section">
                    <div class="sidebar-menu-title collapsible" onclick="toggleMenuSection(this)">
                        <span>å®¡æ‰¹ä¸­å¿ƒ</span>
                        {% if unread_approval_counts.total > 0 %}
                        <span class="badge-count">{{ unread_approval_counts.total }}</span>
                        {% endif %}
                        <span class="material-icons expand-icon">expand_more</span>
                    </div>
                    <div class="sidebar-menu-items">
                        <a href="{% url 'clubs:approval_center' 'annual_review' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">assignment</span></span>
                            <span>å¹´å®¡è®°å½•</span>
                        </a>
                        <a href="{% url 'clubs:approval_center' 'registration' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">add_circle</span></span>
                            <span>ç¤¾å›¢æ³¨å†Œ</span>
                        </a>
                        <a href="{% url 'clubs:approval_center' 'application' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">create</span></span>
                            <span>ç¤¾å›¢ç”³è¯·</span>
                        </a>
                        <a href="{% url 'clubs:approval_center' 'reimbursement' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">receipt</span></span>
                            <span>æŠ¥é”€è®°å½•</span>
                        </a>
                        <a href="{% url 'clubs:approval_center' 'activity_application' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">event</span></span>
                            <span>æ´»åŠ¨ç”³è¯·</span>
                        </a>
                        <a href="{% url 'clubs:approval_center' 'president_transition' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">swap_horiz</span></span>
                            <span>ç¤¾é•¿æ¢å±Š</span>
                        </a>
                    </div>
                </div>
                {% endif %}
                
                <!-- 222æˆ¿é—´å€Ÿç”¨ - ä»…ç¤¾é•¿å’Œå¹²äº‹å¯è§ -->
                {% if user.profile.role == 'president' or user.profile.role == 'staff' or user.profile.role == 'admin' %}
                <div class="sidebar-menu-section">
                    <div class="sidebar-menu-title collapsible" onclick="toggleMenuSection(this)">
                        <span>æˆ¿é—´ç®¡ç†</span>
                        <span class="material-icons expand-icon">expand_more</span>
                    </div>
                    <div class="sidebar-menu-items collapsed">
                        <a href="{% url 'clubs:room222_calendar' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">event</span></span>
                            <span>222æˆ¿é—´æ—¥å†</span>
                        </a>
                        <a href="{% url 'clubs:submit_room222_booking' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">add_circle</span></span>
                            <span>é¢„çº¦æˆ¿é—´</span>
                        </a>
                        <a href="{% url 'clubs:my_room222_bookings' %}" class="sidebar-menu-item">
                            <span class="icon"><span class="material-icons">list</span></span>
                            <span>æˆ‘çš„é¢„çº¦</span>
                        </a>
                    </div>
                </div>
                {% endif %}
            {% endif %}
        </div>
        
        <!-- åº•éƒ¨ (ç”¨æˆ·ä¿¡æ¯) -->
        {% if user.is_authenticated %}
        <div class="sidebar-footer">
            <div class="sidebar-user" onclick="toggleUserDropdown()">
                <div class="sidebar-user-avatar">
                    <span class="material-icons">person</span>
                </div>
                <div class="sidebar-user-info">
                    <div class="sidebar-user-name">{{ user.username }}</div>
                    <div class="sidebar-user-role">
                        {% if user.profile.role == 'admin' %}
                            ç®¡ç†å‘˜
                        {% elif user.profile.role == 'staff' %}
                            å¹²äº‹
                        {% elif user.profile.role == 'president' %}
                            ç¤¾é•¿
                        {% else %}
                            æ™®é€šç”¨æˆ·
                        {% endif %}
                    </div>
                </div>
                <span class="dropdown-arrow">â–²</span>
            </div>
            
            <div class="sidebar-user-dropdown" id="userDropdown">
                <a href="{% url 'clubs:change_account_settings' %}">
                    <span><span class="material-icons" style="vertical-align: middle;">lock</span></span>
                    <span>ä¿®æ”¹è´¦æˆ·è®¾ç½®</span>
                </a>
                <a href="{% url 'clubs:edit_profile' %}">
                    <span><span class="material-icons" style="vertical-align: middle;">person</span></span>
                    <span>ä¿®æ”¹ä¸ªäººä¿¡æ¯</span>
                </a>
                <a href="{% url 'clubs:logout' %}" class="logout">
                    <span><span class="material-icons" style="vertical-align: middle;">lock_open</span></span>
                    <span>ç™»å‡º</span>
                </a>
            </div>
            
            <div class="sidebar-theme-toggle" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">
                <span id="theme-icon">ğŸŒ™</span>
                <span class="theme-text">åˆ‡æ¢ä¸»é¢˜</span>
            </div>
        </div>
        {% endif %}
    </nav>
    
    <!-- ä¸»å†…å®¹åŒº -->
    <div class="main-wrapper" id="mainWrapper">
        <div class="main-content">
            {% if messages %}
            <div class="messages-container">
                {% for message in messages %}
                <div class="message {% if message.tags %}{{ message.tags }}{% endif %}">
                    {{ message }}
                </div>
                {% endfor %}
            </div>
            {% endif %}

            {% block content %}{% endblock %}
        </div>
        
        <footer>
            <p>ä¸Šæµ·æµ·æ´‹å¤§å­¦ç¤¾å›¢ç®¡ç†æœåŠ¡ä¸­å¿ƒ æŠ€æœ¯æ”¯æŒ</p>
        </footer>
    </div>
    
    <!-- åº•éƒ¨å¯¼èˆªæ  (ç§»åŠ¨ç«¯) -->
    {% if user.is_authenticated %}
    <nav class="bottom-nav">
        <div class="bottom-nav-items">
            {% if user.profile.role != 'president' %}
                <a href="{% url 'clubs:index' %}" class="bottom-nav-item">
                    <span class="icon"><span class="material-icons">home</span></span>
                    <span>é¦–é¡µ</span>
                </a>
            {% endif %}
            
            {% if user.profile.role == 'admin' %}
                <a href="{% url 'clubs:admin_dashboard' %}" class="bottom-nav-item">
                    <span class="icon"><span class="material-icons">settings</span></span>
                    <span>ç®¡ç†</span>
                </a>
                <a href="{% url 'clubs:staff_dashboard' %}" class="bottom-nav-item">
                    <span class="icon"><span class="material-icons">check_circle</span></span>
                    <span>å®¡æ ¸</span>
                </a>
                <a href="{% url 'clubs:staff_management' %}" class="bottom-nav-item">
                    <span class="icon"><span class="material-icons">business_center</span></span>
                    <span>ç¤¾å›¢</span>
                </a>
            {% elif user.profile.role == 'staff' %}
                <a href="{% url 'clubs:staff_dashboard' %}" class="bottom-nav-item">
                    <span class="icon"><span class="material-icons">check_circle</span></span>
                    <span>å®¡æ ¸</span>
                </a>
                <a href="{% url 'clubs:staff_management' %}" class="bottom-nav-item">
                    <span class="icon"><span class="material-icons">business_center</span></span>
                    <span>ç¤¾å›¢</span>
                </a>
            {% elif user.profile.role == 'president' %}
                <a href="{% url 'clubs:user_dashboard' %}" class="bottom-nav-item">
                    <span class="icon"><span class="material-icons">folder</span></span>
                    <span>æˆ‘çš„</span>
                </a>
                <a href="{% url 'clubs:approval_center' 'annual_review' %}" class="bottom-nav-item">
                    <span class="icon"><span class="material-icons">check_circle</span></span>
                    <span>å®¡æ‰¹</span>
                </a>
            {% else %}
                <!-- æ™®é€šç”¨æˆ· -->
                <a href="{% url 'clubs:public_activities' %}" class="bottom-nav-item">
                    <span class="icon"><span class="material-icons">event</span></span>
                    <span>æ´»åŠ¨</span>
                </a>
            {% endif %}
            
            <a href="javascript:void(0)" class="bottom-nav-item" onclick="toggleSidebar()">
                <span class="icon"><span class="material-icons">person</span></span>
                <span>æˆ‘</span>
            </a>
        </div>
    </nav>
    {% endif %}

    <script src="{% static 'js/main.js' %}"></script>
    <script>
        (function() {
            /* ä¿®å¤åçš„å•ä¸€è„šæœ¬ï¼š
               - é˜²æ­¢é¡µé¢æ°´å¹³æº¢å‡º
               - åˆ‡æ¢ä¾§è¾¹æ /ç”¨æˆ·ä¸‹æ‹‰/èœå•æŠ˜å 
               - åˆå§‹åŒ–æŠ˜å ä¸é«˜äº®
            */
            function checkOverflow() {
                const body = document.body;
                if (body.scrollWidth > window.innerWidth) {
                    const elements = document.querySelectorAll('*');
                    elements.forEach(el => {
                        const rect = el.getBoundingClientRect();
                        if (rect.right > window.innerWidth || rect.left < 0) {
                            if (el.style.overflow !== 'auto' && el.style.overflow !== 'scroll') {
                                el.style.maxWidth = '100vw';
                                el.style.overflowX = 'hidden';
                            }
                        }
                    });
                }
            }

            function toggleSidebar() {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.querySelector('.sidebar-overlay');
                if (sidebar) sidebar.classList.toggle('active');
                if (overlay) overlay.classList.toggle('active');
            }

            function toggleUserDropdown() {
                const dropdown = document.getElementById('userDropdown');
                if (dropdown) dropdown.classList.toggle('active');
            }

            function toggleMenuSection(titleElement) {
                const section = titleElement.parentElement;
                const items = section.querySelector('.sidebar-menu-items');
                titleElement.classList.toggle('collapsed');
                if (items) items.classList.toggle('collapsed');

                const sectionName = titleElement.textContent.trim().split('\n')[0].trim();
                localStorage.setItem(`sidebar-${sectionName}-collapsed`, titleElement.classList.contains('collapsed'));
            }

            function initMenuSections() {
                const collapsibleTitles = document.querySelectorAll('.sidebar-menu-title.collapsible');
                collapsibleTitles.forEach(title => {
                    const sectionName = title.textContent.trim().split('\n')[0].trim();
                    let shouldCollapse = localStorage.getItem(`sidebar-${sectionName}-collapsed`);
                    if (sectionName === 'æˆ¿é—´ç®¡ç†' && shouldCollapse === null) shouldCollapse = 'true';
                    if (sectionName === 'å®¡æ‰¹ä¸­å¿ƒ' && shouldCollapse === null) shouldCollapse = 'false';
                    if (sectionName === 'å®¡æ ¸ä¸­å¿ƒ' && shouldCollapse === null) shouldCollapse = 'false';
                    if (shouldCollapse === 'true') {
                        title.classList.add('collapsed');
                        const items = title.parentElement.querySelector('.sidebar-menu-items');
                        if (items) items.classList.add('collapsed');
                    }
                });
            }

            document.addEventListener('click', function(event) {
                const userDropdown = document.getElementById('userDropdown');
                const userButton = event.target.closest('.sidebar-user');
                if (userDropdown && !userButton && userDropdown.classList.contains('active')) {
                    userDropdown.classList.remove('active');
                }
            });

            window.toggleSidebar = toggleSidebar;
            window.toggleUserDropdown = toggleUserDropdown;
            window.toggleMenuSection = toggleMenuSection;

            document.addEventListener('DOMContentLoaded', function() {
                checkOverflow();
                window.addEventListener('resize', checkOverflow);

                // é«˜äº®å½“å‰é¡µé¢
                const currentPath = window.location.pathname;
                const menuItems = document.querySelectorAll('.sidebar-menu-item, .bottom-nav-item');
                menuItems.forEach(item => { try { if (item.getAttribute('href') === currentPath) item.classList.add('active'); } catch (e) {} });

                initMenuSections();
            });
        })();
    </script>
    {% block extra_js %}{% endblock %}
</body>
</html>
