{% extends 'clubs/base.html' %}
{% load static %}

{% block title %}
{% if current_tab == 'annual_review' %}年审记录
{% elif current_tab == 'registration' %}社团注册
{% elif current_tab == 'application' %}社团申请
{% elif current_tab == 'reimbursement' %}报销记录
{% elif current_tab == 'activity_application' %}活动申请
{% elif current_tab == 'president_transition' %}社长换届
{% endif %} - 审核中心
{% endblock %}

{% block extra_css %}
<style>
    /* 基础容器 - 沿用社长端样式以保持一致性 */
    .approval-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: var(--md3-spacing-2xl);
        padding-bottom: calc(var(--md3-spacing-2xl) + 100px); /* 为底栏留出空间 */
    }

    .page-header {
        display: flex;
        align-items: center;
        gap: var(--md3-spacing-lg);
        margin-bottom: var(--md3-spacing-2xl);
        padding: var(--md3-spacing-xl);
        background: var(--md3-surface-container-low);
        border-radius: var(--md3-radius-xl);
        border: 1px solid var(--md3-outline-variant);
    }

    .page-header .material-icons {
        font-size: 2.5rem;
        color: var(--md3-primary);
    }

    .page-header-content {
        flex: 1;
    }

    .page-header h1 {
        margin: 0 0 var(--md3-spacing-xs) 0;
        font-size: 1.75rem;
        font-weight: 600;
        color: var(--md3-on-surface);
    }

    .page-header .subtitle {
        color: var(--md3-on-surface-variant);
        font-size: 0.875rem;
    }

    /* 内容卡片 与记录样式直接复用社长端 */
    .content-card {
        background: var(--md3-surface-container);
        border-radius: var(--md3-radius-xl);
        border: 1px solid var(--md3-outline-variant);
        overflow: hidden;
        box-shadow: var(--md3-elevation-1);
    }

    .section-header {
        display: flex;
        align-items: center;
        gap: var(--md3-spacing-md);
        padding: var(--md3-spacing-xl);
        background: var(--md3-surface-container-high);
        border-bottom: 1px solid var(--md3-outline-variant);
    }

    .section-header .material-icons {
        font-size: 1.5rem;
        color: var(--md3-primary);
    }

    .records-section {
        padding: var(--md3-spacing-xl);
    }

    .records-section + .records-section {
        border-top: 2px solid var(--md3-outline-variant);
    }

    .records-section .section-title {
        display: flex;
        align-items: center;
        gap: var(--md3-spacing-sm);
        margin-bottom: var(--md3-spacing-lg);
        padding-bottom: var(--md3-spacing-md);
        border-bottom: 1px solid var(--md3-outline-variant);
    }

    .records-section .section-title .material-icons {
        font-size: 1.25rem;
        color: var(--md3-primary);
    }

    .records-section .section-title h3 {
        margin: 0;
        font-size: 1rem;
        font-weight: 600;
        color: var(--md3-on-surface);
        flex: 1;
    }

    .records-section .section-title .count {
        font-size: 0.875rem;
        color: var(--md3-on-surface-variant);
    }

    .records-list {
        display: flex;
        flex-direction: column;
        gap: var(--md3-spacing-md);
    }

    .record-card {
        background: var(--md3-surface-container-highest);
        border: 1px solid var(--md3-outline-variant);
        border-radius: var(--md3-radius-lg);
        padding: var(--md3-spacing-lg);
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .record-card:hover {
        background: var(--md3-surface-container-high);
        border-color: var(--md3-primary);
        box-shadow: var(--md3-elevation-2);
        transform: translateY(-2px);
    }

    .record-card-header {
        display: flex;
        align-items: center;
        gap: var(--md3-spacing-md);
        margin-bottom: var(--md3-spacing-md);
    }

    .record-card-header .club-name {
        font-size: 1rem;
        font-weight: 600;
        color: var(--md3-on-surface);
        flex: 1;
    }

    .record-card-body {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: var(--md3-spacing-md);
        margin-bottom: var(--md3-spacing-md);
    }

    .record-field-label {
        font-size: 0.75rem;
        color: var(--md3-on-surface-variant);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .record-field-value {
        font-size: 0.875rem;
        color: var(--md3-on-surface);
        font-weight: 500;
    }

    .record-card-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--md3-spacing-md);
        padding-top: var(--md3-spacing-md);
        border-top: 1px solid var(--md3-outline-variant);
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: var(--md3-spacing-xs);
        padding: var(--md3-spacing-xs) var(--md3-spacing-md);
        border-radius: var(--md3-radius-full);
        font-size: 0.875rem;
        font-weight: 600;
        white-space: nowrap;
    }

    .status-badge .material-icons {
        font-size: 1rem;
    }

    .status-badge.approved {
        background: var(--md3-success-container, #d1fae5);
        color: var(--md3-on-success-container, #065f46);
    }

    .status-badge.rejected {
        background: var(--md3-error-container);
        color: var(--md3-on-error-container);
    }

    .status-badge.pending {
        background: var(--md3-secondary-container);
        color: var(--md3-on-secondary-container);
    }

    .status-badge.reviewing {
        background: var(--md3-primary-container);
        color: var(--md3-on-primary-container);
    }

    .status-badge.partially-rejected {
        background: var(--md3-surface-container-highest);
        color: var(--md3-on-surface);
        border: 1px solid var(--md3-outline);
    }

    .action-btn {
        display: inline-flex;
        align-items: center;
        gap: var(--md3-spacing-xs);
        padding: var(--md3-spacing-sm) var(--md3-spacing-md);
        border-radius: var(--md3-radius-full);
        font-size: 0.875rem;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.2s ease;
        border: 1px solid transparent;
    }

    .action-btn.primary {
        background: var(--md3-primary);
        color: var(--md3-on-primary);
    }

    .action-btn.primary:hover {
        background: var(--md3-primary-hover);
        box-shadow: var(--md3-elevation-2);
    }

    .action-btn .material-icons {
        font-size: 1.125rem;
    }

    /* 空状态 */
    .empty-state {
        text-align: center;
        padding: var(--md3-spacing-3xl);
        color: var(--md3-on-surface-variant);
    }

    .empty-state-icon {
        width: 80px;
        height: 80px;
        margin: 0 auto var(--md3-spacing-lg);
        background: var(--md3-surface-container-highest);
        border-radius: var(--md3-radius-full);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .empty-state-icon .material-icons {
        font-size: 2.5rem;
        color: var(--md3-on-surface-variant);
        opacity: 0.5;
    }

    .empty-state h3 {
        margin: 0 0 var(--md3-spacing-sm) 0;
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--md3-on-surface);
    }

    .empty-state p {
        margin: 0;
        font-size: 0.875rem;
    }

    /* 导出弹窗样式 */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        backdrop-filter: blur(4px);
    }

    .modal-content {
        background: var(--md3-surface-container);
        border-radius: var(--md3-radius-xl);
        box-shadow: var(--md3-elevation-3);
        width: 90%;
        max-width: 500px;
        max-height: 80vh;
        overflow: auto;
    }

    .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--md3-spacing-xl);
        border-bottom: 1px solid var(--md3-outline-variant);
    }

    .modal-header h2 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--md3-on-surface);
        display: flex;
        align-items: center;
    }

    .modal-close {
        background: none;
        border: none;
        cursor: pointer;
        color: var(--md3-on-surface-variant);
        padding: var(--md3-spacing-sm);
        border-radius: var(--md3-radius-full);
        transition: background 0.2s;
    }

    .modal-close:hover {
        background: var(--md3-surface-container-highest);
    }

    .modal-body {
        padding: var(--md3-spacing-xl);
    }

    .form-group {
        margin-bottom: var(--md3-spacing-lg);
    }

    .form-group label {
        display: block;
        margin-bottom: var(--md3-spacing-sm);
        font-weight: 500;
        color: var(--md3-on-surface);
        font-size: 0.875rem;
    }

    .form-control {
        width: 100%;
        padding: var(--md3-spacing-md);
        border: 1px solid var(--md3-outline);
        border-radius: var(--md3-radius-md);
        background: var(--md3-surface);
        color: var(--md3-on-surface);
        font-size: 1rem;
        transition: all 0.2s;
    }

    .form-control:focus {
        outline: none;
        border-color: var(--md3-primary);
        box-shadow: 0 0 0 2px rgba(var(--md3-primary-rgb), 0.1);
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: var(--md3-spacing-md);
        padding: var(--md3-spacing-xl);
        border-top: 1px solid var(--md3-outline-variant);
    }

    .btn-secondary {
        background: var(--md3-surface-container-high);
        color: var(--md3-on-surface);
        border: 1px solid var(--md3-outline);
    }

    .btn-secondary:hover {
        background: var(--md3-surface-container-highest);
    }

    /* 自动完成下拉列表样式 */
    .autocomplete-items {
        position: absolute;
        border: 1px solid var(--md3-outline);
        border-top: none;
        z-index: 99;
        top: 100%;
        left: 0;
        right: 0;
        max-height: 200px;
        overflow-y: auto;
        background: var(--md3-surface-container);
        border-radius: 0 0 var(--md3-radius-md) var(--md3-radius-md);
        box-shadow: var(--md3-elevation-2);
    }

    .autocomplete-items div {
        padding: var(--md3-spacing-md);
        cursor: pointer;
        border-bottom: 1px solid var(--md3-outline-variant);
        color: var(--md3-on-surface);
    }

    .autocomplete-items div:hover {
        background: var(--md3-surface-container-high);
    }

    .autocomplete-active {
        background: var(--md3-primary-container) !important;
        color: var(--md3-on-primary-container) !important;
    }

    .autocomplete-container {
        position: relative;
    }

    /* 确保按钮内的Material Icons字体正确显示 */
    .btn .material-icons {
        font-family: 'Material Icons' !important;
        color: currentColor;
    }

    .btn-primary .material-icons {
        color: var(--md3-on-primary);
    }

    @media (max-width: 768px) {
        .approval-container { 
            padding: var(--md3-spacing-lg); 
            padding-bottom: calc(var(--md3-spacing-lg) + 100px); /* 移动端底栏空间 */
        }
        .page-header { padding: var(--md3-spacing-lg); border-radius: var(--md3-radius-lg); }
        .page-header .material-icons { font-size: 2rem; }
        .page-header h1 { font-size: 1.25rem; }
        .records-section { padding: var(--md3-spacing-lg); }
        .record-card { padding: var(--md3-spacing-md); }
        .record-card-body { grid-template-columns: 1fr; }
        
        .modal-content {
            max-height: 90vh;
        }
    }
</style>

<script>
let currentExportTab = '';
let clubsList = [];

// 加载社团列表
fetch('/clubs/api/clubs/list/')
    .then(response => response.json())
    .then(data => {
        clubsList = data.clubs || [];
    })
    .catch(error => console.error('Error loading clubs:', error));

function openExportDialog(tab) {
    currentExportTab = tab;
    document.getElementById('exportDialog').style.display = 'flex';
    // 初始化自动完成
    initAutocomplete();
}

function closeExportDialog() {
    document.getElementById('exportDialog').style.display = 'none';
    document.getElementById('exportForm').reset();
    // 重置结束日期为禁用状态
    document.getElementById('end_date').disabled = true;
    // 清除自动完成
    closeAllLists();
}

function handleStartDateChange() {
    const startDate = document.getElementById('start_date');
    const endDate = document.getElementById('end_date');
    
    if (startDate.value) {
        // 启用结束日期并设置最小值为开始日期
        endDate.disabled = false;
        endDate.min = startDate.value;
    } else {
        // 禁用结束日期并清空
        endDate.disabled = true;
        endDate.value = '';
    }
}

function initAutocomplete() {
    const input = document.getElementById('club_name');
    let currentFocus;

    input.addEventListener('input', function() {
        let val = this.value;
        closeAllLists();
        if (!val) return false;
        currentFocus = -1;
        
        const container = document.createElement('div');
        container.setAttribute('id', this.id + '-autocomplete-list');
        container.setAttribute('class', 'autocomplete-items');
        this.parentNode.appendChild(container);

        let count = 0;
        for (let club of clubsList) {
            if (club.toLowerCase().includes(val.toLowerCase()) && count < 10) {
                const item = document.createElement('div');
                const matchIndex = club.toLowerCase().indexOf(val.toLowerCase());
                item.innerHTML = club.substr(0, matchIndex);
                item.innerHTML += '<strong>' + club.substr(matchIndex, val.length) + '</strong>';
                item.innerHTML += club.substr(matchIndex + val.length);
                item.innerHTML += '<input type="hidden" value="' + club + '">';
                
                item.addEventListener('click', function() {
                    input.value = this.getElementsByTagName('input')[0].value;
                    closeAllLists();
                });
                
                container.appendChild(item);
                count++;
            }
        }
    });

    input.addEventListener('keydown', function(e) {
        let x = document.getElementById(this.id + '-autocomplete-list');
        if (x) x = x.getElementsByTagName('div');
        if (e.keyCode == 40) { // DOWN
            currentFocus++;
            addActive(x);
        } else if (e.keyCode == 38) { // UP
            currentFocus--;
            addActive(x);
        } else if (e.keyCode == 13) { // ENTER
            e.preventDefault();
            if (currentFocus > -1) {
                if (x) x[currentFocus].click();
            }
        }
    });

    function addActive(x) {
        if (!x) return false;
        removeActive(x);
        if (currentFocus >= x.length) currentFocus = 0;
        if (currentFocus < 0) currentFocus = (x.length - 1);
        x[currentFocus].classList.add('autocomplete-active');
    }

    function removeActive(x) {
        for (let i = 0; i < x.length; i++) {
            x[i].classList.remove('autocomplete-active');
        }
    }
}

function closeAllLists(elmnt) {
    const items = document.getElementsByClassName('autocomplete-items');
    for (let i = 0; i < items.length; i++) {
        if (elmnt != items[i] && elmnt != document.getElementById('club_name')) {
            items[i].parentNode.removeChild(items[i]);
        }
    }
}

document.addEventListener('click', function(e) {
    closeAllLists(e.target);
});

function submitExport() {
    const form = document.getElementById('exportForm');
    const formData = new FormData(form);
    const params = new URLSearchParams();
    
    for (let [key, value] of formData.entries()) {
        if (value) {
            params.append(key, value);
        }
    }
    
    const url = `/clubs/staff/audit-center/${currentExportTab}/export/?${params.toString()}`;
    window.location.href = url;
    closeExportDialog();
}

// 点击遮罩层关闭弹窗
document.addEventListener('click', function(e) {
    const dialog = document.getElementById('exportDialog');
    if (dialog && e.target === dialog) {
        closeExportDialog();
    }
});
</script>

<script>
function checkLayout() {
    if (window.innerWidth <= 768) {
        // 移动端跳转到审核中心移动端
        window.location.href = '{% url "clubs:staff_audit_center_mobile" %}';
    }
}
checkLayout();
window.addEventListener('resize', checkLayout);
</script>
{% endblock %}

{% block content %}
<div class="approval-container">
    <div class="page-header">
        {% if current_tab == 'annual_review' %}
        <span class="material-icons">assignment</span>
        <div class="page-header-content">
            <h1>年审记录</h1>
            <p class="subtitle">查看和管理社团年审提交记录</p>
        </div>
        <button onclick="openExportDialog('annual-review')" class="btn btn-primary" style="display: inline-flex; align-items: center; gap: var(--md3-spacing-sm); padding: var(--md3-spacing-md) var(--md3-spacing-lg); border-radius: var(--md3-radius-full); border: none; cursor: pointer; white-space: nowrap;">
            <span class="material-icons" style="font-size: 1.25rem;">download</span>
            导出Excel
        </button>
        {% elif current_tab == 'registration' %}
        <span class="material-icons">add_circle</span>
        <div class="page-header-content">
            <h1>社团注册</h1>
            <p class="subtitle">查看社团注册申请和审核状态</p>
        </div>
        <button onclick="openExportDialog('registration')" class="btn btn-primary" style="display: inline-flex; align-items: center; gap: var(--md3-spacing-sm); padding: var(--md3-spacing-md) var(--md3-spacing-lg); border-radius: var(--md3-radius-full); border: none; cursor: pointer; white-space: nowrap;">
            <span class="material-icons" style="font-size: 1.25rem;">download</span>
            导出Excel
        </button>
        {% elif current_tab == 'application' %}
        <span class="material-icons">create</span>
        <div class="page-header-content">
            <h1>社团申请</h1>
            <p class="subtitle">查看新社团创建申请记录</p>
        </div>
        <button onclick="openExportDialog('application')" class="btn btn-primary" style="display: inline-flex; align-items: center; gap: var(--md3-spacing-sm); padding: var(--md3-spacing-md) var(--md3-spacing-lg); border-radius: var(--md3-radius-full); border: none; cursor: pointer; white-space: nowrap;">
            <span class="material-icons" style="font-size: 1.25rem;">download</span>
            导出Excel
        </button>
        {% elif current_tab == 'reimbursement' %}
        <span class="material-icons">receipt</span>
        <div class="page-header-content">
            <h1>报销记录</h1>
            <p class="subtitle">查看社团费用报销申请</p>
        </div>
        <button onclick="openExportDialog('reimbursement')" class="btn btn-primary" style="display: inline-flex; align-items: center; gap: var(--md3-spacing-sm); padding: var(--md3-spacing-md) var(--md3-spacing-lg); border-radius: var(--md3-radius-full); border: none; cursor: pointer; white-space: nowrap;">
            <span class="material-icons" style="font-size: 1.25rem;">download</span>
            导出Excel
        </button>
        {% elif current_tab == 'activity_application' %}
        <span class="material-icons">event</span>
        <div class="page-header-content">
            <h1>活动申请</h1>
            <p class="subtitle">查看社团活动申请和审批</p>
        </div>
        <button onclick="openExportDialog('activity_application')" class="btn btn-primary" style="display: inline-flex; align-items: center; gap: var(--md3-spacing-sm); padding: var(--md3-spacing-md) var(--md3-spacing-lg); border-radius: var(--md3-radius-full); border: none; cursor: pointer; white-space: nowrap;">
            <span class="material-icons" style="font-size: 1.25rem;">download</span>
            导出Excel
        </button>
        {% elif current_tab == 'president_transition' %}
        <span class="material-icons">swap_horiz</span>
        <div class="page-header-content">
            <h1>社长换届</h1>
            <p class="subtitle">查看社长换届申请记录</p>
        </div>
        <button onclick="openExportDialog('president_transition')" class="btn btn-primary" style="display: inline-flex; align-items: center; gap: var(--md3-spacing-sm); padding: var(--md3-spacing-md) var(--md3-spacing-lg); border-radius: var(--md3-radius-full); border: none; cursor: pointer; white-space: nowrap;">
            <span class="material-icons" style="font-size: 1.25rem;">download</span>
            导出Excel
        </button>
        {% endif %}
    </div>

    <!-- 导出筛选弹窗 -->
    <div id="exportDialog" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2><span class="material-icons" style="vertical-align: middle; margin-right: 8px;">filter_list</span>导出筛选</h2>
                <button onclick="closeExportDialog()" class="modal-close">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="exportForm" method="get">
                    <div class="form-group autocomplete-container">
                        <label for="club_name">社团名称 <span style="color: var(--md3-on-surface-variant); font-size: 0.75rem;">(可选)</span></label>
                        <input type="text" id="club_name" name="club_name" class="form-control" placeholder="留空表示全部社团" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="start_date">开始日期 <span style="color: var(--md3-on-surface-variant); font-size: 0.75rem;">(可选)</span></label>
                        <input type="date" id="start_date" name="start_date" class="form-control" onchange="handleStartDateChange()">
                    </div>
                    <div class="form-group">
                        <label for="end_date">结束日期 <span style="color: var(--md3-on-surface-variant); font-size: 0.75rem;">(可选)</span></label>
                        <input type="date" id="end_date" name="end_date" class="form-control" disabled>
                    </div>
                    <div class="form-group">
                        <label for="status">状态</label>
                        <select id="status" name="status" class="form-control">
                            <option value="">全部状态</option>
                            <option value="pending">待审核</option>
                            <option value="approved">已通过</option>
                            <option value="rejected">已拒绝</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button onclick="closeExportDialog()" class="btn btn-secondary">取消</button>
                <button onclick="submitExport()" class="btn btn-primary">
                    <span class="material-icons" style="font-size: 1.125rem; vertical-align: middle;">download</span>
                    确认导出
                </button>
            </div>
        </div>
    </div>

    <div class="content-card">
        <!-- 待处理记录 -->
        <div class="records-section">
            <div class="section-title">
                <span class="material-icons">notifications_active</span>
                <h3>当前活跃</h3>
                <span class="count">{{ active_items|length }} 条记录</span>
            </div>

            {% if active_items %}
            <div class="records-list">
                {% for item in active_items %}
                <div class="record-card" onclick="
                    {% if current_tab == 'annual_review' %}
                        window.location.href='{% url "clubs:review_submission" item.id %}';
                    {% elif current_tab == 'registration' %}
                        window.location.href='{% url "clubs:review_club_registration_submission" item.id %}';
                    {% elif current_tab == 'application' %}
                        window.location.href='{% url "clubs:review_club_registration" item.id %}';
                    {% elif current_tab == 'reimbursement' %}
                        window.location.href='{% url "clubs:review_reimbursement" item.id %}';
                    {% elif current_tab == 'activity_application' %}
                        window.location.href='{% url "clubs:review_activity_application" item.id %}';
                    {% elif current_tab == 'president_transition' %}
                        window.location.href='{% url "clubs:review_president_transition" item.id %}';
                    {% endif %}
                ">
                    <div class="record-card-header">
                        {% if current_tab == 'annual_review' %}
                        <span class="club-name">{{ item.club.name }}</span>
                        {% elif current_tab == 'registration' %}
                        <span class="club-name">{{ item.club.name }}</span>
                        {% elif current_tab == 'application' %}
                        <span class="club-name">{{ item.club_name }}</span>
                        {% elif current_tab == 'reimbursement' %}
                        <span class="club-name">{{ item.club.name }}</span>
                        {% elif current_tab == 'activity_application' %}
                        <span class="club-name">{{ item.club.name }}</span>
                        {% elif current_tab == 'president_transition' %}
                        <span class="club-name">{{ item.club.name }}</span>
                        {% endif %}

                        {% if item.review_count %}
                        <span class="status-badge reviewing">
                            <span class="material-icons">rate_review</span> 
                            {% if item.user_reviewed %}已审核{% else %}审核中{% endif %}
                            ({{ item.review_count }}/3)
                        </span>
                        {% elif item.status == 'pending' %}
                        <span class="status-badge pending">
                            <span class="material-icons">schedule</span> 待审核
                        </span>
                        {% elif item.status == 'rejected' %}
                        <span class="status-badge rejected">
                            <span class="material-icons">cancel</span> 已拒绝
                        </span>
                        {% elif item.status == 'partially_rejected' %}
                        <span class="status-badge partially-rejected">
                            <span class="material-icons">error</span> 部分拒绝
                        </span>
                        {% endif %}
                    </div>

                    <div class="record-card-body">
                        {% if current_tab == 'annual_review' %}
                        <div class="record-field">
                            <span class="record-field-label">年份</span>
                            <span class="record-field-value">{{ item.submission_year }}</span>
                        </div>
                        <div class="record-field">
                            <span class="record-field-label">审核者</span>
                            {% with reviewer=item.get_final_reviewer %}
                                {% if reviewer %}
                                <a href="{% url 'clubs:user_detail' reviewer.id %}" class="record-field-value" style="display: flex; align-items: center; text-decoration: none; color: inherit;">
                                    <div style="width: 24px; height: 24px; border-radius: 50%; overflow: hidden; margin-right: 8px; flex-shrink: 0;">
                                        {% if reviewer.profile.avatar %}
                                            <img src="{{ reviewer.profile.avatar.url }}" alt="{{ reviewer.profile.get_full_name }}" style="width: 100%; height: 100%; object-fit: cover;">
                                        {% else %}
                                            <div style="width: 100%; height: 100%; background-color: var(--md3-secondary-container); color: var(--md3-on-secondary-container); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">
                                                {{ reviewer.profile.get_full_name|slice:":1"|default:reviewer.username|slice:":1" }}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <span style="border-bottom: 1px dotted var(--md3-outline);">{{ reviewer.profile.get_full_name|default:reviewer.username }}</span>
                                </a>
                                {% else %}
                                <span class="record-field-value">未知</span>
                                {% endif %}
                            {% endwith %}
                        </div>
                        <div class="record-field">
                            <span class="record-field-label">提交时间</span>
                            <span class="record-field-value">{{ item.submitted_at|date:"Y-m-d H:i" }}</span>
                        </div>

                        {% elif current_tab == 'registration' %}
                        <div class="record-field">
                            <span class="record-field-label">注册周期</span>
                            <span class="record-field-value">{% if item.registration_period %}{{ item.registration_period }}{% else %}未设置{% endif %}</span>
                        </div>
                        <div class="record-field">
                            <span class="record-field-label">提交时间</span>
                            <span class="record-field-value">{{ item.submitted_at|date:"Y-m-d H:i" }}</span>
                        </div>

                        {% elif current_tab == 'application' %}
                        <div class="record-field">
                            <span class="record-field-label">申请人</span>
                            <span class="record-field-value" style="display: flex; align-items: center; gap: 8px;">
                                <a href="{% url 'clubs:user_detail' item.requested_by.id %}" style="display: flex; align-items: center; text-decoration: none; color: inherit;">
                                    <div style="width: 24px; height: 24px; border-radius: 50%; overflow: hidden; margin-right: 8px; flex-shrink: 0;">
                                        {% if item.requested_by.profile.avatar %}
                                            <img src="{{ item.requested_by.profile.avatar.url }}" alt="{{ item.requested_by.profile.get_full_name }}" style="width: 100%; height: 100%; object-fit: cover;">
                                        {% else %}
                                            <div style="width: 100%; height: 100%; background-color: var(--md3-primary-container); color: var(--md3-on-primary-container); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">
                                                {{ item.requested_by.profile.get_full_name|slice:":1"|default:item.requested_by.username|slice:":1" }}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <strong style="border-bottom: 1px dotted var(--md3-outline);">{{ item.requested_by.profile.get_full_name|default:item.requested_by.username }}</strong>
                                </a>
                            </span>
                        </div>
                        <div class="record-field">
                            <span class="record-field-label">提交时间</span>
                            <span class="record-field-value">{{ item.submitted_at|date:"Y-m-d H:i" }}</span>
                        </div>

                        {% elif current_tab == 'reimbursement' %}
                        <div class="record-field">
                            <span class="record-field-label">报销金额</span>
                            <span class="record-field-value" style="color: var(--md3-primary); font-weight: 600;">¥{{ item.reimbursement_amount|floatformat:2 }}</span>
                        </div>
                        <div class="record-field">
                            <span class="record-field-label">审核者</span>
                            {% with reviewer=item.reviewer %}
                                {% if reviewer %}
                                <a href="{% url 'clubs:user_detail' reviewer.id %}" class="record-field-value" style="display: flex; align-items: center; text-decoration: none; color: inherit;">
                                    <div style="width: 24px; height: 24px; border-radius: 50%; overflow: hidden; margin-right: 8px; flex-shrink: 0;">
                                        {% if reviewer.profile.avatar %}
                                            <img src="{{ reviewer.profile.avatar.url }}" alt="{{ reviewer.profile.get_full_name }}" style="width: 100%; height: 100%; object-fit: cover;">
                                        {% else %}
                                            <div style="width: 100%; height: 100%; background-color: var(--md3-secondary-container); color: var(--md3-on-secondary-container); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">
                                                {{ reviewer.profile.get_full_name|slice:":1"|default:reviewer.username|slice:":1" }}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <span style="border-bottom: 1px dotted var(--md3-outline);">{{ reviewer.profile.get_full_name|default:reviewer.username }}</span>
                                </a>
                                {% else %}
                                <span class="record-field-value">未知</span>
                                {% endif %}
                            {% endwith %}
                        </div>
                        <div class="record-field">
                            <span class="record-field-label">提交时间</span>
                            <span class="record-field-value">{{ item.submitted_at|date:"Y-m-d H:i" }}</span>
                        </div>

                        {% elif current_tab == 'activity_application' %}
                        <div class="record-field">
                            <span class="record-field-label">活动日期</span>
                            <span class="record-field-value">{{ item.activity_date|date:"Y-m-d" }}</span>
                        </div>
                        <div class="record-field">
                            <span class="record-field-label">审核者</span>
                            {% with reviewer=item.staff_reviewer %}
                                {% if reviewer %}
                                <a href="{% url 'clubs:user_detail' reviewer.id %}" class="record-field-value" style="display: flex; align-items: center; text-decoration: none; color: inherit;">
                                    <div style="width: 24px; height: 24px; border-radius: 50%; overflow: hidden; margin-right: 8px; flex-shrink: 0;">
                                        {% if reviewer.profile.avatar %}
                                            <img src="{{ reviewer.profile.avatar.url }}" alt="{{ reviewer.profile.get_full_name }}" style="width: 100%; height: 100%; object-fit: cover;">
                                        {% else %}
                                            <div style="width: 100%; height: 100%; background-color: var(--md3-secondary-container); color: var(--md3-on-secondary-container); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">
                                                {{ reviewer.profile.get_full_name|slice:":1"|default:reviewer.username|slice:":1" }}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <span style="border-bottom: 1px dotted var(--md3-outline);">{{ reviewer.profile.get_full_name|default:reviewer.username }}</span>
                                </a>
                                {% else %}
                                <span class="record-field-value">未知</span>
                                {% endif %}
                            {% endwith %}
                        </div>
                        <div class="record-field">
                            <span class="record-field-label">提交时间</span>
                            <span class="record-field-value">{{ item.submitted_at|date:"Y-m-d H:i" }}</span>
                        </div>

                        {% elif current_tab == 'president_transition' %}
                        <div class="record-field">
                            <span class="record-field-label">新社长</span>
                            <span class="record-field-value" style="display: flex; align-items: center;">
                                {% if item.new_president_officer and item.new_president_officer.user_profile %}
                                <a href="{% url 'clubs:user_detail' item.new_president_officer.user_profile.user.id %}" style="display: flex; align-items: center; text-decoration: none; color: inherit;">
                                    <div style="width: 24px; height: 24px; border-radius: 50%; overflow: hidden; margin-right: 8px; flex-shrink: 0;">
                                        {% if item.new_president_officer.user_profile.avatar %}
                                            <img src="{{ item.new_president_officer.user_profile.avatar.url }}" alt="{{ item.new_president_officer.user_profile.get_full_name }}" style="width: 100%; height: 100%; object-fit: cover;">
                                        {% else %}
                                            <div style="width: 100%; height: 100%; background-color: var(--md3-primary-container); color: var(--md3-on-primary-container); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">
                                                {{ item.new_president_officer.user_profile.get_full_name|slice:":1"|default:item.new_president_officer.user_profile.user.username|slice:":1" }}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <strong style="border-bottom: 1px dotted var(--md3-outline);">{{ item.new_president_officer.user_profile.get_full_name }}</strong>
                                </a>
                                {% else %}
                                    {{ item.new_president_name|default:"-" }}
                                {% endif %}
                            </span>
                        </div>
                        <div class="record-field">
                            <span class="record-field-label">审核者</span>
                            {% with reviewer=item.reviewer %}
                                {% if reviewer %}
                                <a href="{% url 'clubs:user_detail' reviewer.id %}" class="record-field-value" style="display: flex; align-items: center; text-decoration: none; color: inherit;">
                                    <div style="width: 24px; height: 24px; border-radius: 50%; overflow: hidden; margin-right: 8px; flex-shrink: 0;">
                                        {% if reviewer.profile.avatar %}
                                            <img src="{{ reviewer.profile.avatar.url }}" alt="{{ reviewer.profile.get_full_name }}" style="width: 100%; height: 100%; object-fit: cover;">
                                        {% else %}
                                            <div style="width: 100%; height: 100%; background-color: var(--md3-secondary-container); color: var(--md3-on-secondary-container); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">
                                                {{ reviewer.profile.get_full_name|slice:":1"|default:reviewer.username|slice:":1" }}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <span style="border-bottom: 1px dotted var(--md3-outline);">{{ reviewer.profile.get_full_name|default:reviewer.username }}</span>
                                </a>
                                {% else %}
                                <span class="record-field-value">未知</span>
                                {% endif %}
                            {% endwith %}
                        </div>
                        <div class="record-field">
                            <span class="record-field-label">提交时间</span>
                            <span class="record-field-value">{{ item.submitted_at|date:"Y-m-d H:i" }}</span>
                        </div>
                        {% endif %}
                    </div>

                    {% if item.status == 'rejected' and not item.has_newer_version %}
                    <div class="record-card-footer">
                        {% if current_tab == 'annual_review' %}
                        <a href="{% url 'clubs:edit_rejected_review' item.club.id %}?type=review&request_id={{ item.id }}" 
                           class="action-btn primary" onclick="event.stopPropagation()">
                            <span class="material-icons">edit</span> 修改材料
                        </a>
                        {% elif current_tab == 'registration' %}
                        <a href="{% url 'clubs:edit_rejected_review' item.club.id %}?type=club_registration&request_id={{ item.id }}" 
                           class="action-btn primary" onclick="event.stopPropagation()">
                            <span class="material-icons">edit</span> 修改材料
                        </a>
                        {% elif current_tab == 'application' %}
                        <a href="{% url 'clubs:edit_rejected_review' item.id %}?type=club_application&request_id={{ item.id }}" 
                           class="action-btn primary" onclick="event.stopPropagation()">
                            <span class="material-icons">edit</span> 修改材料
                        </a>
                        {% elif current_tab == 'reimbursement' %}
                        <a href="{% url 'clubs:edit_rejected_review' item.club.id %}?type=reimbursement&request_id={{ item.id }}" 
                           class="action-btn primary" onclick="event.stopPropagation()">
                            <span class="material-icons">edit</span> 修改材料
                        </a>
                        {% elif current_tab == 'activity_application' %}
                        <a href="{% url 'clubs:edit_rejected_review' item.club.id %}?type=activity_application&request_id={{ item.id }}" 
                           class="action-btn primary" onclick="event.stopPropagation()">
                            <span class="material-icons">edit</span> 修改材料
                        </a>
                        {% elif current_tab == 'president_transition' %}
                        <a href="{% url 'clubs:edit_rejected_review' item.club.id %}?type=president_transition&request_id={{ item.id }}" 
                           class="action-btn primary" onclick="event.stopPropagation()">
                            <span class="material-icons">edit</span> 修改材料
                        </a>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">
                    <span class="material-icons">check_circle</span>
                </div>
                <h3>暂无活跃记录</h3>
                <p>当前没有待处理或已拒绝的申请</p>
            </div>
            {% endif %}
        </div>

        <!-- 已通过的记录（已通过） -->
        <div class="records-section">
            <div class="section-title">
                <span class="material-icons">done_all</span>
                <h3>已通过记录</h3>
                <span class="count">{{ completed_items|length }} 条记录</span>
            </div>
            
            {% if completed_items %}
            <div class="records-list">
                {% for item in completed_items|slice:":3" %}
                <div class="record-card" onclick="window.location.href='{% url "clubs:staff_review_detail" current_tab item.id %}';">
                    <div class="record-card-header">
                        {% if current_tab == 'annual_review' %}
                        <span class="club-name">{{ item.club.name }}</span>
                        {% elif current_tab == 'registration' %}
                        <span class="club-name">{{ item.club.name }}</span>
                        {% elif current_tab == 'application' %}
                        <span class="club-name">{{ item.club_name }}</span>
                        {% elif current_tab == 'reimbursement' %}
                        <span class="club-name">{{ item.club.name }}</span>
                        {% elif current_tab == 'activity_application' %}
                        <span class="club-name">{{ item.club.name }}</span>
                        {% elif current_tab == 'president_transition' %}
                        <span class="club-name">{{ item.club.name }}</span>
                        {% endif %}

                        {% if item.status == 'approved' or item.staff_approved == True %}
                        <span class="status-badge approved"><span class="material-icons">check_circle</span> 已通过</span>
                        {% elif item.status == 'rejected' or item.staff_approved == False %}
                        <span class="status-badge rejected"><span class="material-icons">cancel</span> 已拒绝</span>
                        {% endif %}
                    </div>

                    <div class="record-card-body">
                        {% if current_tab == 'annual_review' %}
                        <div class="record-field">
                            <span class="record-field-label">年份</span>
                            <span class="record-field-value">{{ item.submission_year }}</span>
                        </div>
                        <div class="record-field">
                            <span class="record-field-label">审核者</span>
                            {% if item.reviewer %}
                            <a href="{% url 'clubs:user_detail' item.reviewer.id %}" class="record-field-value" style="display: flex; align-items: center; text-decoration: none; color: inherit;">
                                <div style="width: 24px; height: 24px; border-radius: 50%; overflow: hidden; margin-right: 8px; flex-shrink: 0;">
                                    {% if item.reviewer.profile.avatar %}
                                        <img src="{{ item.reviewer.profile.avatar.url }}" alt="{{ item.reviewer.profile.get_full_name }}" style="width: 100%; height: 100%; object-fit: cover;">
                                    {% else %}
                                        <div style="width: 100%; height: 100%; background-color: var(--md3-secondary-container); color: var(--md3-on-secondary-container); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">
                                            {{ item.reviewer.profile.get_full_name|slice:":1"|default:item.reviewer.username|slice:":1" }}
                                        </div>
                                    {% endif %}
                                </div>
                                <span style="border-bottom: 1px dotted var(--md3-outline);">{{ item.reviewer.profile.get_full_name|default:item.reviewer.username }}</span>
                            </a>
                            {% else %}
                            <span class="record-field-value">系统管理员</span>
                            {% endif %}
                        </div>
                        <div class="record-field">
                            <span class="record-field-label">提交时间</span>
                            <span class="record-field-value">{{ item.submitted_at|date:"Y-m-d H:i" }}</span>
                        </div>
                        {% elif current_tab == 'registration' %}
                        <div class="record-field">
                            <span class="record-field-label">审核者</span>
                            {% if item.reviewer %}
                            <a href="{% url 'clubs:user_detail' item.reviewer.id %}" class="record-field-value" style="display: flex; align-items: center; text-decoration: none; color: inherit;">
                                <div style="width: 24px; height: 24px; border-radius: 50%; overflow: hidden; margin-right: 8px; flex-shrink: 0;">
                                    {% if item.reviewer.profile.avatar %}
                                        <img src="{{ item.reviewer.profile.avatar.url }}" alt="{{ item.reviewer.profile.get_full_name }}" style="width: 100%; height: 100%; object-fit: cover;">
                                    {% else %}
                                        <div style="width: 100%; height: 100%; background-color: var(--md3-secondary-container); color: var(--md3-on-secondary-container); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">
                                            {{ item.reviewer.profile.get_full_name|slice:":1"|default:item.reviewer.username|slice:":1" }}
                                        </div>
                                    {% endif %}
                                </div>
                                <span style="border-bottom: 1px dotted var(--md3-outline);">{{ item.reviewer.profile.get_full_name|default:item.reviewer.username }}</span>
                            </a>
                            {% else %}
                            <span class="record-field-value">系统管理员</span>
                            {% endif %}
                        </div>
                        <div class="record-field">
                            <span class="record-field-label">提交时间</span>
                            <span class="record-field-value">{{ item.submitted_at|date:"Y-m-d H:i" }}</span>
                        </div>
                        {% elif current_tab == 'application' %}
                        <div class="record-field">
                            <span class="record-field-label">申请人</span>
                            <a href="{% url 'clubs:user_detail' item.requested_by.id %}" class="record-field-value" style="display: flex; align-items: center; text-decoration: none; color: inherit;">
                                <div style="width: 24px; height: 24px; border-radius: 50%; overflow: hidden; margin-right: 8px; flex-shrink: 0;">
                                    {% if item.requested_by.profile.avatar %}
                                        <img src="{{ item.requested_by.profile.avatar.url }}" alt="{{ item.requested_by.get_full_name }}" style="width: 100%; height: 100%; object-fit: cover;">
                                    {% else %}
                                        <div style="width: 100%; height: 100%; background-color: var(--md3-primary-container); color: var(--md3-on-primary-container); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">
                                            {{ item.requested_by.profile.get_full_name|slice:":1"|default:item.requested_by.username|slice:":1" }}
                                        </div>
                                    {% endif %}
                                </div>
                                <span style="border-bottom: 1px dotted var(--md3-outline);">{{ item.requested_by.get_full_name|default:item.requested_by.username }}</span>
                            </a>
                        </div>
                        <div class="record-field">
                            <span class="record-field-label">审核者</span>
                            {% if item.reviewer %}
                            <a href="{% url 'clubs:user_detail' item.reviewer.id %}" class="record-field-value" style="display: flex; align-items: center; text-decoration: none; color: inherit;">
                                <div style="width: 24px; height: 24px; border-radius: 50%; overflow: hidden; margin-right: 8px; flex-shrink: 0;">
                                    {% if item.reviewer.profile.avatar %}
                                        <img src="{{ item.reviewer.profile.avatar.url }}" alt="{{ item.reviewer.profile.get_full_name }}" style="width: 100%; height: 100%; object-fit: cover;">
                                    {% else %}
                                        <div style="width: 100%; height: 100%; background-color: var(--md3-secondary-container); color: var(--md3-on-secondary-container); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">
                                            {{ item.reviewer.profile.get_full_name|slice:":1"|default:item.reviewer.username|slice:":1" }}
                                        </div>
                                    {% endif %}
                                </div>
                                <span style="border-bottom: 1px dotted var(--md3-outline);">{{ item.reviewer.profile.get_full_name|default:item.reviewer.username }}</span>
                            </a>
                            {% else %}
                            <span class="record-field-value">系统管理员</span>
                            {% endif %}
                        </div>
                        <div class="record-field">
                            <span class="record-field-label">提交时间</span>
                            <span class="record-field-value">{{ item.submitted_at|date:"Y-m-d H:i" }}</span>
                        </div>
                        {% elif current_tab == 'reimbursement' %}
                        <div class="record-field">
                            <span class="record-field-label">报销金额</span>
                            <span class="record-field-value" style="color: var(--md3-primary); font-weight: 600;">¥{{ item.reimbursement_amount|floatformat:2 }}</span>
                        </div>
                        <div class="record-field">
                            <span class="record-field-label">审核者</span>
                            {% with reviewer=item.get_final_reviewer %}
                                {% if reviewer %}
                                <a href="{% url 'clubs:user_detail' reviewer.id %}" class="record-field-value" style="display: flex; align-items: center; text-decoration: none; color: inherit;">
                                    <div style="width: 24px; height: 24px; border-radius: 50%; overflow: hidden; margin-right: 8px; flex-shrink: 0;">
                                        {% if reviewer.profile.avatar %}
                                            <img src="{{ reviewer.profile.avatar.url }}" alt="{{ reviewer.profile.get_full_name }}" style="width: 100%; height: 100%; object-fit: cover;">
                                        {% else %}
                                            <div style="width: 100%; height: 100%; background-color: var(--md3-secondary-container); color: var(--md3-on-secondary-container); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">
                                                {{ reviewer.profile.get_full_name|slice:":1"|default:reviewer.username|slice:":1" }}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <span style="border-bottom: 1px dotted var(--md3-outline);">{{ reviewer.profile.get_full_name|default:reviewer.username }}</span>
                                </a>
                                {% else %}
                                <span class="record-field-value">未知</span>
                                {% endif %}
                            {% endwith %}
                        </div>
                        <div class="record-field">
                            <span class="record-field-label">提交时间</span>
                            <span class="record-field-value">{{ item.submitted_at|date:"Y-m-d H:i" }}</span>
                        </div>
                        {% elif current_tab == 'activity_application' %}
                        <div class="record-field">
                            <span class="record-field-label">活动日期</span>
                            <span class="record-field-value">{{ item.activity_date|date:"Y-m-d" }}</span>
                        </div>
                        <div class="record-field">
                            <span class="record-field-label">审核者</span>
                            {% with reviewer=item.get_final_reviewer %}
                                {% if reviewer %}
                                <a href="{% url 'clubs:user_detail' reviewer.id %}" class="record-field-value" style="display: flex; align-items: center; text-decoration: none; color: inherit;">
                                    <div style="width: 24px; height: 24px; border-radius: 50%; overflow: hidden; margin-right: 8px; flex-shrink: 0;">
                                        {% if reviewer.profile.avatar %}
                                            <img src="{{ reviewer.profile.avatar.url }}" alt="{{ reviewer.profile.get_full_name }}" style="width: 100%; height: 100%; object-fit: cover;">
                                        {% else %}
                                            <div style="width: 100%; height: 100%; background-color: var(--md3-secondary-container); color: var(--md3-on-secondary-container); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">
                                                {{ reviewer.profile.get_full_name|slice:":1"|default:reviewer.username|slice:":1" }}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <span style="border-bottom: 1px dotted var(--md3-outline);">{{ reviewer.profile.get_full_name|default:reviewer.username }}</span>
                                </a>
                                {% else %}
                                <span class="record-field-value">未知</span>
                                {% endif %}
                            {% endwith %}
                        </div>
                        <div class="record-field">
                            <span class="record-field-label">提交时间</span>
                            <span class="record-field-value">{{ item.submitted_at|date:"Y-m-d H:i" }}</span>
                        </div>
                        {% elif current_tab == 'president_transition' %}
                        <div class="record-field">
                            <span class="record-field-label">新社长</span>
                            {% if item.new_president_officer and item.new_president_officer.user_profile %}
                            <a href="{% url 'clubs:user_detail' item.new_president_officer.user_profile.user.id %}" class="record-field-value" style="display: flex; align-items: center; text-decoration: none; color: inherit;">
                                <div style="width: 24px; height: 24px; border-radius: 50%; overflow: hidden; margin-right: 8px; flex-shrink: 0;">
                                    {% if item.new_president_officer.user_profile.avatar %}
                                        <img src="{{ item.new_president_officer.user_profile.avatar.url }}" alt="{{ item.new_president_officer.user_profile.get_full_name }}" style="width: 100%; height: 100%; object-fit: cover;">
                                    {% else %}
                                        <div style="width: 100%; height: 100%; background-color: var(--md3-primary-container); color: var(--md3-on-primary-container); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">
                                            {{ item.new_president_officer.user_profile.get_full_name|slice:":1"|default:item.new_president_officer.user_profile.user.username|slice:":1" }}
                                        </div>
                                    {% endif %}
                                </div>
                                <span style="border-bottom: 1px dotted var(--md3-outline);">{{ item.new_president_officer.user_profile.get_full_name }}</span>
                            </a>
                            {% else %}
                            <span class="record-field-value">{{ item.new_president_name|default:"未知" }}</span>
                            {% endif %}
                        </div>
                        <div class="record-field">
                            <span class="record-field-label">审核者</span>
                            {% with reviewer=item.get_final_reviewer %}
                                {% if reviewer %}
                                <a href="{% url 'clubs:user_detail' reviewer.id %}" class="record-field-value" style="display: flex; align-items: center; text-decoration: none; color: inherit;">
                                    <div style="width: 24px; height: 24px; border-radius: 50%; overflow: hidden; margin-right: 8px; flex-shrink: 0;">
                                        {% if reviewer.profile.avatar %}
                                            <img src="{{ reviewer.profile.avatar.url }}" alt="{{ reviewer.profile.get_full_name }}" style="width: 100%; height: 100%; object-fit: cover;">
                                        {% else %}
                                            <div style="width: 100%; height: 100%; background-color: var(--md3-secondary-container); color: var(--md3-on-secondary-container); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">
                                                {{ reviewer.profile.get_full_name|slice:":1"|default:reviewer.username|slice:":1" }}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <span style="border-bottom: 1px dotted var(--md3-outline);">{{ reviewer.profile.get_full_name|default:reviewer.username }}</span>
                                </a>
                                {% else %}
                                <span class="record-field-value">未知</span>
                                {% endif %}
                            {% endwith %}
                        </div>
                        <div class="record-field">
                            <span class="record-field-label">提交时间</span>
                            <span class="record-field-value">{{ item.submitted_at|date:"Y-m-d H:i" }}</span>
                        </div>
                        {% endif %}
                    </div>

                </div>
                {% endfor %}
            </div>
            
            {% if completed_items|length > 3 %}
            <div style="margin-top: var(--md3-spacing-lg); text-align: center;">
                <button onclick="openHistoryModal()" class="btn btn-secondary" style="border-radius: 20px; padding: 8px 24px;">
                    查看更多历史记录
                </button>
            </div>
            {% endif %}

            {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">
                    <span class="material-icons">inbox</span>
                </div>
                <h3>暂无已通过记录</h3>
                <p>还没有审批通过的申请</p>
            </div>
            {% endif %}
        </div>

    </div>

</div>

<!-- 历史记录弹窗 -->
<div id="historyModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h2><span class="material-icons" style="vertical-align: middle; margin-right: 8px;">history</span>全部已通过记录</h2>
            <button onclick="closeHistoryModal()" class="modal-close">
                <span class="material-icons">close</span>
            </button>
        </div>
        <div class="modal-body">
            <div class="records-list">
                {% for item in completed_items %}
                <div class="record-card" onclick="window.location.href='{% url "clubs:staff_review_detail" current_tab item.id %}';">
                    <div class="record-card-header">
                        {% if current_tab == 'annual_review' %}
                        <span class="club-name">{{ item.club.name }}</span>
                        {% elif current_tab == 'registration' %}
                        <span class="club-name">{{ item.club.name }}</span>
                        {% elif current_tab == 'application' %}
                        <span class="club-name">{{ item.club_name }}</span>
                        {% elif current_tab == 'reimbursement' %}
                        <span class="club-name">{{ item.club.name }}</span>
                        {% elif current_tab == 'activity_application' %}
                        <span class="club-name">{{ item.club.name }}</span>
                        {% elif current_tab == 'president_transition' %}
                        <span class="club-name">{{ item.club.name }}</span>
                        {% endif %}

                        {% if item.status == 'approved' or item.staff_approved == True %}
                        <span class="status-badge approved"><span class="material-icons">check_circle</span> 已通过</span>
                        {% elif item.status == 'rejected' or item.staff_approved == False %}
                        <span class="status-badge rejected"><span class="material-icons">cancel</span> 已拒绝</span>
                        {% endif %}
                    </div>

                    <div class="record-card-body">
                        {% if current_tab == 'annual_review' %}
                        <div class="record-field">
                            <span class="record-field-label">年份</span>
                            <span class="record-field-value">{{ item.submission_year }}</span>
                        </div>
                        <div class="record-field">
                            <span class="record-field-label">审核者</span>
                            {% with reviewer=item.get_final_reviewer %}
                                {% if reviewer %}
                                <a href="{% url 'clubs:user_detail' reviewer.id %}" class="record-field-value" style="display: flex; align-items: center; text-decoration: none; color: inherit;">
                                    <div style="width: 24px; height: 24px; border-radius: 50%; overflow: hidden; margin-right: 8px; flex-shrink: 0;">
                                        {% if reviewer.profile.avatar %}
                                            <img src="{{ reviewer.profile.avatar.url }}" alt="{{ reviewer.profile.get_full_name }}" style="width: 100%; height: 100%; object-fit: cover;">
                                        {% else %}
                                            <div style="width: 100%; height: 100%; background-color: var(--md3-secondary-container); color: var(--md3-on-secondary-container); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">
                                                {{ reviewer.profile.get_full_name|slice:":1"|default:reviewer.username|slice:":1" }}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <span style="border-bottom: 1px dotted var(--md3-outline);">{{ reviewer.profile.get_full_name|default:reviewer.username }}</span>
                                </a>
                                {% else %}
                                <span class="record-field-value">未知</span>
                                {% endif %}
                            {% endwith %}
                        </div>
                        <div class="record-field">
                            <span class="record-field-label">提交时间</span>
                            <span class="record-field-value">{{ item.submitted_at|date:"Y-m-d H:i" }}</span>
                        </div>
                        {% elif current_tab == 'registration' %}
                        <div class="record-field">
                            <span class="record-field-label">注册周期</span>
                            <span class="record-field-value">{% if item.registration_period %}{{ item.registration_period }}{% else %}未设置{% endif %}</span>
                        </div>
                        <div class="record-field">
                            <span class="record-field-label">审核者</span>
                            {% with reviewer=item.get_final_reviewer %}
                                {% if reviewer %}
                                <a href="{% url 'clubs:user_detail' reviewer.id %}" class="record-field-value" style="display: flex; align-items: center; text-decoration: none; color: inherit;">
                                    <div style="width: 24px; height: 24px; border-radius: 50%; overflow: hidden; margin-right: 8px; flex-shrink: 0;">
                                        {% if reviewer.profile.avatar %}
                                            <img src="{{ reviewer.profile.avatar.url }}" alt="{{ reviewer.profile.get_full_name }}" style="width: 100%; height: 100%; object-fit: cover;">
                                        {% else %}
                                            <div style="width: 100%; height: 100%; background-color: var(--md3-secondary-container); color: var(--md3-on-secondary-container); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">
                                                {{ reviewer.profile.get_full_name|slice:":1"|default:reviewer.username|slice:":1" }}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <span style="border-bottom: 1px dotted var(--md3-outline);">{{ reviewer.profile.get_full_name|default:reviewer.username }}</span>
                                </a>
                                {% else %}
                                <span class="record-field-value">未知</span>
                                {% endif %}
                            {% endwith %}
                        </div>
                        <div class="record-field">
                            <span class="record-field-label">提交时间</span>
                            <span class="record-field-value">{{ item.submitted_at|date:"Y-m-d H:i" }}</span>
                        </div>
                        {% elif current_tab == 'application' %}
                        <div class="record-field">
                            <span class="record-field-label">申请人</span>
                            <a href="{% url 'clubs:user_detail' item.requested_by.id %}" class="record-field-value" style="display: flex; align-items: center; text-decoration: none; color: inherit;">
                                <div style="width: 24px; height: 24px; border-radius: 50%; overflow: hidden; margin-right: 8px; flex-shrink: 0;">
                                    {% if item.requested_by.profile.avatar %}
                                        <img src="{{ item.requested_by.profile.avatar.url }}" alt="{{ item.requested_by.get_full_name }}" style="width: 100%; height: 100%; object-fit: cover;">
                                    {% else %}
                                        <div style="width: 100%; height: 100%; background-color: var(--md3-primary-container); color: var(--md3-on-primary-container); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">
                                            {{ item.requested_by.profile.get_full_name|slice:":1"|default:item.requested_by.username|slice:":1" }}
                                        </div>
                                    {% endif %}
                                </div>
                                <span style="border-bottom: 1px dotted var(--md3-outline);">{{ item.requested_by.get_full_name|default:item.requested_by.username }}</span>
                            </a>
                        </div>
                        <div class="record-field">
                            <span class="record-field-label">审核者</span>
                            {% with reviewer=item.get_final_reviewer %}
                                {% if reviewer %}
                                <a href="{% url 'clubs:user_detail' reviewer.id %}" class="record-field-value" style="display: flex; align-items: center; text-decoration: none; color: inherit;">
                                    <div style="width: 24px; height: 24px; border-radius: 50%; overflow: hidden; margin-right: 8px; flex-shrink: 0;">
                                        {% if reviewer.profile.avatar %}
                                            <img src="{{ reviewer.profile.avatar.url }}" alt="{{ reviewer.profile.get_full_name }}" style="width: 100%; height: 100%; object-fit: cover;">
                                        {% else %}
                                            <div style="width: 100%; height: 100%; background-color: var(--md3-secondary-container); color: var(--md3-on-secondary-container); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">
                                                {{ reviewer.profile.get_full_name|slice:":1"|default:reviewer.username|slice:":1" }}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <span style="border-bottom: 1px dotted var(--md3-outline);">{{ reviewer.profile.get_full_name|default:reviewer.username }}</span>
                                </a>
                                {% else %}
                                <span class="record-field-value">未知</span>
                                {% endif %}
                            {% endwith %}
                        </div>
                        <div class="record-field">
                            <span class="record-field-label">提交时间</span>
                            <span class="record-field-value">{{ item.submitted_at|date:"Y-m-d H:i" }}</span>
                        </div>
                        {% elif current_tab == 'president_transition' %}
                        <div class="record-field">
                            <span class="record-field-label">新社长</span>
                            {% if item.new_president_officer and item.new_president_officer.user_profile %}
                            <a href="{% url 'clubs:user_detail' item.new_president_officer.user_profile.user.id %}" class="record-field-value" style="display: flex; align-items: center; text-decoration: none; color: inherit;">
                                <div style="width: 24px; height: 24px; border-radius: 50%; overflow: hidden; margin-right: 8px; flex-shrink: 0;">
                                    {% if item.new_president_officer.user_profile.avatar %}
                                        <img src="{{ item.new_president_officer.user_profile.avatar.url }}" alt="{{ item.new_president_officer.user_profile.get_full_name }}" style="width: 100%; height: 100%; object-fit: cover;">
                                    {% else %}
                                        <div style="width: 100%; height: 100%; background-color: var(--md3-primary-container); color: var(--md3-on-primary-container); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">
                                            {{ item.new_president_officer.user_profile.get_full_name|slice:":1"|default:item.new_president_officer.user_profile.user.username|slice:":1" }}
                                        </div>
                                    {% endif %}
                                </div>
                                <span style="border-bottom: 1px dotted var(--md3-outline);">{{ item.new_president_officer.user_profile.get_full_name }}</span>
                            </a>
                            {% else %}
                            <span class="record-field-value">{{ item.new_president_name|default:"未知" }}</span>
                            {% endif %}
                        </div>
                        <div class="record-field">
                            <span class="record-field-label">审核者</span>
                            {% with reviewer=item.get_final_reviewer %}
                                {% if reviewer %}
                                <a href="{% url 'clubs:user_detail' reviewer.id %}" class="record-field-value" style="display: flex; align-items: center; text-decoration: none; color: inherit;">
                                    <div style="width: 24px; height: 24px; border-radius: 50%; overflow: hidden; margin-right: 8px; flex-shrink: 0;">
                                        {% if reviewer.profile.avatar %}
                                            <img src="{{ reviewer.profile.avatar.url }}" alt="{{ reviewer.profile.get_full_name }}" style="width: 100%; height: 100%; object-fit: cover;">
                                        {% else %}
                                            <div style="width: 100%; height: 100%; background-color: var(--md3-secondary-container); color: var(--md3-on-secondary-container); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">
                                                {{ reviewer.profile.get_full_name|slice:":1"|default:reviewer.username|slice:":1" }}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <span style="border-bottom: 1px dotted var(--md3-outline);">{{ reviewer.profile.get_full_name|default:reviewer.username }}</span>
                                </a>
                                {% else %}
                                <span class="record-field-value">未知</span>
                                {% endif %}
                            {% endwith %}
                        </div>
                        <div class="record-field">
                            <span class="record-field-label">提交时间</span>
                            <span class="record-field-value">{{ item.submitted_at|date:"Y-m-d H:i" }}</span>
                        </div>
                        {% elif current_tab == 'reimbursement' %}
                        <div class="record-field">
                            <span class="record-field-label">报销金额</span>
                            <span class="record-field-value" style="color: var(--md3-primary); font-weight: 600;">¥{{ item.reimbursement_amount|floatformat:2 }}</span>
                        </div>
                        <div class="record-field">
                            <span class="record-field-label">审核者</span>
                            {% with reviewer=item.get_final_reviewer %}
                                {% if reviewer %}
                                <a href="{% url 'clubs:user_detail' reviewer.id %}" class="record-field-value" style="display: flex; align-items: center; text-decoration: none; color: inherit;">
                                    <div style="width: 24px; height: 24px; border-radius: 50%; overflow: hidden; margin-right: 8px; flex-shrink: 0;">
                                        {% if reviewer.profile.avatar %}
                                            <img src="{{ reviewer.profile.avatar.url }}" alt="{{ reviewer.profile.get_full_name }}" style="width: 100%; height: 100%; object-fit: cover;">
                                        {% else %}
                                            <div style="width: 100%; height: 100%; background-color: var(--md3-secondary-container); color: var(--md3-on-secondary-container); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">
                                                {{ reviewer.profile.get_full_name|slice:":1"|default:reviewer.username|slice:":1" }}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <span style="border-bottom: 1px dotted var(--md3-outline);">{{ reviewer.profile.get_full_name|default:reviewer.username }}</span>
                                </a>
                                {% else %}
                                <span class="record-field-value">未知</span>
                                {% endif %}
                            {% endwith %}
                        </div>
                        <div class="record-field">
                            <span class="record-field-label">提交时间</span>
                            <span class="record-field-value">{{ item.submitted_at|date:"Y-m-d H:i" }}</span>
                        </div>
                        {% elif current_tab == 'activity_application' %}
                        <div class="record-field">
                            <span class="record-field-label">活动日期</span>
                            <span class="record-field-value">{{ item.activity_date|date:"Y-m-d" }}</span>
                        </div>
                        <div class="record-field">
                            <span class="record-field-label">审核者</span>
                            {% with reviewer=item.get_final_reviewer %}
                                {% if reviewer %}
                                <a href="{% url 'clubs:user_detail' reviewer.id %}" class="record-field-value" style="display: flex; align-items: center; text-decoration: none; color: inherit;">
                                    <div style="width: 24px; height: 24px; border-radius: 50%; overflow: hidden; margin-right: 8px; flex-shrink: 0;">
                                        {% if reviewer.profile.avatar %}
                                            <img src="{{ reviewer.profile.avatar.url }}" alt="{{ reviewer.profile.get_full_name }}" style="width: 100%; height: 100%; object-fit: cover;">
                                        {% else %}
                                            <div style="width: 100%; height: 100%; background-color: var(--md3-secondary-container); color: var(--md3-on-secondary-container); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">
                                                {{ reviewer.profile.get_full_name|slice:":1"|default:reviewer.username|slice:":1" }}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <span style="border-bottom: 1px dotted var(--md3-outline);">{{ reviewer.profile.get_full_name|default:reviewer.username }}</span>
                                </a>
                                {% else %}
                                <span class="record-field-value">未知</span>
                                {% endif %}
                            {% endwith %}
                        </div>
                        <div class="record-field">
                            <span class="record-field-label">提交时间</span>
                            <span class="record-field-value">{{ item.submitted_at|date:"Y-m-d H:i" }}</span>
                        </div>
                        {% else %}
                        <div class="record-field">
                            <span class="record-field-label">提交时间</span>
                            <span class="record-field-value">{{ item.submitted_at|date:"Y-m-d H:i" }}</span>
                        </div>
                        {% endif %}
                    </div>

                </div>
                {% endfor %}
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="closeHistoryModal()" class="btn btn-secondary">关闭</button>
        </div>
    </div>
</div>

<script>
    function openHistoryModal() {
        document.getElementById('historyModal').style.display = 'flex';
    }

    function closeHistoryModal() {
        document.getElementById('historyModal').style.display = 'none';
    }

    // 点击遮罩层关闭
    document.getElementById('historyModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeHistoryModal();
        }
    });
</script>
{% endblock %}
